<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSYlanguages</title>
    <link rel="stylesheet" href="src/css/styles.css">
    <link rel="stylesheet" href="src/css/vocabulary.css">
    </script>
</head>
<body>
    <div class="container">
        <h1>COSYlanguages</h1>
        
        <div class="menu-section">
            <label for="language">🌎 Choose Your Language:</label>
            <select id="language">
                <option value="">Language</option>
                <option value="COSYenglish" data-bg="COSYenglish">COSYenglish</option>
                <option value="COSYfrançais" data-bg="COSYfrançais">COSYfrançais</option>
                <option value="COSYitaliano" data-bg="COSYitaliano">COSYitaliano</option>
                <option value="COSYespañol" data-bg="COSYespañol">COSYespañol</option>
                <option value="COSYportuguês" data-bg="COSYportuguês">COSYportuguês</option>
                <option value="COSYdeutsch" data-bg="COSYdeutsch">COSYdeutsch</option>
                <option value="ΚΟΖΥελληνικά" data-bg="ΚΟΖΥελληνικά">ΚΟΖΥελληνικά</option>
                <option value="ТАКОЙрусский" data-bg="ТАКОЙрусский">ТАКОЙрусский</option>
                <option value="ԾՈՍՅհայկական" data-bg="ԾՈՍՅհայկական">ԾՈՍՅհայկական</option>
                <option value="COSYbrezhoneg" data-bg="COSYbrezhoneg">COSYbrezhoneg</option>
                <option value="COSYtatarça" data-bg="COSYtatarça">COSYtatarça</option>
                <option value="COSYbashkort" data-bg="COSYbashkort">COSYbashkort</option>
            </select>
        </div>
        
        <div class="menu-section">
            <label for="day">📅 Choose Your Day:</label>
            <select id="day">
                <option value="">Day</option>
                <!-- Days will be populated by JavaScript -->
            </select>
            
            <div class="day-range">
                <div>
                    <label for="day-from">Day From:</label>
                    <select id="day-from">
                        <option value="">From</option>
                    </select>
                </div>
                <div>
                    <label for="day-to">Day To:</label>
                    <select id="day-to">
                        <option value="">To</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="menu-section">
            <label>🧭 Choose Your Practice:</label>
            <div class="practice-types">
                <button id="vocabulary-btn" class="btn-primary">🔠 Vocabulary</button>
                <button id="grammar-btn" class="btn-primary">🧩 Grammar</button>
                <button id="reading-btn" class="btn-primary">📚 Reading</button>
                <button id="speaking-btn" class="btn-primary">🗣️ Speaking</button>
                <button id="writing-btn" class="btn-primary">✍️ Writing</button>
                <button id="practice-all-btn" class="btn-primary">🔄 Practice All</button>
            </div>
            
            <div id="vocabulary-options" class="practice-options">
                <div class="vocabulary-options">
                    <button id="daily-word-btn" class="btn-secondary">✨ Daily Word</button>
                    <button id="random-word-btn" class="btn-secondary">🔤 Random Word</button>
                    <button id="random-image-btn" class="btn-secondary">🖼️ Random Image</button>
                    <button id="listening-btn" class="btn-secondary">🎧 Listening</button>
                    <button id="practice-all-vocab-btn" class="btn-secondary">🔄 Practice All</button>
                </div>
            </div>
            
            <div id="grammar-options" class="practice-options">
                <div class="grammar-options">
                    <!-- Grammar buttons will be populated by JavaScript -->
                    <button id="daily-grammar-btn" class="btn-secondary">✨ Daily Grammar</button>
                    <button id="practice-all-grammar-btn" class="btn-secondary">🔄 Practice All</button>
                </div>
            </div>

            <div id="reading-options" class="practice-options">
                <div class="reading-options">
                    <button id="daily-reading-btn" class="btn-secondary">✨ Daily Reading</button>
                    <button id="story-btn" class="btn-secondary">📖 Story</button>
                    <button id="interesting-fact-btn" class="btn-secondary">🔄 Interesting facts</button>
                </div>
            </div>
            
            <div id="speaking-options" class="practice-options">
                <div class="speaking-options">
                <button id="daily-speaking-btn" class="btn-secondary">✨ Daily Speaking</button>
                <button id="question-practice-btn" class="btn-secondary">❓ Question</button>
                <button id="monologue-translate-btn" class="btn-secondary">💬 Monologue</button>
                <button id="role-play-btn" class="btn-secondary">🎭 Role Play</button>
                <button id="practice-all-speaking-btn" class="btn-secondary">🔄 Practice All</button>
                </div>
            </div>

            <div id="writing-options" class="practice-options">
                <div class="writing-options">
                <button id="daily-writing-btn" class="btn-secondary">✨ Daily writing</button>
                <button id="question-btn" class="btn-secondary">❓ Question</button>
                <button id="storytelling-btn" class="btn-secondary">📜 Storytelling</button>
                <button id="diary-btn" class="btn-secondary">📔 Diary</button>
                </div>
            </div>  
        </div>
        
        <div id="result" class="result-area flex-center"></div>
    </div>

    <!-- Floating Help Button -->
    <button id="floating-help-btn" title="Help / Fun Fact / Tip">❓</button>
    <!-- Floating Fun Fact / Tip Popup -->    <div id="floating-tip-popup">
      <span id="floating-tip-text"></span>
      <button class="close-tip" title="Close">✖</button>
      <button class="translate-tip" title="Translate">🌍</button>
    </div>
    <!-- Translation Popup -->    <div id="translation-popup">
      <span id="translation-popup-text"></span>
      <button class="close-translation" title="Close">✖</button>
    </div>

    <script>
        // Populate days dropdown (1-30)
        const daySelect = document.getElementById('day');
        const dayFromSelect = document.getElementById('day-from');
        const dayToSelect = document.getElementById('day-to');
        
        for (let i = 1; i <= 30; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Day ${i}`;
            daySelect.appendChild(option.cloneNode(true));
            dayFromSelect.appendChild(option.cloneNode(true));
            dayToSelect.appendChild(option.cloneNode(true));
        }
        
        // Practice type buttons
        const vocabularyBtn = document.getElementById('vocabulary-btn');
        const grammarBtn = document.getElementById('grammar-btn');
        const readingBtn = document.getElementById('reading-btn');
        const speakingBtn = document.getElementById('speaking-btn');
        const writingBtn = document.getElementById('writing-btn');
        
        const vocabularyOptions = document.getElementById('vocabulary-options');
        const grammarOptions = document.getElementById('grammar-options');
        const grammarOptionsContainer = grammarOptions.querySelector('.grammar-options');
        const readingOptions = document.getElementById('reading-options');
        const speakingOptions = document.getElementById('speaking-options');
        const writingOptions = document.getElementById('writing-options');
        
        // Hide all options initially
        vocabularyOptions.style.display = 'none';
        grammarOptions.style.display = 'none';
        speakingOptions.style.display = 'none';
        writingOptions.style.display = 'none';
        // Show Practice All button on load
        const practiceAllBtn = document.getElementById('practice-all-btn');
        practiceAllBtn.style.display = 'block';


        // Helper: show/hide main practice type buttons
        function hideOtherMainPracticeTypes(selectedId) {
        ['vocabulary-btn', 'grammar-btn', 'speaking-btn', 'reading-btn', 'writing-btn', 'practice-all-btn'].forEach(id => {
            if (id !== selectedId) {
                document.getElementById(id).style.display = 'none';
            } else {
                document.getElementById(id).classList.add('active-main-btn');
            }
        });
        }
        function showAllMainPracticeTypes() {
         ['vocabulary-btn', 'grammar-btn', 'speaking-btn', 'reading-btn', 'writing-btn', 'practice-all-btn'].forEach(id => {
            document.getElementById(id).style.display = 'inline-block';
            document.getElementById(id).classList.remove('active-main-btn');
            });
        }

        // --- Hide other options when one is selected ---
        function hideOtherVocabularyOptions(selectedId) {
            document.querySelectorAll('#vocabulary-options button').forEach(btn => {
                if (btn.id !== selectedId) btn.style.display = 'none';
            });
        }
        function showAllVocabularyOptions() {
            document.querySelectorAll('#vocabulary-options button').forEach(btn => {
                btn.style.display = '';
            });
        }
        function hideOtherGrammarOptions(selectedId) {
            document.querySelectorAll('#grammar-options button').forEach(btn => {
                if (btn.id !== selectedId) btn.style.display = 'none';
            });
        }
        function showAllGrammarOptions() {
            document.querySelectorAll('#grammar-options button').forEach(btn => {
                btn.style.display = '';
            });
        }
        function hideOtherReadingOptions(selectedId) {
            document.querySelectorAll('#reading-options button').forEach(btn => {
                if (btn.id !== selectedId) btn.style.display = 'none';
            });
        }
        function showAllReadingOptions() {
            document.querySelectorAll('#reading-options button').forEach(btn => {
                btn.style.display = '';
            });
        }
        function hideOtherSpeakingOptions(selectedId) {
            document.querySelectorAll('#speaking-options button').forEach(btn => {
                if (btn.id !== selectedId) btn.style.display = 'none';
            });
        }
        function showAllSpeakingOptions() {
            document.querySelectorAll('#speaking-options button').forEach(btn => {
                btn.style.display = '';
            });
        }
        function hideOtherWritingOptions(selectedId) {
            document.querySelectorAll('#writing-options button').forEach(btn => {
                if (btn.id !== selectedId) btn.style.display = 'none';
            });
        }
        function showAllWritingOptions() {
            document.querySelectorAll('#writing-options button').forEach(btn => {
                btn.style.display = '';
            });
        }

        // Helper: go back to main menu
        function goBackToMainMenu() {
            showAllMainPracticeTypes();
            showAllVocabularyOptions && showAllVocabularyOptions();
            showAllGrammarOptions && showAllGrammarOptions();
            showAllReadingOptions && showAllReadingOptions();
            showAllSpeakingOptions && showAllSpeakingOptions();
            showAllWritingOptions && showAllWritingOptions();
            if (vocabularyOptions) vocabularyOptions.style.display = 'none';
            if (grammarOptions) grammarOptions.style.display = 'none';
            if (readingOptions) readingOptions.style.display = 'none';
            if (speakingOptions) speakingOptions.style.display = 'none';
            if (writingOptions) writingOptions.style.display = 'none';
            if (practiceAllBtn) practiceAllBtn.style.display = 'block';
            if (document.getElementById('result')) document.getElementById('result').innerHTML = '';
            showPracticeAllButtons();
        }

        // On page load, always restore main menu and update grammar options if grammar is visible
        window.addEventListener('DOMContentLoaded', function() {
            goBackToMainMenu();
            // If grammar options are visible, update them
            if (grammarOptions && grammarOptions.style.display === 'block') {
                updateGrammarOptions();
            }
        });

        // --- Toggle logic for main practice type buttons ---
        function toggleMainPracticeType(selectedId) {
            const btn = document.getElementById(selectedId);
            const isActive = btn.classList.contains('active-main-btn');
            if (isActive) {
                // Restore all if already active
                showAllMainPracticeTypes();
                showAllVocabularyOptions();
                showAllGrammarOptions();
                showAllReadingOptions ();
                showAllSpeakingOptions ();
                showAllWritingOptions ();
                vocabularyOptions.style.display = 'none';
                grammarOptions.style.display = 'none';
                readingOptions.style.display = 'none';
                speakingOptions.style.display = 'none';
                writingOptions.style.display = 'none';
                practiceAllBtn.style.display = 'block';
                document.getElementById('result').innerHTML = '';
            } else {
                hideOtherMainPracticeTypes(selectedId);
                // Show the relevant options
                if (selectedId === 'vocabulary-btn') {
                    vocabularyOptions.style.display = 'block';
                    grammarOptions.style.display = 'none';
                    readingOptions.style.display = 'none';
                    speakingOptions.style.display = 'none';
                    writingOptions.style.display = 'none';
                } else if (selectedId === 'grammar-btn') {
                    grammarOptions.style.display = 'block';
                    vocabularyOptions.style.display = 'none';
                    readingOptions.style.display = 'none';
                    speakingOptions.style.display = 'none';
                    writingOptions.style.display = 'none';
                } else if (selectedId === 'reading-btn') {
                    readingOptions.style.display = 'block';
                    vocabularyOptions.style.display = 'none';
                    grammarOptions.style.display = 'none';
                    speakingOptions.style.display = 'none';
                    writingOptions.style.display = 'none';
                } else if (selectedId === 'speaking-btn') {
                    speakingOptions.style.display = 'block';
                    vocabularyOptions.style.display = 'none';
                    grammarOptions.style.display = 'none';
                    readingOptions.style.display = 'none';
                    writingOptions.style.display = 'none';
                } else if (selectedId === 'writing-btn') {
                    writingOptions.style.display = 'block';
                    vocabularyOptions.style.display = 'none';
                    grammarOptions.style.display = 'none';
                    readingOptions.style.display = 'none';
                    speakingOptions.style.display = 'none';
                }
                practiceAllBtn.style.display = 'none'; // Hide Practice All when any variant is chosen
                document.getElementById('result').innerHTML = '';
            }
        }
        
        // Update grammar options based on selected day or range
        function updateGrammarOptions() {
            const lang = document.getElementById('language').value;
            const t = translations[lang] || translations['COSYenglish'];
            const days = getSelectedDays();
            grammarOptionsContainer.innerHTML = '';
            if (!days.length) {
                const noDayMsg = document.createElement('p');
                noDayMsg.textContent = t.selectDay;
                grammarOptionsContainer.appendChild(noDayMsg);
                return;
            }
            // Use the first day in the range to determine which grammar options to show
            const day = parseInt(days[0]);
            // Helper for toggle logic
            function hideOtherGrammarOptionBtns(selectedBtn) {
                const btns = grammarOptionsContainer.querySelectorAll('.grammar-option-btn');
                btns.forEach(btn => {
                    if (btn !== selectedBtn) {
                        btn.style.display = 'none';
                    } else {
                        btn.classList.add('active-grammar-btn');
                    }
                });
            }
            function showAllGrammarOptionBtns() {
                const btns = grammarOptionsContainer.querySelectorAll('.grammar-option-btn');
                btns.forEach(btn => {
                    btn.style.display = 'inline-block';
                    btn.classList.remove('active-grammar-btn');
                });
            }
            function makeToggleHandler(btn) {
                return function() {
                    const isActive = btn.classList.contains('active-grammar-btn');
                    if (isActive) {
                        showAllGrammarOptionBtns();
                        document.getElementById('result').innerHTML = '';
                    } else {
                        hideOtherGrammarOptionBtns(btn);
                        document.getElementById('result').innerHTML = '';
                        // Auto-start practice for this grammar type
                        const type = btn.textContent.trim().toLowerCase();
                        if (type.includes('gender')) practiceGrammar('gender');
                        else if (type.includes('verb')) practiceGrammar('verbs');
                        else if (type.includes('adjective')) practiceGrammar('adjectives');
                        else if (type.includes('plural')) practiceGrammar('plurals');
                    }
                };
            }
            // Fix: For day 3, ONLY show gender, verbs, possessives (no duplicates)
            if (day === 3) {
                const genderBtn = document.createElement('button');
                genderBtn.textContent = t.gender;
                genderBtn.className = 'btn-secondary btn-small grammar-option-btn';
                genderBtn.onclick = function() {
                    hideOtherGrammarOptionBtns(genderBtn);
                    document.getElementById('result').innerHTML = '';
                    practiceGrammar('gender');
                };
                grammarOptionsContainer.appendChild(genderBtn);
                const verbBtn = document.createElement('button');
                verbBtn.textContent = t.verbs;
                verbBtn.className = 'btn-secondary btn-small grammar-option-btn';
                verbBtn.onclick = function() {
                    hideOtherGrammarOptionBtns(verbBtn);
                    document.getElementById('result').innerHTML = '';
                    practiceGrammar('verbs');
                };
                grammarOptionsContainer.appendChild(verbBtn);
                const possBtn = document.createElement('button');
                possBtn.textContent = t.possessives;
                possBtn.className = 'btn-secondary btn-small grammar-option-btn';
                possBtn.onclick = function() {
                    hideOtherGrammarOptionBtns(possBtn);
                    document.getElementById('result').innerHTML = '';
                    practiceGrammar('possessives');
                };
                grammarOptionsContainer.appendChild(possBtn);
                return;
            }
            // In updateGrammarOptions, always show gender button for day 1+ for all languages
            if (day >= 1) {
                const genderBtn = document.createElement('button');
                genderBtn.textContent = t.gender;
                genderBtn.className = 'btn-secondary grammar-option-btn';
                genderBtn.onclick = function() {
                    // Start gender practice on single click
                    hideOtherGrammarOptionBtns(genderBtn);
                    document.getElementById('result').innerHTML = '';
                    practiceGrammar('gender');
                };
                grammarOptionsContainer.appendChild(genderBtn);
            }
            if (day >= 2) {
                const verbBtn = document.createElement('button');
                verbBtn.textContent = t.verbs;
                verbBtn.className = 'btn-secondary grammar-option-btn';
                verbBtn.onclick = function() {
                    // Start verb practice on single click
                    hideOtherGrammarOptionBtns(verbBtn);
                    document.getElementById('result').innerHTML = '';
                    practiceGrammar('verbs');
                };
                grammarOptionsContainer.appendChild(verbBtn);
            }
            if (day >= 5) {
                const pastBtn = document.createElement('button');
                pastBtn.textContent = t.pastTense;
                pastBtn.className = 'btn-secondary grammar-option-btn';
                pastBtn.onclick = makeToggleHandler(pastBtn);
                grammarOptionsContainer.appendChild(pastBtn);
            }
            if (day >= 7) {
                const futureBtn = document.createElement('button');
                futureBtn.textContent = t.futureTense;
                futureBtn.className = 'btn-secondary grammar-option-btn';
                futureBtn.onclick = makeToggleHandler(futureBtn);
                grammarOptionsContainer.appendChild(futureBtn);
            }
        }
        
        // Update grammar options when day changes
        daySelect.addEventListener('change', function() {
            if (grammarOptions.style.display === 'block') {
                updateGrammarOptions();
            }
        });
        
        // Update day, day-from, and day-to event listeners to update grammar options
        ['day', 'day-from', 'day-to'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('change', function() {
                    if (grammarOptions.style.display === 'block') {
                        updateGrammarOptions();
                    }
                });
            }
        });
        
        // Helper: map language select value to vocabulary file
        function getVocabularyFile(language) {
            switch(language) {
                case 'COSYenglish': return 'data/vocabulary/words/vocabulary_english.json';
                case 'COSYfrançais': return 'data/vocabulary/words/vocabulary_french.json';
                case 'COSYespañol': return 'data/vocabulary/words/vocabulary_spanish.json';
                case 'COSYitaliano': return 'data/vocabulary/words/vocabulary_italian.json';
                case 'COSYdeutsch': return 'data/vocabulary/words/vocabulary_german.json';
                case 'COSYportuguês': return 'data/vocabulary/words/vocabulary_portuguese.json';
                case 'ТАКОЙрусский': return 'data/vocabulary/words/vocabulary_russian.json';
                case 'COSYbrezhoneg': return 'data/vocabulary/words/vocabulary_breton.json';
                case 'COSYtatarça': return 'data/vocabulary/words/vocabulary_tatar.json';
                case 'COSYbashkort': return 'data/vocabulary/words/vocabulary_bashkir.json';
                case 'ԾՈՍՅհայկական': return 'data/vocabulary/words/vocabulary_armenian.json';
                case 'ΚΟΖΥελληνικά': return 'data/vocabulary/words/vocabulary_greek.json';
                default: return null;
            }
        }

        // New: Load vocabulary for selected language and day
        async function loadVocabulary(language, day) {
            const file = getVocabularyFile(language);
            if (!file) return [];
            try {
                const response = await fetch(file);
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // Load random image data for a given language and day
        async function loadImageVocabulary(language, day) {
            try {
                const response = await fetch('data/vocabulary/images/vocabulary_images.json');
                if (!response.ok) return [];
                const data = await response.json();
                // Only return images that have a translation for the selected language
                return (data[day] || []).filter(item => item.translations && item.translations[language]);
            } catch (e) {
                return [];
            }
        }

        // --- Pronunciation: play word using SpeechSynthesis API, with mobile support and robust voice selection ---
        function pronounceWord(word, language) {
            // Map to standard BCP-47 codes
            let langCode = 'en-GB';
            switch(language) {
                case 'COSYenglish': langCode = 'en-GB'; break;
                case 'COSYfrançais': langCode = 'fr-FR'; break;
                case 'COSYespañol': langCode = 'es-ES'; break;
                case 'COSYitaliano': langCode = 'it-IT'; break;
                case 'COSYdeutsch': langCode = 'de-DE'; break;
                case 'COSYportuguês': langCode = 'pt-PT'; break;
                case 'ТАКОЙрусский': langCode = 'ru-RU'; break;
                case 'COSYbrezhoneg': langCode = 'br-FR'; break; // Breton, fallback to French
                case 'COSYtatarça': langCode = 'tt-RU'; break; // Tatar, fallback to Russian
                case 'COSYbashkort': langCode = 'ba-RU'; break; // Bashkir, fallback to Russian
                case 'ԾՈՍՅհայկական': langCode = 'hy-AM'; break; // Armenian
                case 'ΚΟΖΥελληνικά': langCode = 'el-GR'; break; // Greek
                default: langCode = 'en-GB';
            }
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                setTimeout(() => {
                    const utter = new SpeechSynthesisUtterance(word);
                    utter.lang = langCode;
                    utter.rate = 1;
                    utter.pitch = 1;
                    // Try to select a matching voice (prefer exact match, then partial, then fallback)
                    const voices = window.speechSynthesis.getVoices();
                    let match = null;
                    if (voices && voices.length) {
                        match = voices.find(v => v.lang === langCode);
                        if (!match) {
                            // Try partial match (e.g., 'el' for Greek)
                            const base = langCode.split('-')[0];
                            match = voices.find(v => v.lang.startsWith(base));
                        }
                        if (!match) match = voices[0]; // fallback
                        utter.voice = match;
                    }
                    window.speechSynthesis.speak(utter);
                }, 200); // Slightly longer delay for mobile
            } else {
                alert('Sorry, speech synthesis is not supported on this device/browser.');
            }
        }
        // --- Unlock audio context for iOS/Android on first user gesture ---
        (function unlockAudio() {
            function unlock() {
                if (window.speechSynthesis && window.speechSynthesis.speak) {
                    try {
                        const u = new SpeechSynthesisUtterance(' ');
                        window.speechSynthesis.speak(u);
                    } catch(e) {}
                }
                window.removeEventListener('touchstart', unlock, false);
                window.removeEventListener('click', unlock, false);
            }
            window.addEventListener('touchstart', unlock, false);
            window.addEventListener('click', unlock, false);
        })();
        
        // Pronunciation check: record and compare
        // --- Robust Speech Recognition: record and compare ---
        let recognition;
        function startPronunciationCheck(targetWord, language) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition is not supported in this browser. Try using Chrome on Android or desktop.');
                return;
            }
            // Stop previous recognition if running
            if (recognition && recognition.stop) {
                try { recognition.onresult = null; recognition.onerror = null; recognition.onend = null; recognition.stop(); } catch(e) {}
            }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = (function(lang) {
                switch(lang) {
                    case 'COSYenglish': return 'en-GB';
                    case 'COSYfrançais': return 'fr-FR';
                    case 'COSYespañol': return 'es-ES';
                    case 'COSYitaliano': return 'it-IT';
                    case 'COSYdeutsch': return 'de-DE';
                    case 'COSYportuguês': return 'pt-PT';
                    case 'ТАКОЙрусский': return 'ru-RU';
                    case 'COSYbrezhoneg': return 'br-FR';
                    case 'COSYtatarça': return 'tt-RU';
                    case 'COSYbashkort': return 'ba-RU';
                    case 'ԾՈՍՅհայկական': return 'hy-AM';
                    default: return 'en-GB';
                }
            })(language);
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.onresult = function(event) {
                const userSaid = event.results[0][0].transcript.trim().toLowerCase();
                const target = targetWord.trim().toLowerCase();
                // Simple similarity: check if user said word is contained or similar
                let similarity = 0;
                if (userSaid === target) {
                    similarity = 1;
                } else if (userSaid.includes(target) || target.includes(userSaid)) {
                    similarity = 0.8;
                } else {
                    // Levenshtein distance (basic)
                    function lev(a, b) {
                        const matrix = [];
                        for (let i = 0; i <= b.length; i++) matrix[i] = [i];
                        for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
                        for (let i = 1; i <= b.length; i++) {
                            for (let j = 1; j <= a.length; j++) {
                                if (b.charAt(i-1) === a.charAt(j-1)) {
                                    matrix[i][j] = matrix[i-1][j-1];
                                } else {
                                    matrix[i][j] = Math.min(
                                        matrix[i-1][j-1] + 1,
                                        matrix[i][j-1] + 1,
                                        matrix[i-1][j] + 1
                                    );
                                }
                            }
                        }
                        return matrix[b.length][a.length];
                    }
                    const dist = lev(userSaid, target);
                    similarity = 1 - dist / Math.max(target.length, userSaid.length);
                }
                let feedback = '';
                if (similarity > 0.7) {
                    feedback = '✅ Good job! Your pronunciation is close enough.';
                } else if (similarity > 0.4) {
                    feedback = '🟡 Not bad! Try again for a closer pronunciation.';
                } else {
                    feedback = '🔴 Keep practicing! Try to say the word more clearly.';
                }
                document.getElementById('pronunciation-feedback').innerHTML =
                    `<p><strong>You said:</strong> ${userSaid}</p><p>${feedback}</p>`;
            };
            recognition.onerror = function(event) {
                let msg = `<p style='color:red;'>Error: ${event.error}</p>`;
                if (event.error === 'not-allowed' || event.error === 'denied') {
                    msg += '<p style="color:red;">Microphone access denied. Please allow microphone permissions in your browser settings.</p>';
                } else if (event.error === 'no-speech') {
                    msg += '<p style="color:red;">No speech detected. Please try again and speak clearly.</p>';
                }
                document.getElementById('pronunciation-feedback').innerHTML = msg;
                try { recognition.stop(); } catch(e) {}
            };
            recognition.onend = function() {
                // Optionally, you can re-enable the button or give UI feedback here
            };
            try {
                recognition.start();
                document.getElementById('pronunciation-feedback').innerHTML = '<p>Listening...</p>';
            } catch(e) {
                document.getElementById('pronunciation-feedback').innerHTML = '<p style="color:red;">Could not start recognition. Please check your microphone permissions.</p>';
            }
        }

        // Vocabulary practice function (random word from file)
        async function practiceVocabulary(type) {
            const language = document.getElementById('language').value;
            const days = getSelectedDays();
            const resultArea = document.getElementById('result');
            if (!language) {
                alert('Please select a language first');
                return;
            }
            if (!days.length) {
                alert('Please select a day or a range of days first');
                return;
            }
            resultArea.style.display = 'block';
            // For random selection, pick a random day from the range
            const day = days[Math.floor(Math.random() * days.length)];
            if (type === 'random-word') {
                const words = await loadVocabulary(language, day);
                if (!words.length) {
                    resultArea.innerHTML = `<p style="text-align:center;">No vocabulary found for this day.</p>`;
                    return;
                }
                // Load opposites for this language and day
                const opposites = await loadOpposites(language, day);
                // --- Randomly pick a mode: show word, match opposite, or make word ---
                const modes = ['show', 'opposite', 'makeword'];
                let mode = modes[Math.floor(Math.random() * modes.length)];
                let word = words[Math.floor(Math.random() * words.length)];
                if (mode === 'opposite' && !opposites[word.trim()]) {
                    mode = Math.random() < 0.5 ? 'show' : 'makeword';
                }
                function rerender() {
                    if (mode === 'show') renderShowWord();
                    else if (mode === 'opposite') renderOppositePractice();
                    else renderMakeWordPractice();
                }
                function renderShowWord() {
                    resultArea.innerHTML = `
                        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:180px;">
                            <div id="vocab-word" style="font-size:2.2rem; font-weight:600; margin-bottom:18px; text-align:center; cursor:pointer;">${word}</div>
                            <div style="display:flex; gap:18px; justify-content:center; align-items:center; flex-direction:row;">
                                <button id="play-pronounce-btn" class="btn-secondary btn-emoji" title="Hear pronunciation">🔊</button>
                                <button id="say-btn" class="btn-secondary btn-emoji" title="Say it">🎤</button>
                            </div>
                            <div id="pronunciation-feedback" style="margin-top:18px;"></div>
                            <div id="hint-area" style="margin-top:10px;"></div>
                        </div>
                    `;
                    pronounceWord(word, language);
                    let recording = false;
                    setTimeout(() => {
                        document.getElementById('play-pronounce-btn').onclick = function() {
                            pronounceWord(word, language);
                        };
                        document.getElementById('say-btn').onclick = function() {
                            if (!recording) {
                                startPronunciationCheck(word, language);
                                recording = true;
                                this.classList.add('recording');
                            } else {
                                if (recognition && recognition.stop) recognition.stop();
                                recording = false;
                                this.classList.remove('recording');
                            }
                        };
                        document.getElementById('vocab-word').onclick = function() {
                            word = words[Math.floor(Math.random() * words.length)];
                            mode = modes[Math.floor(Math.random() * modes.length)];
                            if (mode === 'opposite' && !opposites[word.trim()]) {
                                mode = Math.random() < 0.5 ? 'show' : 'makeword';
                            }
                            rerender();
                        };
                        document.getElementById('help-btn').onclick = function() {
                            const hintArea = document.getElementById('hint-area');
                            hintArea.innerHTML = `<span style='color:#2980b9;'>Hint: The word starts with <b>${word[0]}</b> and has ${word.length} letters.</span>`;
                            document.getElementById('vocab-word').style.animation = 'shake 0.4s';
                            setTimeout(() => { document.getElementById('vocab-word').style.animation = ''; }, 400);
                        };
                    }, 0);
                }
                function renderOppositePractice() {
                    const opposite = opposites[word.trim()];
                    resultArea.innerHTML = `
                        <div class="flex-col-center min-height-180">
                            <div id="opposite-word" class="font-size-15 font-weight-600 margin-bottom-8 cursor-pointer">${word} ≠ ?</div>
                            <input id="opposite-input" type="text" placeholder="Type the opposite..." class="font-size-11 padding-8-14 border-radius-8 border-bbb margin-bottom-10 min-width-220 text-center">
                            <div class="flex-row-center gap-18 justify-content-center align-items-center">
                                <button id="play-pronounce-btn" class="btn-secondary btn-emoji" title="Hear pronunciation">🔊</button>
                                <button id="say-btn" class="btn-secondary btn-emoji" title="Say it">🎤</button>
                            </div>
                            <div id="pronunciation-feedback" style="margin-top:10px;"></div>
                            <div id="opposite-feedback" style="margin-top:10px;"></div>
                            <div id="hint-area" style="margin-top:10px;"></div>
                        </div>
                    `;
                    let recording = false;
                    setTimeout(() => {
                        document.getElementById('play-pronounce-btn').onclick = function() {
                            pronounceWord(word, language);
                        };
                        document.getElementById('say-btn').onclick = function() {
                            if (!recording) {
                                startPronunciationCheck(word, language);
                                recording = true;
                                this.classList.add('recording');
                            } else {
                                if (recognition && recognition.stop) recognition.stop();
                                recording = false;
                                this.classList.remove('recording');
                            }
                        };
                        document.getElementById('opposite-word').onclick = function() {
                            word = words[Math.floor(Math.random() * words.length)];
                            mode = modes[Math.floor(Math.random() * modes.length)];
                            if (mode === 'opposite' && !opposites[word.trim()]) {
                                mode = Math.random() < 0.5 ? 'show' : 'makeword';
                            }
                            rerender();
                        };
                        document.getElementById('help-btn').onclick = function() {
                            const hintArea = document.getElementById('hint-area');
                            if (opposite && opposite.length > 1) {
                                hintArea.innerHTML = `<span style='color:#2980b9;'>💡 Hint: First letter <b>${opposite[0]}</b>, last letter <b>${opposite[opposite.length-1]}</b></span>`;
                            } else if (opposite) {
                                hintArea.innerHTML = `<span style='color:#2980b9;'>💡 Hint: First letter <b>${opposite[0]}</b></span>`;
                            } else {
                                hintArea.innerHTML = `<span style='color:#2980b9;'>💡 No hint available.</span>`;
                            }
                        };
                        addEnterKeySupport('opposite-input', 'check-opposite-btn');
                    }, 0);
                }
                function renderMakeWordPractice() {
                    // All letters lowercase
                    let lowerWord = word.toLowerCase();
                    function shuffle(str) {
                        const arr = str.split('');
                        for (let i = arr.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [arr[i], arr[j]] = [arr[j], arr[i]];
                        }
                        return arr.join('');
                    }
                    let shuffled = shuffle(lowerWord);
                    while (shuffled === lowerWord && lowerWord.length > 1) {
                        shuffled = shuffle(lowerWord);
                    }
                    let answerArr = Array(lowerWord.length).fill('');
                    let revealedHint = false;
                    resultArea.innerHTML = `
                        <div class="flex-col-center min-height-180">
                          <div id="makeword-letters" class="flex-row-center gap-8 margin-bottom-10 cursor-pointer">
                            ${shuffled.split('').map((ch, i) => `<div class="letter-box border-bbb border-radius-6 font-size-13 cursor-pointer bg-f8 user-select-none" data-idx="${i}">${ch}</div>`).join('')}
                          </div>
                          <div id="makeword-answer" class="flex-row-center gap-8 margin-bottom-10">
                            ${answerArr.map(() => `<div class="letter-box answer-box" style="width:32px;height:32px;display:flex;align-items:center;justify-content:center;border:1px solid #bbb;border-radius:6px;font-size:1.3rem;background:#fff;user-select:none;"> </div>`).join('')}
                          </div>
                          <div style="display:flex; gap:18px; justify-content:center; align-items:center; flex-direction:row;">
                            <button id="play-pronounce-btn" class="btn-secondary btn-emoji" title="Hear pronunciation">🔊</button>
                            <button id="say-btn" class="btn-secondary btn-emoji" title="Say it">🎤</button>
                          </div>
                          <div id="pronunciation-feedback" style="margin-top:10px;"></div>
                          <div id="makeword-feedback" style="margin-top:10px;"></div>
                          <div id="hint-area" style="margin-top:10px;"></div>
                        </div>
                    `;
                    let recording = false;
                    let used = Array(shuffled.length).fill(false);
                    let answerPos = 0;
                    function updateAnswerBoxes() {
                        const answerBoxes = document.querySelectorAll('.answer-box');
                        answerBoxes.forEach((box, i) => {
                            box.textContent = answerArr[i] ? answerArr[i] : ' ';
                        });
                    }
                    setTimeout(() => {
                        document.getElementById('play-pronounce-btn').onclick = function() {
                            pronounceWord(word, language);
                        };
                        document.getElementById('say-btn').onclick = function() {
                            if (!recording) {
                                startPronunciationCheck(word, language);
                                recording = true;
                                this.classList.add('recording');
                            } else {
                                if (recognition && recognition.stop) recognition.stop();
                                recording = false;
                                this.classList.remove('recording');
                            }
                        };
                        // Letter click logic (move to answer)
                        document.querySelectorAll('#makeword-letters .letter-box').forEach((el, idx) => {
                            el.onclick = function() {
                                if (used[idx] || answerPos >= lowerWord.length) return;
                                answerArr[answerPos] = el.textContent;
                                used[idx] = true;
                                el.style.opacity = 0.4;
                                answerPos++;
                                updateAnswerBoxes();
                                if (answerArr.join('') === lowerWord) {
                                    document.getElementById('makeword-feedback').innerHTML = '<span style="color:#27ae60;">✅ Correct!</span>';
                                    setTimeout(rerender, 1200);
                                } else if (answerPos === lowerWord.length) {
                                    document.getElementById('makeword-feedback').innerHTML = `<span style=\"color:#e74c3c;\">❌ Not quite. The correct answer is: <b>${lowerWord}</b></span>`;
                                }
                            };
                        });
                        // Answer box click logic (return letter to pool)
                        document.querySelectorAll('#makeword-answer .answer-box').forEach((el, idx) => {
                            el.onclick = function() {
                                if (answerArr[idx]) {
                                    // Find which letter in shuffled this was
                                    const letter = answerArr[idx];
                                    for (let i = 0; i < shuffled.length; i++) {
                                        if (shuffled[i] === letter && used[i]) {
                                            used[i] = false;
                                            document.querySelectorAll('#makeword-letters .letter-box')[i].style.opacity = 1;
                                            break;
                                        }
                                    }
                                    answerArr[idx] = '';
                                    if (idx < answerPos) answerPos = idx;
                                    updateAnswerBoxes();
                                    document.getElementById('makeword-feedback').innerHTML = '';
                                }
                            };
                        });
                        document.getElementById('makeword-letters').onclick = function(e) {
                            if (e.target.classList.contains('letter-box')) return;
                            rerender();
                        };
                        document.getElementById('help-btn').onclick = function() {
                            if (revealedHint) return;
                            revealedHint = true;
                            // Reveal first or last letter in answer
                            const revealFirst = Math.random() < 0.5;
                            if (revealFirst) {
                                answerArr[0] = lowerWord[0];
                                answerPos = Math.max(answerPos, 1);
                            } else {
                                answerArr[lowerWord.length-1] = lowerWord[lowerWord.length-1];
                                answerPos = Math.max(answerPos, lowerWord.length);
                            }
                            updateAnswerBoxes();
                            document.getElementById('hint-area').innerHTML = `<span style='color:#2980b9;'>💡 Hint: ${revealFirst ? 'First' : 'Last'} letter revealed!</span>`;
                        };
                    }, 0);
                }
                rerender();
                return;
            } else if (type === 'random-image') {
                const images = await loadImageVocabulary(language, day);
                if (!images.length) {
                    resultArea.innerHTML = `<p style="text-align:center;">No images found for this day/language.</p>`;
                    return;
                }
                let item = images[Math.floor(Math.random() * images.length)];
                const answer = item.translations[language] || '[No translation]';
                function renderImage() {
                    let questionBlock = '';
                    if (!p.img) {
      questionBlock = `<div class="font-size-12 font-weight-500 color-bdbd margin-bottom-10">${(translations[language]||translations['COSYenglish']).randomImageQ1}</div>`;
    } else if (parseInt(day) === 2) {
      const t = translations[language]||translations['COSYenglish'];
      questionBlock = `<div class="font-size-12 font-weight-500 color-bdbd margin-bottom-2">${t.randomImageQ2a}</div><div class="font-size-11 font-weight-400 color-bdbd margin-bottom-8">${t.randomImageQ2b}</div>`;
    }
    resultArea.innerHTML = `
      ${questionBlock}
      <div class="flex-col-center min-height-220">
                            <img id="vocab-image" src="${item.src}" alt="${item.alt}" class="vocabulary-image" style="max-width:180px; max-height:180px; margin-bottom:18px; border-radius:16px; box-shadow:0 2px 12px rgba(0,0,0,0.10); cursor:pointer;">
                            <input id="image-answer-input" type="text" placeholder="Type your answer..." style="font-size:1.1rem; padding:8px 14px; border-radius:8px; border:1px solid #bbb; margin-bottom:14px; width:220px; text-align:center;">
                            <div style="display:flex; gap:18px; justify-content:center; align-items:center; flex-direction:row;">
                                <button id="play-pronounce-btn" class="btn-secondary btn-emoji" title="Hear pronunciation">🔊</button>
                                <button id="say-btn" class="btn-secondary btn-emoji" title="Say it">🎤</button>
                            </div>
                            <div id="pronunciation-feedback" style="margin-top:18px;"></div>
                            <div id="image-answer-feedback" style="margin-top:10px;"></div>
                        </div>
                    `;
                    setTimeout(() => {
                        document.getElementById('play-pronounce-btn').onclick = function() {
                            pronounceWord(answer, language);
                        };
                        document.getElementById('say-btn').onclick = function() {
                            startPronunciationCheck(answer, language);
                        };
                        document.getElementById('vocab-image').onclick = function() {
                            item = images[Math.floor(Math.random() * images.length)];
                            renderImage();
                        };
                        document.getElementById('check-image-answer-btn').onclick = function() {
                            const userInput = document.getElementById('image-answer-input').value.trim().toLowerCase();
                            const correct = answer.trim().toLowerCase();
                            let feedback = '';
                            if (!userInput) {
                                feedback = '<span style="color:#e67e22;">Please type your answer above.</span>';
                            } else if (userInput === correct) {
                                feedback = '<span style="color:#27ae60;">✅ Correct!</span>';
                                setTimeout(() => practiceVocabulary('random-image'), 1200);
                            } else if (userInput && correct && (userInput.includes(correct) || correct.includes(userInput))) {
                                feedback = '<span style="color:#f1c40f;">🟡 Almost! Check your spelling.</span>';
                            } else {
                                feedback = `<span style=\"color:#e74c3c;\">❌ Not quite. The correct answer is: <b>${answer}</b></span>`;
                            }
                            document.getElementById('image-answer-feedback').innerHTML = feedback;
                        };
                        addEnterKeySupport('image-answer-input', 'check-image-answer-btn');
                    }, 0);
                }
                renderImage();
                return;
            } else if (type === 'listening') {
                const words = await loadVocabulary(language, day);
                if (!words.length) {
                    resultArea.innerHTML = `<p style=\"text-align:center;\">No vocabulary found for this day.</p>`;
                    return;
                }
                const word = words[Math.floor(Math.random() * words.length)];
                resultArea.innerHTML = `
                    <div style=\"display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:180px;\">
                        <button id=\"play-listen-btn\" class=\"btn-secondary btn-emoji\" title=\"Hear word\">🔊</button>
                        <input id=\"listening-answer-input\" type=\"text\" placeholder=\"Type what you hear...\" style=\"font-size:1.1rem; padding:8px 14px; border-radius:8px; border:1px solid #bbb; margin-bottom:14px; width:220px; text-align:center;\">
                        <button id=\"check-listening-answer-btn\" class=\"btn-secondary\" style=\"margin-bottom:18px; min-width:120px;\">Check</button>
                        <div id=\"listening-answer-feedback\" style=\"margin-top:10px;\"></div>
                    </div>
                `;
                // Automatic pronunciation for listening
                pronounceWord(word, language);
                setTimeout(() => {
                    document.getElementById('play-listen-btn').onclick = function() {
                        pronounceWord(word, language);
                    };
                    document.getElementById('check-listening-answer-btn').onclick = function() {
                        const userInput = document.getElementById('listening-answer-input').value.trim().toLowerCase();
                        const correct = word.trim().toLowerCase();
                        let feedback = '';
                        if (!userInput) {
                            feedback = '<span style="color:#e67e22;\">Please type your answer above.</span>';
                        } else if (userInput === correct) {
                            feedback = '<span style="color:#27ae60;">✅ Correct!</span>';
                            setTimeout(() => practiceVocabulary('listening'), 1200);
                        } else if (userInput && correct && (userInput.includes(correct) || correct.includes(userInput))) {
                            feedback = '<span style="color:#f1c40f;">🟡 Almost! Check your spelling.</span>';
                        } else {
                            feedback = `<span style=\\\"color:#e74c3c;\\\">❌ Not quite. The correct answer is: <b>${word}</b></span>`;
                        }
                        document.getElementById('listening-answer-feedback').innerHTML = feedback;
                    };
                    // Add Enter key support for listening answer
                    addEnterKeySupport('listening-answer-input', 'check-listening-answer-btn');
                }, 0);
                return;
            }
        }
        
        // Load gender grammar data for a given language and day
        async function loadGenderGrammar(language, day) {
            const fileMap = {
                'COSYenglish': 'data/grammar/gender/grammar_gender_english.json',
                'COSYitaliano': 'data/grammar/gender/grammar_gender_italian.json',
                'COSYfrançais': 'data/grammar/gender/grammar_gender_french.json',
                'COSYespañol': 'data/grammar/gender/grammar_gender_spanish.json',
                'COSYdeutsch': 'data/grammar/gender/grammar_gender_german.json',
                'COSYportuguês': 'data/grammar/gender/grammar_gender_portuguese.json',
                'ТАКОЙрусский': 'data/grammar/gender/grammar_gender_russian.json',
                'COSYbrezhoneg': 'data/grammar/gender/grammar_gender_breton.json',
                'COSYtatarça': 'data/grammar/gender/grammar_gender_tatar.json',
                'COSYbashkort': 'data/grammar/gender/grammar_gender_bashkir.json',
                'ԾՈՍՅհայկական': 'data/grammar/gender/grammar_gender_armenian.json',
                'ΚΟΖΥελληνικά': 'data/grammar/gender/grammar_gender_greek.json'
            };
            const file = fileMap[language];
            if (!file) return [];
            try {
                const response = await fetch(file);
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // Load verb grammar data for a given language and day
        async function loadVerbGrammar(language, day) {
            const fileMap = {
                'COSYenglish': 'data/grammar/verbs/grammar_verbs_english.json',
                'COSYitaliano': 'data/grammar/verbs/grammar_verbs_italian.json',
                'COSYfrançais': 'data/grammar/verbs/grammar_verbs_french.json',
                'COSYespañol': 'data/grammar/verbs/grammar_verbs_spanish.json',
                'COSYdeutsch': 'data/grammar/verbs/grammar_verbs_german.json',
                'COSYportuguês': 'data/grammar/verbs/grammar_verbs_portuguese.json',
                'ΚΟΖΥελληνικά': 'data/grammar/verbs/grammar_verbs_greek.json',
                'ТАКОЙрусский': 'data/grammar/verbs/grammar_verbs_russian.json',
                'COSYbrezhoneg': 'data/grammar/verbs/grammar_verbs_breton.json',
                'COSYtatarça': 'data/grammar/verbs/grammar_verbs_tatar.json',
                'COSYbashkort': 'data/grammar/verbs/grammar_verbs_bashkir.json',
            };
            const file = fileMap[language];
            if (!file) return [];
            try {
                const response = await fetch(file);
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // Load possessives grammar data for a given language and day
        async function loadPossessivesGrammar(language, day) {
            const fileMap = {
                'COSYenglish': 'data/grammar/possessives/possessives_english.json',
                'COSYitaliano': 'data/grammar/possessives/possessives_italian.json',
                'COSYfrançais': 'data/grammar/possessives/possessives_french.json',
                'COSYespañol': 'data/grammar/possessives/possessives_spanish.json',
                'COSYdeutsch': 'data/grammar/possessives/possessives_german.json',
                'COSYportuguês': 'data/grammar/possessives/possessives_portuguese.json',
                'ТАКОЙрусский': 'data/grammar/possessives/possessives_russian.json',
                'COSYbrezhoneg': 'data/grammar/possessives/possessives_breton.json',
                'COSYtatarça': 'data/grammar/possessives/possessives_tatar.json',
                'COSYbashkort': 'data/grammar/possessives/possessives_bashkir.json',
                'ԾՈՍՅհայկական': 'data/grammar/possessives/possessives_armenian.json',
                'ΚΟΖΥελληνικά': 'data/grammar/possessives/possessives_greek.json'
            };
            const file = fileMap[language];
            if (!file) return [];
            try {
                const response = await fetch(file);
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // Update all fetch paths in scripts to use the new folder structure: vocabulary/, grammar/, speaking/. For example, fetch('vocabulary/vocabulary_english.json'), fetch('grammar/grammar_gender_french.json'), fetch('speaking/prompts/speaking_french.json'), etc.
        async function loadSpeakingPrompts(language, day) {
            const fileMap = {
                'COSYenglish': 'data/speaking/prompts/speaking_english.json',
                'COSYfrançais': 'data/speaking/prompts/speaking_french.json',
                'COSYespañol': 'data/speaking/prompts/speaking_spanish.json',
                'COSYitaliano': 'data/speaking/prompts/speaking_italian.json',
                'COSYdeutsch': 'data/speaking/prompts/speaking_german.json',
                'COSYportuguês': 'data/speaking/prompts/speaking_portuguese.json',
                'ΚΟΖΥελληνικά': 'data/speaking/prompts/speaking_greek.json',
                'COSYbrezhoneg': 'data/speaking/prompts/speaking_breton.json',
                'ТАКОЙрусский': 'data/speaking/prompts/speaking_russian.json',
                'ԾՈՍՅհայկական': 'data/speaking/prompts/speaking_armenian.json',
                'COSYtatarça': 'data/speaking/prompts/speaking_tatar.json',
                'COSYbashkort': 'data/speaking/prompts/speaking_bashkir.json'
            };
            const file = fileMap[language];
            if (!file) return [];
            try {
                const response = await fetch(file);
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // Speaking practice function
        async function practiceSpeaking() {
            const language = document.getElementById('language').value;
            const days = getSelectedDays();
            const resultArea = document.getElementById('result');
            if (!language || !days.length) {
                alert('Please select language and day or a range of days first');
                return;
            }
            resultArea.style.display = 'block';
            const day = days[Math.floor(Math.random() * days.length)];
            const prompts = await loadSpeakingPrompts(language, day);
            if (!prompts.length) {
                resultArea.innerHTML = `<p>No prompts found for this day/language.</p>`;
                return;
            }
            const prompt = prompts[Math.floor(Math.random() * prompts.length)];
            resultArea.innerHTML = `
                <div style="font-size:1.3rem; margin:20px 0;">${prompt}</div>
                <button id="start-record-btn" class="btn-secondary btn-emoji" title="Record your answer">🎤</button>
                <div id="speaking-feedback" style="margin-top:16px;"></div>
            `;
            setTimeout(() => {
                document.getElementById('start-record-btn').onclick = function() {
                    startSpeakingCheck(prompt, language);
                };
            }, 0);
        }

        // Accent-tolerant speaking check: does user say any word from the prompt?
        function startSpeakingCheck(prompt, language) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition is not supported in this browser.');
                return;
            }
            if (recognition && recognition.stop) {
                try { recognition.onresult = null; recognition.onerror = null; recognition.onend = null; recognition.stop(); } catch(e) {}
            }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = (function(lang) {
                switch(lang) {
                    case 'COSYenglish': return 'en-US';
                    case 'COSYfrançais': return 'fr-FR';
                    case 'COSYespañol': return 'es-ES';
                    case 'COSYitaliano': return 'it-IT';
                    case 'COSYdeutsch': return 'de-DE';
                    case 'COSYportuguês': return 'pt-PT';
                    case 'ΚΟΖΥελληνικά': return 'el-GR';
                    case 'ТАКОЙрусский': return 'ru-RU';
                    case 'COSYbrezhoneg': return 'br-FR';
                    case 'ԾՈՍՅհայկական': return 'hy-AM';
                    case 'COSYtatarça': return 'tt-RU';
                    case 'COSYbashkort': return 'ba-RU';
                    default: return 'en-US';
                }
            })(language);
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.onresult = function(event) {
                const userSaid = event.results[0][0].transcript.trim().toLowerCase();
                // Check if any word from the prompt is in the user's speech (accent-tolerant)
                const promptWords = prompt.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
                const userWords = userSaid.split(/\s+/);
                let match = false;
                for (let w of promptWords) {
                    if (w.length > 2 && userWords.some(u => u.includes(w) || w.includes(u))) {
                        match = true;
                        break;
                    }
                }
                let feedback = '';
                if (match) {
                    feedback = '✅ Good job! Your answer contains words from the prompt.';
                } else {
                    feedback = '🟡 Not bad! Try to include more words from the prompt.';
                }
                document.getElementById('speaking-feedback').innerHTML =
                    `<p><strong>You said:</strong> ${userSaid}</p><p>${feedback}</p>`;
            };
            recognition.onerror = function(event) {
                document.getElementById('speaking-feedback').innerHTML =
                    `<p class="color-red">Error: ${event.error}</p>`;
                try { recognition.stop(); } catch(e) {}
            };
            recognition.onend = function() {};
            recognition.start();
            document.getElementById('speaking-feedback').innerHTML = '<p>Listening...</p>';
        }

        // Change background flag on language select
        const languageSelect = document.getElementById('language');
        languageSelect.addEventListener('change', function() {
            const lang = languageSelect.value;
            // Remove any previous flag class
            document.body.className = document.body.className
                .split(' ') // split classes
                .filter(c => !c.startsWith('flag-')) // remove flag- classes
                .join(' ');
            if (lang) {
                document.body.classList.add('flag-' + lang);
            }
        });
        
        // Speaking practice button
        document.getElementById('speaking-practice-btn').addEventListener('click', function() {
            practiceSpeaking();
        });
        
        document.getElementById('random-word-btn').addEventListener('click', function() {
            practiceVocabulary('random-word');
        });
        document.getElementById('random-image-btn').addEventListener('click', function() {
            practiceVocabulary('random-image');
        });
        document.getElementById('listening-btn').addEventListener('click', function() {
            practiceVocabulary('listening');
        });
        
        // Practice All button logic
        document.getElementById('practice-all-btn').addEventListener('click', async function() {
            const types = ['vocabulary', 'grammar', 'speaking'];
            // Only include types that are available for the selected day(s)
            const days = getSelectedDays();
            if (!days.length) {
                alert('Please select a day or a range of days first');
                return;
            }
            const language = document.getElementById('language').value;
            if (!language) {
                alert('Please select a language first');
                return;
            }
            // Randomly pick a type
            const availableTypes = [];
            // Vocabulary always available
            availableTypes.push('vocabulary');
            // Grammar only if grammar options exist for the day
            if (parseInt(days[0]) >= 1) availableTypes.push('grammar');
            // Speaking always available
            availableTypes.push('speaking');
            const type = availableTypes[Math.floor(Math.random() * availableTypes.length)];
            if (type === 'vocabulary') {
                // Randomly pick a vocabulary mode
                const vocabModes = ['random-word', 'random-image', 'listening'];
                const mode = vocabModes[Math.floor(Math.random() * vocabModes.length)];
                await practiceVocabulary(mode);
            } else if (type === 'grammar') {
                // Randomly pick a grammar type available for the day
                const grammarTypes = [];
                if (parseInt(days[0]) >= 1) grammarTypes.push('gender');
                if (parseInt(days[0]) >= 2) grammarTypes.push('verbs');
                // Add more grammar types as needed
                const gType = grammarTypes[Math.floor(Math.random() * grammarTypes.length)];
                await practiceGrammar(gType);
            } else if (type === 'speaking') {
                await practiceSpeaking();
            }
        });
        
        document.getElementById('practice-all-vocab-btn').addEventListener('click', async function() {
            const days = getSelectedDays();
            if (!days.length) {
                alert('Please select a day or a range of days first');
                return;
            }
            const language = document.getElementById('language').value;
            if (!language) {
                alert('Please select a language first');
                return;
            }
            // Only vocabulary activities
            const vocabModes = ['random-word', 'random-image', 'listening'];
            // Shuffle and practice all modes in sequence
            for (let mode of vocabModes) {
                await practiceVocabulary(mode);
            }
        });

        document.getElementById('practice-all-grammar-btn').addEventListener('click', async function() {
            const days = getSelectedDays();
            if (!days.length) {
                alert('Please select a day or a range of days first');
                return;
            }
            const language = document.getElementById('language').value;
            if (!language) {
                alert('Please select a language first');
                return;
            }
            // Only grammar activities available for the day
            const grammarTypes = [];
            if (parseInt(days[0]) >= 1) grammarTypes.push('gender');
            if (parseInt(days[0]) >= 2) grammarTypes.push('verbs');
            if (parseInt(days[0]) === 3) grammarTypes.push('possessives');
            // Add more grammar types as needed for higher days
            for (let type of grammarTypes) {
                await practiceGrammar(type);
            }
        });
        
        // Add Enter key support for practice check buttons
        function addEnterKeySupport(inputId, checkBtnId) {
            const input = document.getElementById(inputId);
            const checkBtn = document.getElementById(checkBtnId);
            if (input && checkBtn) {
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        checkBtn.click();
                    }
                });
            }
        }

        // Update grammar options to use adventure translations
        function updateGrammarOptions() {
          const lang = document.getElementById('language').value;
          const t = translations[lang] || translations['COSYenglish'];
          const days = getSelectedDays();
          grammarOptionsContainer.innerHTML = '';
          if (!days.length) {
            const noDayMsg = document.createElement('p');
            noDayMsg.textContent = t.selectDay;
            grammarOptionsContainer.appendChild(noDayMsg);
            return;
          }
          // Use the first day in the range to determine which grammar options to show
          const day = parseInt(days[0]);
          // Helper for toggle logic
          function hideOtherGrammarOptionBtns(selectedBtn) {
            const btns = grammarOptionsContainer.querySelectorAll('.grammar-option-btn');
            btns.forEach(btn => {
              if (btn !== selectedBtn) {
                btn.style.display = 'none';
              } else {
                btn.classList.add('active-grammar-btn');
              }
            });
          }
          function showAllGrammarOptionBtns() {
            const btns = grammarOptionsContainer.querySelectorAll('.grammar-option-btn');
            btns.forEach(btn => {
              btn.style.display = 'inline-block';
              btn.classList.remove('active-grammar-btn');
            });
          }
          function makeToggleHandler(btn) {
            return function() {
              const isActive = btn.classList.contains('active-grammar-btn');
              if (isActive) {
                showAllGrammarOptionBtns();
                document.getElementById('result').innerHTML = '';
              } else {
                hideOtherGrammarOptionBtns(btn);
                document.getElementById('result').innerHTML = '';
                // Auto-start practice for this grammar type
                const type = btn.textContent.trim().toLowerCase();
                if (type.includes('gender')) practiceGrammar('gender');
                else if (type.includes('verb')) practiceGrammar('verbs');
                else if (type.includes('adjective')) practiceGrammar('adjectives');
                else if (type.includes('plural')) practiceGrammar('plurals');
                else if (type.includes('past')) practiceGrammar('pastTense');
                else if (type.includes('future')) practiceGrammar('futureTense');
              }
            };
          }
          // Fix: For day 3, ONLY show gender, verbs, possessives (no duplicates)
          if (day === 3) {
            const genderBtn = document.createElement('button');
            genderBtn.textContent = t.gender;
            genderBtn.className = 'btn-secondary btn-small grammar-option-btn';
            genderBtn.onclick = function() {
                hideOtherGrammarOptionBtns(genderBtn);
                document.getElementById('result').innerHTML = '';
                practiceGrammar('gender');
            };
            grammarOptionsContainer.appendChild(genderBtn);
            const verbBtn = document.createElement('button');
            verbBtn.textContent = t.verbs;
            verbBtn.className = 'btn-secondary btn-small grammar-option-btn';
            verbBtn.onclick = function() {
                hideOtherGrammarOptionBtns(verbBtn);
                document.getElementById('result').innerHTML = '';
                practiceGrammar('verbs');
            };
            grammarOptionsContainer.appendChild(verbBtn);
            const possBtn = document.createElement('button');
            possBtn.textContent = t.possessives;
            possBtn.className = 'btn-secondary btn-small grammar-option-btn';
            possBtn.onclick = function() {
                hideOtherGrammarOptionBtns(possBtn);
                document.getElementById('result').innerHTML = '';
                practiceGrammar('possessives');
            };
            grammarOptionsContainer.appendChild(possBtn);
            return;
          }
          // In updateGrammarOptions, always show gender button for day 1+ for all languages
          if (day >= 1) {
            const genderBtn = document.createElement('button');
            genderBtn.textContent = t.gender;
            genderBtn.className = 'btn-secondary btn-small grammar-option-btn';
            genderBtn.onclick = function() {
                // Start gender practice on single click
                hideOtherGrammarOptionBtns(genderBtn);
                document.getElementById('result').innerHTML = '';
                practiceGrammar('gender');
            };
            grammarOptionsContainer.appendChild(genderBtn);
          }
          if (day >= 2) {
            const verbBtn = document.createElement('button');
            verbBtn.textContent = t.verbs;
            verbBtn.className = 'btn-secondary btn-small grammar-option-btn';
            verbBtn.onclick = function() {
                // Start verb practice on single click
                hideOtherGrammarOptionBtns(verbBtn);
                document.getElementById('result').innerHTML = '';
                practiceGrammar('verbs');
            };
            grammarOptionsContainer.appendChild(verbBtn);
          }
          if (day >= 5) {
            const pastBtn = document.createElement('button');
            pastBtn.textContent = t.pastTense;
            pastBtn.className = 'btn-secondary btn-small grammar-option-btn';
            pastBtn.onclick = makeToggleHandler(pastBtn);
            grammarOptionsContainer.appendChild(pastBtn);
          }
          if (day >= 7) {
            const futureBtn = document.createElement('button');
            futureBtn.textContent = t.futureTense;
            futureBtn.className = 'btn-secondary btn-small grammar-option-btn';
            futureBtn.onclick = makeToggleHandler(futureBtn);
            grammarOptionsContainer.appendChild(futureBtn);
          }
        }
        
        // Update UI language on language change
        languageSelect.addEventListener('change', function() {
          const lang = languageSelect.value;
          // Remove any previous flag class
          document.body.className = document.body.className
            .split(' ')
            .filter(c => !c.startsWith('flag-'))
            .join(' ');
          if (lang) {
            document.body.classList.add('flag-' + lang);
          }
          updateUIForLanguage(lang);
        });
        
        // On page load, set UI to default language
        updateUIForLanguage(document.getElementById('language').value || 'COSYenglish');

        // Grammar practice function (gender/verbs)
        async function practiceGrammar(type) {
            const language = document.getElementById('language').value;
            const days = getSelectedDays();
            const resultArea = document.getElementById('result');
            if (!language) {
                alert('Please select a language first');
                return;
            }
            if (!days.length) {
                alert('Please select a day or a range of days first');
                return;
            }
            resultArea.style.display = 'block';
            const day = days[Math.floor(Math.random() * days.length)];
            if (type === 'gender') {
                const items = await loadGenderGrammar(language, day);
                if (!items.length) {
                    resultArea.innerHTML = `<p style="text-align:center;">No gender data for this day/language.</p>`;
                    return;
                }
                let item = items[Math.floor(Math.random() * items.length)];
                function renderGender() {
                    // Determine articles for the language
                    let articles = [];
                    switch(language) {
                        case 'COSYenglish': articles = ['he', 'she', 'it', "he/she"]; break;
                        case 'COSYfrançais': articles = ['le', 'la', "l'", 'le/la']; break;
                        case 'COSYitaliano': articles = ['il', 'la', 'lo', "l'"]; break;
                        case 'COSYespañol': articles = ['el', 'la', 'el/la']; break;
                        case 'COSYdeutsch': articles = ['der', 'die', 'das']; break;
                        case 'COSYportuguês': articles = ['o', 'a', 'o/a']; break;
                        case 'ТАКОЙрусский': articles = ['он', 'она', 'оно']; break;
                        case 'COSYbrezhoneg': articles = ['ar', 'an']; break;
                        case 'COSYtatarça': articles = ['ир-ат', 'хатын-кыз', 'әйбер']; break;
                        case 'COSYbashkort': articles = ['ир-ат', 'ҡатын-ҡыҙ', 'әйбер']; break;
                        case 'ԾՈՍՅհայկական': articles = ['արական', 'իգական', 'միջին']; break;
                        case 'ΚΟΖΥελληνικά': articles = ['ο', 'η', 'το', 'o/h']; break;
                        default: articles = ['the', 'a', 'an']; break;
                    }
                    // Build visually appealing article buttons
                    let articleOptions = articles.map((art, idx) =>
                        `<button type='button' class='article-btn${idx===0 ? " selected" : ""}' data-article='${art}'>${art}</button>`
                    ).join('');
                    resultArea.innerHTML = `
                        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:160px;">
                            <div style="display:flex; align-items:center; gap:12px; margin-bottom:18px;">
                                <span id="gender-word" style="font-size:2rem; font-weight:600; cursor:pointer;">${item.word}</span>
                                <button id="play-gender-pronounce-btn" class="btn-secondary btn-emoji" title="Hear pronunciation">🔊</button>
                            </div>
                            <div id="article-options" style="margin-bottom:18px; display:flex; flex-wrap:wrap; justify-content:center; gap:8px;">${articleOptions}</div>
                            <div id="gender-feedback" style="margin-top:14px;"></div>
                        </div>
                    `;
                    pronounceWord(item.word, language);
                    setTimeout(() => {
                        document.getElementById('play-gender-pronounce-btn').onclick = function() {
                            pronounceWord(item.word, language);
                        };
                        document.getElementById('gender-word').onclick = function() {
                            item = items[Math.floor(Math.random() * items.length)];
                            renderGender();
                        };
                        // Replace article button logic in gender practice:
                        let selectedArticle = articles[0];
                        const articleBtns = document.querySelectorAll('#article-options .article-btn');
                        articleBtns.forEach(btn => {
                            btn.addEventListener('click', function() {
                                articleBtns.forEach(b => b.classList.remove('selected'));
                                btn.classList.add('selected');
                                selectedArticle = btn.getAttribute('data-article');
                                let correct = false;
                                if (Array.isArray(item.article)) {
                                    correct = item.article.includes(selectedArticle);
                                } else {
                                    correct = selectedArticle && (selectedArticle === item.article);
                                }
                                let feedback = '';
                                if (!selectedArticle) {
                                    feedback = '<span style="color:#e67e22;">Please select an article.</span>';
                                } else if (correct) {
                                    feedback = '<span style="color:#27ae60;">✅ Correct!</span>';
                                } else {
                                    feedback = `<span style=\"color:#e74c3c;\">❌ Not quite. The correct article is: <b>${Array.isArray(item.article) ? item.article.join(', ') : item.article}</b></span>`;
                                }
                                document.getElementById('gender-feedback').innerHTML = feedback;
                            });
                        });
                        document.getElementById('help-gender-btn').onclick = function() {
                            const hintArea = document.getElementById('gender-hint-area');
                            // Show the correct article's first letter
                            let correct = Array.isArray(item.article) ? item.article[0] : item.article;
                            hintArea.innerHTML = `<span style='color:#2980b9;'>Hint: The article starts with <b>${correct[0]}</b>.</span>`;
                        };
                    }, 0);
                }
                renderGender();
                return;
            } else if (type === 'verbs') {
                const items = await loadVerbGrammar(language, day);
                if (!items.length) {
                    resultArea.innerHTML = `<p style="text-align:center;">No verb data for this day/language.</p>`;
                    return;
                }
                let item = items[Math.floor(Math.random() * items.length)];
                function renderVerb() {
                    let verbPrompt = '';
                    if (parseInt(day) === 2) {
                        verbPrompt = `<div style=\"font-size:1.2rem; font-weight:500; color:#00bdbd; margin-bottom:8px;\">${(translations[language]||translations['COSYenglish']).verbDay2}</div>`;
                    } else if (parseInt(day) === 3) {
                        verbPrompt = `<div style=\"font-size:1.2rem; font-weight:500; color:#00bdbd; margin-bottom:8px;\">${(translations[language]||translations['COSYenglish']).verbDay3}</div>`;
                    }
                    resultArea.innerHTML = `
                        ${verbPrompt}
                        <div style=\"display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:160px\">

                            <div style=\"display:flex; align-items:center; gap:12px; margin-bottom:18px;\">
                                <span id=\"verb-prompt\" style=\"font-size:2rem; font-weight:600; cursor:pointer;\">${item.prompt}</span>
                                <button id=\"play-verb-pronounce-btn\" class=\"btn-secondary btn-emoji\" title=\"Hear pronunciation\">🔊</button>
                            </div>
                            <input id=\"verb-answer-input\" type=\"text\" placeholder=\"Type the answer...\" style=\"font-size:1.1rem; padding:8px 14px; border-radius:8px; border:1px solid #bbb; margin-bottom:14px; width:220px; text-align:center;\">
                            <div id="verb-answer-feedback" style="margin-top:10px;"></div>
                        </div>
                    `;
                    pronounceWord(item.prompt, language);
                    setTimeout(() => {
                        document.getElementById('play-verb-pronounce-btn').onclick = function() {
                            pronounceWord(item.prompt, language);
                        };
                        document.getElementById('verb-prompt').onclick = function() {
                            item = items[Math.floor(Math.random() * items.length)];
                            renderVerb();
                        };
                        document.getElementById('check-verb-answer-btn').onclick = function() {
                            const userInput = document.getElementById('verb-answer-input').value.trim().toLowerCase();
                            const correct = item.answer.trim().toLowerCase();
                            let feedback = '';
                            if (!userInput) {
                                feedback = '<span style="color:#e67e22;">Please type your answer above.</span>';
                            } else if (userInput === correct) {
                                feedback = '<span style="color:#27ae60;">✅ Correct!</span>';
                                setTimeout(() => practiceGrammar(type), 1200);
                            } else if (userInput && correct && (userInput.includes(correct) || correct.includes(userInput))) {
                                feedback = '<span style="color:#f1c40f;">🟡 Almost! Check your spelling.</span>';
                            } else {
                                feedback = `<span style=\\\"color:#e74c3c;\\\">❌ Not quite. The correct answer is: <b>${item.answer}</b></span>`;
                            }
                            document.getElementById('verb-answer-feedback').innerHTML = feedback;
                                               };
                        addEnterKeySupport('verb-answer-input', 'check-verb-answer-btn');
                    }, 0);
                }
                renderVerb();
                return;
            } else if (type === 'possessives') {
                const items = await loadPossessivesGrammar(language, day);
                if (!items.length) {
                    resultArea.innerHTML = `<p style="text-align:center;">No possessives data for this day/language.</p>`;
                    return;
                }
                let item = items[Math.floor(Math.random() * items.length)];
                function renderPossessive() {
                    resultArea.innerHTML = `
                        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:160px;">
                            <div style="display:flex; align-items:center; gap:12px; margin-bottom:18px;">
                                <span id="poss-prompt" style="font-size:2rem; font-weight:600; cursor:pointer;">${item.prompt}</span>
                                <button id="play-poss-pronounce-btn" class="btn-secondary btn-emoji" title="Hear pronunciation">🔊</button>
                            </div>
                            <input id="poss-answer-input" type="text" placeholder="Type the answer..." style="font-size:1.1rem; padding:8px 14px; border-radius:8px; border:1px solid #bbb; margin-bottom:14px; width:220px; text-align:center;">
                            <div style="display:flex; gap:18px; justify-content:center; align-items:center; flex-direction:row;">
                                <button id="check-poss-answer-btn" class="btn-secondary btn-emoji" title="Get a hint">💡</button>
                                <button id="poss-record-btn" class="btn-secondary btn-emoji" title="Check your pronunciation">🎤</button>
                            </div>
                            <div id="poss-answer-feedback" style="margin-top:10px;"></div>
                            <div id="poss-pronunciation-feedback" style="margin-top:10px;"></div>
                        </div>
                    `;
                    pronounceWord(item.prompt, language);
                    setTimeout(() => {
                        document.getElementById('play-poss-pronounce-btn').onclick = function() {
                            pronounceWord(item.prompt, language);
                        };
                        document.getElementById('poss-prompt').onclick = function() {
                            item = items[Math.floor(Math.random() * items.length)];
                            renderPossessive();
                        };
                        document.getElementById('check-poss-answer-btn').onclick = function() {
                            const userInput = document.getElementById('poss-answer-input').value.trim().toLowerCase();
                            const correct = item.answer.trim().toLowerCase();
                            let feedback = '';
                            if (!userInput) {
                                feedback = '<span style="color:#e67e22;">Please type your answer above.</span>';
                            } else if (userInput === correct) {
                                feedback = '<span style="color:#27ae60;">✅ Correct!</span>';
                                setTimeout(() => practiceGrammar(type), 1200);
                            } else if (userInput && correct && (userInput.includes(correct) || correct.includes(userInput))) {
                                feedback = '<span style="color:#f1c40f;">🟡 Almost! Check your spelling.</span>';
                            } else {
                                feedback = `<span style=\"color:#e74c3c;\">❌ Not quite. The correct answer is: <b>${item.answer}</b></span>`;
                            }
                            document.getElementById('poss-answer-feedback').innerHTML = feedback;
                        };
                        document.getElementById('poss-record-btn').onclick = function() {
                            startPronunciationCheck(item.answer, language);
                        };
                        addEnterKeySupport('poss-answer-input', 'check-poss-answer-btn');
                    }, 0);
                }
                renderPossessive();
                return;
            }
        }

        // Helper: get selected days (single or range)
        function getSelectedDays() {
            const day = document.getElementById('day').value;
            const dayFrom = document.getElementById('day-from').value;
            const dayTo = document.getElementById('day-to').value;
            if (day) {
                return [day];
            } else if (dayFrom && dayTo && Number(dayFrom) <= Number(dayTo)) {
                const from = Number(dayFrom);
                const to = Number(dayTo);
                const days = [];
                for (let i = from; i <= to; i++) days.push(String(i));
                return days;
            } else {
                return [];
            }
        }

        // --- Remember language and day selection using localStorage ---
        function saveUserSelection() {
            localStorage.setItem('cosy_language', document.getElementById('language').value);
            // Removed saving of day selection
        }
        function restoreUserSelection() {
            const savedLang = localStorage.getItem('cosy_language');
            // Removed restoring of day selection
            if (savedLang) {
                document.getElementById('language').value = savedLang;
                // Trigger change event to update UI/flag
                document.getElementById('language').dispatchEvent(new Event('change'));
            }
            // Do not restore day
        }
        // Attach save on change
        if (document.getElementById('language')) {
            document.getElementById('language').addEventListener('change', saveUserSelection);
        }
        // Removed event listener for day
        // Restore on page load
        window.addEventListener('DOMContentLoaded', restoreUserSelection);

        // Helper: Remove accents/diacritics for comparison
        function removeAccents(str) {
            return str.normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/’/g, "'");
        }

        function updateUIForLanguage(lang) {
          const t = translations[lang] || translations['COSYenglish'];
          document.querySelector('h1').textContent = 'COSYlanguages';
          document.querySelector('label[for="language"]').textContent = t.chooseLanguage;
          document.querySelector('label[for="day"]').textContent = t.chooseDay;
          document.querySelector('label[for="day-from"]').textContent = t.dayFrom + ':';
          document.querySelector('label[for="day-to"]').textContent = t.dayTo + ':';
          document.querySelector('.menu-section label[for="language"]').textContent = t.chooseLanguage;
          document.querySelector('.menu-section label[for="day"]').textContent = t.chooseDay;
          document.querySelector('.menu-section label[for="day-from"]').textContent = t.dayFrom + ':';
          document.querySelector('.menu-section label[for="day-to"]').textContent = t.dayTo + ':';
          document.querySelector('.menu-section label:not([for])').textContent = t.selectPractice;
          document.getElementById('vocabulary-btn').textContent = t.vocabulary;
          document.getElementById('grammar-btn').textContent = t.grammar;
          document.getElementById('speaking-btn').textContent = t.speaking;
          document.getElementById('random-word-btn').textContent = t.randomWord;
          document.getElementById('random-image-btn').textContent = t.randomImage;
          document.getElementById('speaking-practice-btn').textContent = t.getPrompt;
          document.getElementById('practice-all-btn').textContent = t.practiceAll;
          // Update grammar options if visible
          if (document.getElementById('grammar-options').style.display === 'block') updateGrammarOptions();
        }

        // Restore all main practice type buttons when returning to menu
        function restoreMenu() {
            showAllMainPracticeTypes();
            showAllVocabularyOptions();
            showAllGrammarOptions();
            vocabularyOptions.style.display = 'none';
            grammarOptions.style.display = 'none';
            speakingOptions.style.display = 'none';
            practiceAllBtn.style.display = 'block';
            // Optionally clear result area
            document.getElementById('result').innerHTML = '';
        }
        // Remove double-click restoreMenu listeners (no longer needed)
        // vocabularyBtn.addEventListener('dblclick', restoreMenu);
        // grammarBtn.addEventListener('dblclick', restoreMenu);
        // speakingBtn.addEventListener('dblclick', restoreMenu);

        // --- Hide/show day and day-from/day-to options depending on selection ---
function updateDaySelectors() {
    const day = daySelect.value;
    const dayFrom = dayFromSelect.value;
    const dayTo = dayToSelect.value;
    if (day) {
        // Hide range selectors
        dayFromSelect.parentElement.style.display = 'none';
        dayToSelect.parentElement.style.display = 'none';
    } else if (dayFrom || dayTo) {
        // Hide single day selector
        daySelect.style.display = 'none';
        dayFromSelect.parentElement.style.display = '';
        dayToSelect.parentElement.style.display = '';
    } else {
        // Show all
        daySelect.style.display = '';
        dayFromSelect.parentElement.style.display = '';
        dayToSelect.parentElement.style.display = '';
    }
}

daySelect.addEventListener('change', updateDaySelectors);
dayFromSelect.addEventListener('change', updateDaySelectors);
dayToSelect.addEventListener('change', updateDaySelectors);

// --- Toggle logic for secondary practice options (Random Word, Random Image, Listening) ---
function hideOtherVocabularyModes(selectedId) {
    ['random-word-btn', 'random-image-btn', 'listening-btn'].forEach(id => {
        if (id !== selectedId) {
            document.getElementById(id).style.display = 'none';
        } else {
            document.getElementById(id).classList.add('active-vocab-btn');
        }
    });
}
function showAllVocabularyModes() {
    ['random-word-btn', 'random-image-btn', 'listening-btn'].forEach(id => {
        document.getElementById(id).style.display = 'inline-block';
        document.getElementById(id).classList.remove('active-vocab-btn');
    });
}
function toggleVocabularyMode(selectedId) {
    const btn = document.getElementById(selectedId);
    const isActive = btn.classList.contains('active-vocab-btn');
    if (isActive) {
        showAllVocabularyModes();
        document.getElementById('result').innerHTML = '';
    } else {
        hideOtherVocabularyModes(selectedId);
        document.getElementById('result').innerHTML = '';
        // Optionally, you could trigger the practice function here if you want auto-start
    }
}

document.getElementById('random-word-btn').addEventListener('click', function() {
    toggleVocabularyMode('random-word-btn');
});
document.getElementById('random-image-btn').addEventListener('click', function() {
    toggleVocabularyMode('random-image-btn');
});
document.getElementById('listening-btn').addEventListener('click', function() {
    toggleVocabularyMode('listening-btn');
});

// Helper: map language select value to opposites file (now in vocabulary/opposites/)
function getOppositesFile(language) {
    switch(language) {
        case 'COSYenglish': return 'data/vocabulary/opposites/opposites_english.json';
        case 'COSYfrançais': return 'data/vocabulary/opposites/opposites_french.json';
        case 'COSYespañol': return 'data/vocabulary/opposites/opposites_spanish.json';
        case 'COSYitaliano': return 'data/vocabulary/opposites/opposites_italian.json';
        case 'COSYdeutsch': return 'data/vocabulary/opposites/opposites_german.json';
        case 'COSYportuguês': return 'data/vocabulary/opposites/opposites_portuguese.json';
        case 'ΚΟΖΥελληνικά': return 'data/vocabulary/opposites/opposites_greek.json';
        case 'COSYbrezhoneg': return 'data/vocabulary/opposites/opposites_breton.json';
        case 'ԾՈՍՅհայկական': return 'data/vocabulary/opposites/opposites_armenian.json';
        case 'ТАКОЙрусский': return 'data/vocabulary/opposites/opposites_russian.json';
        case 'COSYtatarça': return 'data/vocabulary/opposites/opposites_tatar.json';
        case 'COSYbashkort': return 'data/vocabulary/opposites/opposites_bashkir.json';
        default: return null;
    }
}

// Load opposites for a given language and day
async function loadOpposites(language, day) {
    const file = getOppositesFile(language);
    if (!file) return {};
    try {
        const response = await fetch(file);
        if (!response.ok) return {};
        const data = await response.json();
        return data[day] || {};
    } catch (e) {
        return {};
    }
}

// After progress stats rendering (wherever progress stats are shown):
const statsContainer = document.getElementById('progress-stats-container');
if (statsContainer && !document.getElementById('reset-progress-btn')) {
  const resetBtn = document.createElement('button');
  resetBtn.id = 'reset-progress-btn';
  resetBtn.className = 'btn-secondary margin-top-18 margin-bottom-8 font-size-11 text-center';
  resetBtn.textContent = (translations[lang]||translations['COSYenglish']).resetProgress || 'Reset Progress';
  resetBtn.onclick = function() {
    if (confirm((translations[lang]||translations['COSYenglish']).resetConfirm || 'Are you sure you want to reset your progress?')) {
      localStorage.clear();
      location.reload();
    }
  };
  statsContainer.appendChild(resetBtn);
}
    </script>

    <script src="src/js/data-structure.js"></script> 
    <script src="src/js/exercises/vocabulary.js"></script>
    <script src="src/js/exercises/grammar.js"></script>
    <script src="src/js/exercises/speaking.js"></script>
    <script src="src/js/exercises/writing.js"></script>
    <script src="src/js/exercises/reading.js"></script>
    <script src="src/js/interactive.js"></script>
    <script src="src/js/translations.js"></script>
    <script src="src/js/buttons.js"></script>


</body>
</html>