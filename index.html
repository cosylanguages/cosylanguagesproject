<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSYlanguages</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00bdbd">
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('service-worker.js');
        });
      }
    </script>
</head>
<body>
    <div class="container">
        <h1>COSYlanguages</h1>
        
        <div class="menu-section">
            <label for="language">Choose Language:</label>
            <select id="language">
                <option value="">Select a language</option>
                <option value="COSYenglish" data-bg="COSYenglish">COSYenglish</option>
                <option value="COSYfran√ßais" data-bg="COSYfran√ßais">COSYfran√ßais</option>
                <option value="COSYitaliano" data-bg="COSYitaliano">COSYitaliano</option>
                <option value="COSYespa√±ol" data-bg="COSYespa√±ol">COSYespa√±ol</option>
                <option value="COSYportugu√™s" data-bg="COSYportugu√™s">COSYportugu√™s</option>
                <option value="COSYdeutsch" data-bg="COSYdeutsch">COSYdeutsch</option>
                <option value="ŒöŒüŒñŒ•ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨" data-bg="ŒöŒüŒñŒ•ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨">ŒöŒüŒñŒ•ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨</option>
                <option value="–¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π" data-bg="–¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π">–¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π</option>
                <option value="‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂" data-bg="‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂">‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂</option>
                <option value="COSYbrezhoneg" data-bg="COSYbrezhoneg">COSYbrezhoneg</option>
                <option value="COSYtatar√ßa" data-bg="COSYtatar√ßa">COSYtatar√ßa</option>
                <option value="COSYbashkort" data-bg="COSYbashkort">COSYbashkort</option>
            </select>
        </div>
        
        <div class="menu-section">
            <label for="day">Choose Day:</label>
            <select id="day">
                <option value="">Select a day</option>
                <!-- Days will be populated by JavaScript -->
            </select>
            
            <div class="day-range">
                <div>
                    <label for="day-from">Day From:</label>
                    <select id="day-from">
                        <option value="">From</option>
                    </select>
                </div>
                <div>
                    <label for="day-to">Day To:</label>
                    <select id="day-to">
                        <option value="">To</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="menu-section">
            <label>Select Practice Type:</label>
            <div class="practice-types">
                <button id="vocabulary-btn" class="btn-primary">Vocabulary</button>
                <button id="grammar-btn" class="btn-primary">Grammar</button>
                <button id="speaking-btn" class="btn-primary">Speaking</button>
            </div>
            
            <div id="vocabulary-options" class="practice-options">
                <div class="vocabulary-options">
                    <button id="random-word-btn" class="btn-secondary">üîÆ Random Word</button>
                    <button id="random-image-btn" class="btn-secondary">üñºÔ∏è Random Image</button>
                    <button id="listening-btn" class="btn-secondary">üéß Listening</button>
                </div>
            </div>
            
            <div id="grammar-options" class="practice-options">
                <div class="grammar-options">
                    <!-- Grammar buttons will be populated by JavaScript -->
                </div>
            </div>
            
            <div id="speaking-options" class="practice-options">
                <button id="speaking-practice-btn" class="btn-primary">Get Speaking Prompt</button>
            </div>
            
            <button id="practice-all-btn" class="btn-primary" style="margin-top:12px;">Practice All</button>
        </div>
        
        <div id="result" class="result-area"></div>
    </div>

    <script>
        // Populate days dropdown (1-30)
        const daySelect = document.getElementById('day');
        const dayFromSelect = document.getElementById('day-from');
        const dayToSelect = document.getElementById('day-to');
        
        for (let i = 1; i <= 30; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Day ${i}`;
            daySelect.appendChild(option.cloneNode(true));
            dayFromSelect.appendChild(option.cloneNode(true));
            dayToSelect.appendChild(option.cloneNode(true));
        }
        
        // Practice type buttons
        const vocabularyBtn = document.getElementById('vocabulary-btn');
        const grammarBtn = document.getElementById('grammar-btn');
        const speakingBtn = document.getElementById('speaking-btn');
        
        const vocabularyOptions = document.getElementById('vocabulary-options');
        const grammarOptions = document.getElementById('grammar-options');
        const grammarOptionsContainer = grammarOptions.querySelector('.grammar-options');
        const speakingOptions = document.getElementById('speaking-options');
        
        // Hide all options initially
        vocabularyOptions.style.display = 'none';
        grammarOptions.style.display = 'none';
        speakingOptions.style.display = 'none';
        
        // Vocabulary button click
        vocabularyBtn.addEventListener('click', function() {
            // Reset all buttons
            vocabularyBtn.classList.add('btn-primary');
            vocabularyBtn.classList.remove('btn-secondary');
            grammarBtn.classList.add('btn-primary');
            grammarBtn.classList.remove('btn-secondary');
            speakingBtn.classList.add('btn-primary');
            speakingBtn.classList.remove('btn-secondary');
            
            // Toggle vocabulary options
            vocabularyOptions.style.display = vocabularyOptions.style.display === 'none' ? 'block' : 'none';
            grammarOptions.style.display = 'none';
            speakingOptions.style.display = 'none';
            
            // Style the active button
            vocabularyBtn.classList.remove('btn-primary');
            vocabularyBtn.classList.add('btn-secondary');
        });
        
        // Grammar button click
        grammarBtn.addEventListener('click', function() {
            // Reset all buttons
            vocabularyBtn.classList.add('btn-primary');
            vocabularyBtn.classList.remove('btn-secondary');
            grammarBtn.classList.add('btn-primary');
            grammarBtn.classList.remove('btn-secondary');
            speakingBtn.classList.add('btn-primary');
            speakingBtn.classList.remove('btn-secondary');
            
            // Update grammar options based on day
            updateGrammarOptions();
            
            // Toggle grammar options
            grammarOptions.style.display = grammarOptions.style.display === 'none' ? 'block' : 'none';
            vocabularyOptions.style.display = 'none';
            speakingOptions.style.display = 'none';
            
            // Style the active button
            grammarBtn.classList.remove('btn-primary');
            grammarBtn.classList.add('btn-secondary');
        });
        
        // Speaking button click
        speakingBtn.addEventListener('click', function() {
            // Reset all buttons
            vocabularyBtn.classList.add('btn-primary');
            vocabularyBtn.classList.remove('btn-secondary');
            grammarBtn.classList.add('btn-primary');
            grammarBtn.classList.remove('btn-secondary');
            speakingBtn.classList.add('btn-primary');
            speakingBtn.classList.remove('btn-secondary');
            
            // Toggle speaking options
            speakingOptions.style.display = speakingOptions.style.display === 'none' ? 'block' : 'none';
            vocabularyOptions.style.display = 'none';
            grammarOptions.style.display = 'none';
            
            // Style the active button
            speakingBtn.classList.remove('btn-primary');
            speakingBtn.classList.add('btn-secondary');
        });
        
        // Update grammar options based on selected day or range
        function updateGrammarOptions() {
            const lang = document.getElementById('language').value;
            const t = translations[lang] || translations['COSYenglish'];
            const days = getSelectedDays();
            grammarOptionsContainer.innerHTML = '';
            if (!days.length) {
                const noDayMsg = document.createElement('p');
                noDayMsg.textContent = t.selectDay;
                grammarOptionsContainer.appendChild(noDayMsg);
                return;
            }
            // Use the first day in the range to determine which grammar options to show
            const day = parseInt(days[0]);
            if (day >= 1) {
                const genderBtn = document.createElement('button');
                genderBtn.textContent = t.gender;
                genderBtn.className = 'btn-secondary btn-small';
                genderBtn.onclick = function() { practiceGrammar('gender'); };
                grammarOptionsContainer.appendChild(genderBtn);
            }
            if (day >= 2) {
                const verbBtn = document.createElement('button');
                verbBtn.textContent = t.verbs;
                verbBtn.className = 'btn-secondary btn-small';
                verbBtn.onclick = function() { practiceGrammar('verbs'); };
                grammarOptionsContainer.appendChild(verbBtn);
            }
            if (day >= 3) {
                const adjBtn = document.createElement('button');
                adjBtn.textContent = t.adjectives;
                adjBtn.className = 'btn-secondary btn-small';
                adjBtn.onclick = function() { practiceGrammar('adjectives'); };
                grammarOptionsContainer.appendChild(adjBtn);
                const pluralBtn = document.createElement('button');
                pluralBtn.textContent = t.plurals;
                pluralBtn.className = 'btn-secondary btn-small';
                pluralBtn.onclick = function() { practiceGrammar('plurals'); };
                grammarOptionsContainer.appendChild(pluralBtn);
            }
            if (day >= 5) {
                const pastBtn = document.createElement('button');
                pastBtn.textContent = t.pastTense;
                pastBtn.className = 'btn-secondary btn-small';
                pastBtn.onclick = function() { practiceGrammar('past-tense'); };
                grammarOptionsContainer.appendChild(pastBtn);
            }
            if (day >= 7) {
                const futureBtn = document.createElement('button');
                futureBtn.textContent = t.futureTense;
                futureBtn.className = 'btn-secondary btn-small';
                futureBtn.onclick = function() { practiceGrammar('future-tense'); };
                grammarOptionsContainer.appendChild(futureBtn);
            }
        }
        
        // Update grammar options when day changes
        daySelect.addEventListener('change', function() {
            if (grammarOptions.style.display === 'block') {
                updateGrammarOptions();
            }
        });
        
        // Update day, day-from, and day-to event listeners to update grammar options
        ['day', 'day-from', 'day-to'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('change', function() {
                    if (grammarOptions.style.display === 'block') {
                        updateGrammarOptions();
                    }
                });
            }
        });
        
        // Helper: map language select value to vocabulary file
        function getVocabularyFile(language) {
            switch(language) {
                case 'COSYenglish': return 'vocabulary/words/vocabulary_english.json';
                case 'COSYfran√ßais': return 'vocabulary/words/vocabulary_french.json';
                case 'COSYespa√±ol': return 'vocabulary/words/vocabulary_spanish.json';
                case 'COSYitaliano': return 'vocabulary/words/vocabulary_italian.json';
                case 'COSYdeutsch': return 'vocabulary/words/vocabulary_german.json';
                case 'COSYportugu√™s': return 'vocabulary/words/vocabulary_portuguese.json';
                case '–¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π': return 'vocabulary/words/vocabulary_russian.json';
                case 'COSYbrezhoneg': return 'vocabulary/words/vocabulary_breton.json';
                case 'COSYtatar√ßa': return 'vocabulary/words/vocabulary_tatar.json';
                case 'COSYbashkort': return 'vocabulary/words/vocabulary_bashkir.json';
                case '‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂': return 'vocabulary/words/vocabulary_armenian.json';
                case 'ŒöŒüŒñŒ•ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨': return 'vocabulary/words/vocabulary_greek.json';
                default: return null;
            }
        }

        // New: Load vocabulary for selected language and day
        async function loadVocabulary(language, day) {
            const file = getVocabularyFile(language);
            if (!file) return [];
            try {
                const response = await fetch(file);
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // Load random image data for a given day
        async function loadImageVocabulary(day) {
            try {
                const response = await fetch('vocabulary/images/vocabulary_images.json');
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // --- Pronunciation: play word using SpeechSynthesis API, with mobile support ---
        function pronounceWord(word, language) {
            let langCode = 'en-US';
            switch(language) {
                case 'COSYenglish': langCode = 'en-UK'; break;
                case 'COSYfran√ßais': langCode = 'fr-FR'; break;
                case 'COSYespa√±ol': langCode = 'es-ES'; break;
                case 'COSYitaliano': langCode = 'it-IT'; break;
                case 'COSYdeutsch': langCode = 'de-DE'; break;
                case 'COSYportugu√™s': langCode = 'pt-PT'; break;
                case '–¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π': langCode = 'ru-RU'; break;
                case 'COSYbrezhoneg': langCode = 'br-FR'; break;
                case 'COSYtatar√ßa': langCode = 'tt-RU'; break;
                case 'COSYbashkort': langCode = 'ba-RU'; break;
                case '‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂': langCode = 'hy-AM'; break;
                default: langCode = 'en-UK';
            }
            // iOS/Android: require user gesture, so always call from a button or setTimeout after interaction
            if ('speechSynthesis' in window) {
                // Stop any current speech
                window.speechSynthesis.cancel();
                // Some mobile browsers need a short delay
                setTimeout(() => {
                    const utter = new SpeechSynthesisUtterance(word);
                    utter.lang = langCode;
                    utter.rate = 1;
                    utter.pitch = 1;
                    window.speechSynthesis.speak(utter);
                }, 100);
            } else {
                alert('Sorry, speech synthesis is not supported on this device/browser.');
            }
        }
        // --- Unlock audio context for iOS/Android on first user gesture ---
        (function unlockAudio() {
            function unlock() {
                if (window.speechSynthesis && window.speechSynthesis.speak) {
                    try {
                        const u = new SpeechSynthesisUtterance(' ');
                        window.speechSynthesis.speak(u);
                    } catch(e) {}
                }
                window.removeEventListener('touchstart', unlock, false);
                window.removeEventListener('click', unlock, false);
            }
            window.addEventListener('touchstart', unlock, false);
            window.addEventListener('click', unlock, false);
        })();
        
        // Pronunciation check: record and compare
        let recognition;
        function startPronunciationCheck(targetWord, language) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition is not supported in this browser.');
                return;
            }
            // Stop previous recognition if running
            if (recognition && recognition.stop) {
                try { recognition.onresult = null; recognition.onerror = null; recognition.onend = null; recognition.stop(); } catch(e) {}
            }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = (function(lang) {
                switch(lang) {
                    case 'COSYenglish': return 'en-UK';
                    case 'COSYfran√ßais': return 'fr-FR';
                    case 'COSYespa√±ol': return 'es-ES';
                    case 'COSYitaliano': return 'it-IT';
                    case 'COSYdeutsch': return 'de-DE';
                    case 'COSYportugu√™s': return 'pt-PT';
                    case '–¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π': return 'ru-RU';
                    case 'COSYbrezhoneg': return 'br-FR';
                    case 'COSYtatar√ßa': return 'tt-RU';
                    case 'COSYbashkort': return 'ba-RU';
                    case '‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂': return 'hy-AM';
                    default: return 'en-UK';
                }
            })(language);
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.onresult = function(event) {
                const userSaid = event.results[0][0].transcript.trim().toLowerCase();
                const target = targetWord.trim().toLowerCase();
                // Simple similarity: check if user said word is contained or similar
                let similarity = 0;
                if (userSaid === target) {
                    similarity = 1;
                } else if (userSaid.includes(target) || target.includes(userSaid)) {
                    similarity = 0.8;
                } else {
                    // Levenshtein distance (basic)
                    function lev(a, b) {
                        const matrix = [];
                        for (let i = 0; i <= b.length; i++) matrix[i] = [i];
                        for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
                        for (let i = 1; i <= b.length; i++) {
                            for (let j = 1; j <= a.length; j++) {
                                if (b.charAt(i-1) === a.charAt(j-1)) {
                                    matrix[i][j] = matrix[i-1][j-1];
                                } else {
                                    matrix[i][j] = Math.min(
                                        matrix[i-1][j-1] + 1,
                                        matrix[i][j-1] + 1,
                                        matrix[i-1][j] + 1
                                    );
                                }
                            }
                        }
                        return matrix[b.length][a.length];
                    }
                    const dist = lev(userSaid, target);
                    similarity = 1 - dist / Math.max(target.length, userSaid.length);
                }
                let feedback = '';
                if (similarity > 0.7) {
                    feedback = '‚úÖ Good job! Your pronunciation is close enough.';
                } else if (similarity > 0.4) {
                    feedback = 'üü° Not bad! Try again for a closer pronunciation.';
                } else {
                    feedback = 'üî¥ Keep practicing! Try to say the word more clearly.';
                }
                document.getElementById('pronunciation-feedback').innerHTML =
                    `<p><strong>You said:</strong> ${userSaid}</p><p>${feedback}</p>`;
            };
            recognition.onerror = function(event) {
                document.getElementById('pronunciation-feedback').innerHTML =
                    `<p style='color:red;'>Error: ${event.error}</p>`;
                // Always stop on error to avoid stuck state
                try { recognition.stop(); } catch(e) {}
            };
            recognition.onend = function() {
                // Optionally, you can re-enable the button or give UI feedback here
            };
            recognition.start();
            document.getElementById('pronunciation-feedback').innerHTML = '<p>Listening...</p>';
        }

        // Vocabulary practice function (random word from file)
        async function practiceVocabulary(type) {
            const language = document.getElementById('language').value;
            const days = getSelectedDays();
            const resultArea = document.getElementById('result');
            if (!language) {
                alert('Please select a language first');
                return;
            }
            if (!days.length) {
                alert('Please select a day or a range of days first');
                return;
            }
            resultArea.style.display = 'block';
            // For random selection, pick a random day from the range
            const day = days[Math.floor(Math.random() * days.length)];
            if (type === 'random-word') {
                const words = await loadVocabulary(language, day);
                if (!words.length) {
                    resultArea.innerHTML = `<p style="text-align:center;">No vocabulary found for this day.</p>`;
                    return;
                }
                const word = words[Math.floor(Math.random() * words.length)];
                // Modern, centered, minimal UI for random word
                resultArea.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:180px;">
                        <div id="vocab-word" style="font-size:2.2rem; font-weight:600; margin-bottom:18px; text-align:center;">${word}</div>
                        <div style="display:flex; gap:24px; justify-content:center; align-items:center;">
                            <button id="play-pronounce-btn" class="btn-secondary" title="Hear pronunciation" style="font-size:2rem;">üîä</button>
                            <button id="check-pronounce-btn" class="btn-secondary" title="Check your pronunciation" style="font-size:2rem;">üé§</button>
                        </div>
                        <div id="pronunciation-feedback" style="margin-top:18px;"></div>
                    </div>
                `;
                // Automatic pronunciation
                pronounceWord(word, language);
                setTimeout(() => {
                    document.getElementById('play-pronounce-btn').onclick = function() {
                        pronounceWord(word, language);
                    };
                    document.getElementById('check-pronounce-btn').onclick = function() {
                        startPronunciationCheck(word, language);
                    };
                    // Add auto-next for correct answer in input (if any input is used in future)
                }, 0);
                return;
            } else if (type === 'random-image') {
                const images = await loadImageVocabulary(day);
                if (!images.length) {
                    resultArea.innerHTML = `<p style="text-align:center;">No images found for this day.</p>`;
                    return;
                }
                const item = images[Math.floor(Math.random() * images.length)];
                const answer = item.translations[language] || '[No translation]';
                // Modern, centered, minimal UI for random image
                let questionBlock = '';
                if (parseInt(day) === 1) {
                    questionBlock = `<div style="font-size:1.2rem; font-weight:500; color:#00bdbd; margin-bottom:10px;">${(translations[language]||translations['COSYenglish']).randomImageQ1}</div>`;
                } else if (parseInt(day) === 2) {
                    const t = translations[language]||translations['COSYenglish'];
                    questionBlock = `<div style="font-size:1.2rem; font-weight:500; color:#00bdbd; margin-bottom:2px;">${t.randomImageQ2a}</div><div style="font-size:1.1rem; font-weight:400; color:#009999; margin-bottom:8px;">${t.randomImageQ2b}</div>`;
                }
                resultArea.innerHTML = `
                    ${questionBlock}
                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:220px;">
                        <img src="${item.src}" alt="${item.alt}" class="vocabulary-image" style="max-width:180px; max-height:180px; margin-bottom:18px; border-radius:16px; box-shadow:0 2px 12px rgba(0,0,0,0.10);">
                        <input id="image-answer-input" type="text" placeholder="Type your answer..." style="font-size:1.1rem; padding:8px 14px; border-radius:8px; border:1px solid #bbb; margin-bottom:14px; width:220px; text-align:center;">
                        <button id="check-image-answer-btn" class="btn-secondary" style="margin-bottom:18px; min-width:120px;">Check</button>
                        <div style="display:flex; gap:24px; justify-content:center; align-items:center; margin-bottom:0;">
                            <button id="play-pronounce-btn" class="btn-secondary" title="Hear pronunciation" style="font-size:2rem;">üîä</button>
                            <button id="check-pronounce-btn" class="btn-secondary" title="Check your pronunciation" style="font-size:2rem;">üé§</button>
                        </div>
                        <div id="pronunciation-feedback" style="margin-top:18px;"></div>
                        <div id="image-answer-feedback" style="margin-top:10px;"></div>
                    </div>
                `;
                setTimeout(() => {
                    document.getElementById('play-pronounce-btn').onclick = function() {
                        pronounceWord(answer, language);
                    };
                    document.getElementById('check-pronounce-btn').onclick = function() {
                        startPronunciationCheck(answer, language);
                    };
                    document.getElementById('check-image-answer-btn').onclick = function() {
                        const userInput = document.getElementById('image-answer-input').value.trim().toLowerCase();
                        const correct = answer.trim().toLowerCase();
                        let feedback = '';
                        if (!userInput) {
                            feedback = '<span style="color:#e67e22;">Please type your answer above.</span>';
                        } else if (userInput === correct) {
                            feedback = '<span style="color:#27ae60;">‚úÖ Correct!</span>';
                            setTimeout(() => practiceVocabulary('random-image'), 1200);
                        } else if (userInput && correct && (userInput.includes(correct) || correct.includes(userInput))) {
                            feedback = '<span style="color:#f1c40f;">üü° Almost! Check your spelling.</span>';
                        } else {
                            feedback = `<span style=\"color:#e74c3c;\">‚ùå Not quite. The correct answer is: <b>${answer}</b></span>`;
                        }
                        document.getElementById('image-answer-feedback').innerHTML = feedback;
                    };
                    // Add Enter key support for image answer
                    addEnterKeySupport('image-answer-input', 'check-image-answer-btn');
                }, 0);
                return;
            } else if (type === 'listening') {
                const words = await loadVocabulary(language, day);
                if (!words.length) {
                    resultArea.innerHTML = `<p style=\"text-align:center;\">No vocabulary found for this day.</p>`;
                    return;
                }
                const word = words[Math.floor(Math.random() * words.length)];
                resultArea.innerHTML = `
                    <div style=\"display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:180px;\">
                        <button id=\"play-listen-btn\" class=\"btn-secondary\" title=\"Hear word\" style=\"font-size:2rem; margin-bottom:18px;\">üîä</button>
                        <input id=\"listening-answer-input\" type=\"text\" placeholder=\"Type what you hear...\" style=\"font-size:1.1rem; padding:8px 14px; border-radius:8px; border:1px solid #bbb; margin-bottom:14px; width:220px; text-align:center;\">
                        <button id=\"check-listening-answer-btn\" class=\"btn-secondary\" style=\"margin-bottom:18px; min-width:120px;\">Check</button>
                        <div id=\"listening-answer-feedback\" style=\"margin-top:10px;\"></div>
                    </div>
                `;
                setTimeout(() => {
                    document.getElementById('play-listen-btn').onclick = function() {
                        pronounceWord(word, language);
                    };
                    document.getElementById('check-listening-answer-btn').onclick = function() {
                        const userInput = document.getElementById('listening-answer-input').value.trim().toLowerCase();
                        const correct = word.trim().toLowerCase();
                        let feedback = '';
                        if (!userInput) {
                            feedback = '<span style=\"color:#e67e22;\">Please type your answer above.</span>';
                        } else if (userInput === correct) {
                            feedback = '<span style=\"color:#27ae60;\">‚úÖ Correct!</span>';
                            setTimeout(() => practiceVocabulary('listening'), 1200);
                        } else if (userInput && correct && (userInput.includes(correct) || correct.includes(userInput))) {
                            feedback = '<span style=\"color:#f1c40f;">üü° Almost! Check your spelling.</span>';
                        } else {
                            feedback = `<span style=\\\"color:#e74c3c;\\\">‚ùå Not quite. The correct answer is: <b>${word}</b></span>`;
                        }
                        document.getElementById('listening-answer-feedback').innerHTML = feedback;
                    };
                    // Add Enter key support for listening answer
                    addEnterKeySupport('listening-answer-input', 'check-listening-answer-btn');
                }, 0);
                return;
            }
        }
        
        // Load gender grammar data for a given language and day
        async function loadGenderGrammar(language, day) {
            const fileMap = {
                'COSYenglish': 'grammar/gender/grammar_gender_english.json',
                'COSYitaliano': 'grammar/gender/grammar_gender_italian.json',
                'COSYfran√ßais': 'grammar/gender/grammar_gender_french.json',
                'COSYespa√±ol': 'grammar/gender/grammar_gender_spanish.json',
                'COSYdeutsch': 'grammar/gender/grammar_gender_german.json',
                'COSYportugu√™s': 'grammar/gender/grammar_gender_portuguese.json',
                '–¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π': 'grammar/gender/grammar_gender_russian.json',
                'COSYbrezhoneg': 'grammar/gender/grammar_gender_breton.json',
                'COSYtatar√ßa': 'grammar/gender/grammar_gender_tatar.json',
                'COSYbashkort': 'grammar/gender/grammar_gender_bashkir.json',
                '‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂': 'grammar/gender/grammar_gender_armenian.json',
                'ŒöŒüŒñŒ•ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨': 'grammar/gender/grammar_gender_greek.json'
            };
            const file = fileMap[language];
            if (!file) return [];
            try {
                const response = await fetch(file);
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // Load verb grammar data for a given language and day
        async function loadVerbGrammar(language, day) {
            const fileMap = {
                'COSYenglish': 'grammar/verbs/grammar_verbs_english.json',
                'COSYitaliano': 'grammar/verbs/grammar_verbs_italian.json',
                'COSYfran√ßais': 'grammar/verbs/grammar_verbs_french.json',
                'COSYespa√±ol': 'grammar/verbs/grammar_verbs_spanish.json',
                'COSYdeutsch': 'grammar/verbs/grammar_verbs_german.json',
                'COSYportugu√™s': 'grammar/verbs/grammar_verbs_portuguese.json',
                'ŒöŒüŒñŒ•ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨': 'grammar/verbs/grammar_verbs_greek.json'
            };
            const file = fileMap[language];
            if (!file) return [];
            try {
                const response = await fetch(file);
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // Update all fetch paths in scripts to use the new folder structure: vocabulary/, grammar/, speaking/. For example, fetch('vocabulary/vocabulary_english.json'), fetch('grammar/grammar_gender_french.json'), fetch('speaking/speaking_french.json'), etc.
        async function loadSpeakingPrompts(language, day) {
            const fileMap = {
                'COSYenglish': 'speaking/prompts/speaking_english.json',
                'COSYfran√ßais': 'speaking/prompts/speaking_french.json',
                'COSYespa√±ol': 'speaking/prompts/speaking_spanish.json',
                'COSYitaliano': 'speaking/prompts/speaking_italian.json',
                'COSYdeutsch': 'speaking/prompts/speaking_german.json',
                'COSYportugu√™s': 'speaking/prompts/speaking_portuguese.json',
                'ŒöŒüŒñŒ•ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨': 'speaking/prompts/speaking_greek.json',
                'COSYbrezhoneg': 'speaking/prompts/speaking_breton.json',
                '–¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π': 'speaking/prompts/speaking_russian.json',
                '‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂': 'speaking/prompts/speaking_armenian.json',
                'COSYtatar√ßa': 'speaking/prompts/speaking_tatar.json',
                'COSYbashkort': 'speaking/prompts/speaking_bashkir.json'
            };
            const file = fileMap[language];
            if (!file) return [];
            try {
                const response = await fetch(file);
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // Speaking practice function
        async function practiceSpeaking() {
            const language = document.getElementById('language').value;
            const days = getSelectedDays();
            const resultArea = document.getElementById('result');
            if (!language || !days.length) {
                alert('Please select language and day or a range of days first');
                return;
            }
            resultArea.style.display = 'block';
            const day = days[Math.floor(Math.random() * days.length)];
            const prompts = await loadSpeakingPrompts(language, day);
            if (!prompts.length) {
                resultArea.innerHTML = `<h3>Speaking Practice</h3><p>No prompts found for this day/language.</p>`;
                return;
            }
            const prompt = prompts[Math.floor(Math.random() * prompts.length)];
            resultArea.innerHTML = `
                <h3>Speaking Practice</h3>
                <div style="font-size:1.3rem; margin:20px 0;">${prompt}</div>
                <button id="start-record-btn" class="btn-secondary">üé§ Record & Check</button>
                <div id="speaking-feedback" style="margin-top:16px;"></div>
            `;
            setTimeout(() => {
                document.getElementById('start-record-btn').onclick = function() {
                    startSpeakingCheck(prompt, language);
                };
            }, 0);
        }

        // Accent-tolerant speaking check: does user say any word from the prompt?
        function startSpeakingCheck(prompt, language) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition is not supported in this browser.');
                return;
            }
            if (recognition && recognition.stop) {
                try { recognition.onresult = null; recognition.onerror = null; recognition.onend = null; recognition.stop(); } catch(e) {}
            }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = (function(lang) {
                switch(lang) {
                    case 'COSYenglish': return 'en-US';
                    case 'COSYfran√ßais': return 'fr-FR';
                    case 'COSYespa√±ol': return 'es-ES';
                    case 'COSYitaliano': return 'it-IT';
                    case 'COSYdeutsch': return 'de-DE';
                    case 'COSYportugu√™s': return 'pt-PT';
                    default: return 'en-US';
                }
            })(language);
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.onresult = function(event) {
                const userSaid = event.results[0][0].transcript.trim().toLowerCase();
                // Check if any word from the prompt is in the user's speech (accent-tolerant)
                const promptWords = prompt.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
                const userWords = userSaid.split(/\s+/);
                let match = false;
                for (let w of promptWords) {
                    if (w.length > 2 && userWords.some(u => u.includes(w) || w.includes(u))) {
                        match = true;
                        break;
                    }
                }
                let feedback = '';
                if (match) {
                    feedback = '‚úÖ Good job! Your answer contains words from the prompt.';
                } else {
                    feedback = 'üü° Not bad! Try to include more words from the prompt.';
                }
                document.getElementById('speaking-feedback').innerHTML =
                    `<p><strong>You said:</strong> ${userSaid}</p><p>${feedback}</p>`;
            };
            recognition.onerror = function(event) {
                document.getElementById('speaking-feedback').innerHTML =
                    `<p style='color:red;'>Error: ${event.error}</p>`;
                try { recognition.stop(); } catch(e) {}
            };
            recognition.onend = function() {};
            recognition.start();
            document.getElementById('speaking-feedback').innerHTML = '<p>Listening...</p>';
        }

        // Change background flag on language select
        const languageSelect = document.getElementById('language');
        languageSelect.addEventListener('change', function() {
            const lang = languageSelect.value;
            // Remove any previous flag class
            document.body.className = document.body.className
                .split(' ') // split classes
                .filter(c => !c.startsWith('flag-')) // remove flag- classes
                .join(' ');
            if (lang) {
                document.body.classList.add('flag-' + lang);
            }
        });
        
        // Speaking practice button
        document.getElementById('speaking-practice-btn').addEventListener('click', function() {
            practiceSpeaking();
        });
        
        document.getElementById('random-word-btn').addEventListener('click', function() {
            practiceVocabulary('random-word');
        });
        document.getElementById('random-image-btn').addEventListener('click', function() {
            practiceVocabulary('random-image');
        });
        document.getElementById('listening-btn').addEventListener('click', function() {
            practiceVocabulary('listening');
        });
        
        // Practice All button logic
        document.getElementById('practice-all-btn').addEventListener('click', async function() {
            const types = ['vocabulary', 'grammar', 'speaking'];
            // Only include types that are available for the selected day(s)
            const days = getSelectedDays();
            if (!days.length) {
                alert('Please select a day or a range of days first');
                return;
            }
            const language = document.getElementById('language').value;
            if (!language) {
                alert('Please select a language first');
                return;
            }
            // Randomly pick a type
            const availableTypes = [];
            // Vocabulary always available
            availableTypes.push('vocabulary');
            // Grammar only if grammar options exist for the day
            if (parseInt(days[0]) >= 1) availableTypes.push('grammar');
            // Speaking always available
            availableTypes.push('speaking');
            const type = availableTypes[Math.floor(Math.random() * availableTypes.length)];
            if (type === 'vocabulary') {
                // Randomly pick a vocabulary mode
                const vocabModes = ['random-word', 'random-image', 'listening'];
                const mode = vocabModes[Math.floor(Math.random() * vocabModes.length)];
                await practiceVocabulary(mode);
            } else if (type === 'grammar') {
                // Randomly pick a grammar type available for the day
                const grammarTypes = [];
                if (parseInt(days[0]) >= 1) grammarTypes.push('gender');
                if (parseInt(days[0]) >= 2) grammarTypes.push('verbs');
                // Add more grammar types as needed
                const gType = grammarTypes[Math.floor(Math.random() * grammarTypes.length)];
                await practiceGrammar(gType);
            } else if (type === 'speaking') {
                await practiceSpeaking();
            }
        });
        
        // Add Enter key support for practice check buttons
        function addEnterKeySupport(inputId, checkBtnId) {
            const input = document.getElementById(inputId);
            const checkBtn = document.getElementById(checkBtnId);
            if (input && checkBtn) {
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        checkBtn.click();
                    }
                });
            }
        }

        // Adventure-style translations for UI
        const translations = {
  COSYenglish: {
    title: 'COSYlanguages',
    chooseLanguage: 'üåê Choose Your Language:',
    chooseDay: 'üìÖ Choose Your Day:',
    dayFrom: 'From',
    dayTo: 'To',
    selectPractice: 'üß≠ Choose Your Practice:',
    vocabulary: 'Vocabulary',
    grammar: 'Grammar',
    speaking: 'Speaking',
    randomWord: 'üîÆ Random Word',
    randomImage: 'üñºÔ∏è Random Image',
    getPrompt: 'üé≤ Get Speaking Prompt',
    gender: '‚öñÔ∏è Gender',
    verbs: '‚ö° Verbs',
    adjectives: '‚ú® Adjectives',
    plurals: 'üî¢ Plurals',
    pastTense: '‚è≥ Past Tense',
    futureTense: 'üîÆ Future Tense',
    selectDay: 'Select a day',
    selectLang: 'Select a language',
    check: 'Check',
    trySentence: 'Try to use this word in a sentence!',
    randomImageQ1: '‚ùì What is it?',
    randomImageQ2a: 'üßë Who is it?',
    randomImageQ2b: '‚ùì What is it?',
    verbDay2: '‚ú® To be',
    verbDay3: '‚ú® To have'
  },
  COSYitaliano: {
    title: 'COSYlanguages',
    chooseLanguage: 'üåê Scegli la lingua:',
    chooseDay: 'üìÖ Scegli il giorno:',
    dayFrom: 'Da',
    dayTo: 'A',
    selectPractice: 'üß≠ Scegli la pratica:',
    vocabulary: 'Vocabolario',
    grammar: 'Grammatica',
    speaking: 'Conversazione',
    randomWord: 'üîÆ Parola Casuale',
    randomImage: 'üñºÔ∏è Immagine Casuale',
    getPrompt: 'üé≤ Ottieni Spunto Orale',
    gender: '‚öñÔ∏è Genere',
    verbs: '‚ö° Verbi',
    adjectives: '‚ú® Aggettivi',
    plurals: 'üî¢ Plurali',
    pastTense: '‚è≥ Passato',
    futureTense: 'üîÆ Futuro',
    selectDay: 'Scegli un giorno',
    selectLang: 'Scegli una lingua',
    check: 'Controlla',
    trySentence: 'Prova a usare questa parola in una frase!',
    randomImageQ1: '‚ùì Cosa √®?',
    randomImageQ2a: 'üßë Chi √®?',
    randomImageQ2b: '‚ùì Cosa √®?',
    verbDay2: '‚ú® Essere',
    verbDay3: '‚ú® Avere'
  },
  COSYfran√ßais: {
    title: 'COSYlanguages',
    chooseLanguage: 'üåê Choisis ta langue :',
    chooseDay: 'üìÖ Choisis le jour :',
    dayFrom: 'De',
    dayTo: '√Ä',
    selectPractice: 'üß≠ Choisis ta pratique :',
    vocabulary: 'Vocabulaire',
    grammar: 'Grammaire',
    speaking: 'Conversation',
    randomWord: 'üîÆ Mot Al√©atoire',
    randomImage: 'üñºÔ∏è Image Al√©atoire',
    getPrompt: 'üé≤ Obtenir un Sujet Oral',
    gender: '‚öñÔ∏è Genre',
    verbs: '‚ö° Verbes',
    adjectives: '‚ú® Adjectifs',
    plurals: 'üî¢ Pluriels',
    pastTense: '‚è≥ Pass√©',
    futureTense: 'üîÆ Futur',
    selectDay: 'Choisis un jour',
    selectLang: 'Choisis une langue',
    check: 'V√©rifier',
    trySentence: 'Essaie d‚Äôutiliser ce mot dans une phrase !',
    randomImageQ1: '‚ùì C‚Äôest quoi?',
    randomImageQ2a: 'üßë Qui est-ce ?',
    randomImageQ2b: '‚ùì C‚Äôest quoi ?',
    verbDay2: '‚ú® √ätre',
    verbDay3: '‚ú® Avoir'
  },
  COSYespa√±ol: {
    title: 'COSYlanguages',
    chooseLanguage: 'üåê Elige tu idioma:',
    chooseDay: 'üìÖ Elige el d√≠a:',
    dayFrom: 'De',
    dayTo: 'A',
    selectPractice: 'üß≠ Elige tu pr√°ctica:',
    vocabulary: 'Vocabulario',
    grammar: 'Gram√°tica',
    speaking: 'Conversaci√≥n',
    randomWord: 'üîÆ Palabra Aleatoria',
    randomImage: 'üñºÔ∏è Imagen Aleatoria',
    getPrompt: 'üé≤ Obtener Tema Oral',
    gender: '‚öñÔ∏è G√©nero',
    verbs: '‚ö° Verbos',
    adjectives: '‚ú® Adjetivos',
    plurals: 'üî¢ Plurales',
    pastTense: '‚è≥ Pasado',
    futureTense: 'üîÆ Futuro',
    selectDay: 'Elige un d√≠a',
    selectLang: 'Elige un idioma',
    check: 'Comprobar',
    trySentence: '¬°Intenta usar esta palabra en una frase!',
    randomImageQ1: '‚ùì ¬øQu√© es?',
    randomImageQ2a: 'üßë ¬øQui√©n es?',
    randomImageQ2b: '‚ùì ¬øQu√© es?',
    verbDay2: '‚ú® Ser',
    verbDay3: '‚ú® Tener'
  },
  COSYdeutsch: {
    title: 'COSYlanguages',
    chooseLanguage: 'üåê W√§hle deine Sprache:',
    chooseDay: 'üìÖ W√§hle den Tag:',
    dayFrom: 'Von',
    dayTo: 'Bis',
    selectPractice: 'üß≠ W√§hle deine √úbung:',
    vocabulary: 'Vokabular',
    grammar: 'Grammatik',
    speaking: 'Sprechen',
    randomWord: 'üîÆ Zufallswort',
    randomImage: 'üñºÔ∏è Zufallsbild',
    getPrompt: 'üé≤ Sprech-Aufgabe',
    gender: '‚öñÔ∏è Genus',
    verbs: '‚ö° Verben',
    adjectives: '‚ú® Adjektive',
    plurals: 'üî¢ Plural',
    pastTense: '‚è≥ Vergangenheit',
    futureTense: 'üîÆ Zukunft',
    selectDay: 'W√§hle einen Tag',
    selectLang: 'W√§hle eine Sprache',
    check: 'Pr√ºfen',
    trySentence: 'Versuche, dieses Wort in einem Satz zu verwenden!',
    randomImageQ1: '‚ùì Was ist das?',
    randomImageQ2a: 'üßë Wer ist das?',
    randomImageQ2b: '‚ùì Was ist das?',
    verbDay2: '‚ú® Sein',
    verbDay3: '‚ú® Haben'
  },
  COSYportugu√™s: {
    title: 'COSYlanguages',
    chooseLanguage: 'üåê Escolha o idioma:',
    chooseDay: 'üìÖ Escolha o dia:',
    dayFrom: 'De',
    dayTo: 'At√©',
    selectPractice: 'üß≠ Escolha sua pr√°tica:',
    vocabulary: 'Vocabul√°rio',
    grammar: 'Gram√°tica',
    speaking: 'Conversa√ß√£o',
    randomWord: 'üîÆ Palavra Aleat√≥ria',
    randomImage: 'üñºÔ∏è Imagem Aleat√≥ria',
    getPrompt: 'üé≤ Obter Tema Oral',
    gender: '‚öñÔ∏è G√™nero',
    verbs: '‚ö° Verbos',
    adjectives: '‚ú® Adjetivos',
    plurals: 'üî¢ Plurais',
    pastTense: '‚è≥ Passado',
    futureTense: 'üîÆ Futuro',
    selectDay: 'Escolha um dia',
    selectLang: 'Escolha um idioma',
    check: 'Verificar',
    trySentence: 'Tente usar esta palavra em uma frase!',
    randomImageQ1: '‚ùì O que √©?',
    randomImageQ2a: 'üßë Quem √©?',
    randomImageQ2b: '‚ùì O que √©?',
    verbDay2: '‚ú® Ser',
    verbDay3: '‚ú® Ter'
  },
  ŒöŒüŒñŒ•ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨: {
    title: 'COSYlanguages',
    chooseLanguage: 'üåê ŒïœÄŒØŒªŒµŒæŒµ Œ≥ŒªœéœÉœÉŒ±:',
    chooseDay: 'üìÖ ŒïœÄŒØŒªŒµŒæŒµ Œ∑ŒºŒ≠œÅŒ±:',
    dayFrom: 'ŒëœÄœå',
    dayTo: 'ŒàœâœÇ',
    selectPractice: 'üß≠ ŒïœÄŒØŒªŒµŒæŒµ œÄœÅŒ±Œ∫œÑŒπŒ∫ŒÆ:',
    vocabulary: 'ŒõŒµŒæŒπŒªœåŒ≥ŒπŒø',
    grammar: 'ŒìœÅŒ±ŒºŒºŒ±œÑŒπŒ∫ŒÆ',
    speaking: 'ŒüŒºŒπŒªŒØŒ±',
    randomWord: 'üîÆ Œ§œÖœáŒ±ŒØŒ± ŒõŒ≠ŒæŒ∑',
    randomImage: 'üñºÔ∏è Œ§œÖœáŒ±ŒØŒ± ŒïŒπŒ∫œåŒΩŒ±',
    getPrompt: 'üé≤ Œ†Œ¨œÅŒµ ŒòŒ≠ŒºŒ± ŒüŒºŒπŒªŒØŒ±œÇ',
    gender: '‚öñÔ∏è ŒìŒ≠ŒΩŒøœÇ',
    verbs: '‚ö° Œ°ŒÆŒºŒ±œÑŒ±',
    adjectives: '‚ú® ŒïœÄŒØŒ∏ŒµœÑŒ±',
    plurals: 'üî¢ Œ†ŒªŒ∑Œ∏œÖŒΩœÑŒπŒ∫œåœÇ',
    pastTense: '‚è≥ Œ†Œ±œÅŒµŒªŒ∏œåŒΩ',
    futureTense: 'üîÆ ŒúŒ≠ŒªŒªŒøŒΩ',
    selectDay: 'ŒïœÄŒØŒªŒµŒæŒµ Œ∑ŒºŒ≠œÅŒ±',
    selectLang: 'ŒïœÄŒØŒªŒµŒæŒµ Œ≥ŒªœéœÉœÉŒ±',
    check: 'ŒàŒªŒµŒ≥œáŒøœÇ',
    trySentence: 'ŒîŒøŒ∫ŒØŒºŒ±œÉŒµ ŒΩŒ± œáœÅŒ∑œÉŒπŒºŒøœÄŒøŒπŒÆœÉŒµŒπœÇ Œ±œÖœÑŒÆ œÑŒ∑ ŒªŒ≠ŒæŒ∑ œÉŒµ ŒºŒπŒ± œÄœÅœåœÑŒ±œÉŒ∑!',
    randomImageQ1: '‚ùì Œ§Œπ ŒµŒØŒΩŒ±Œπ;',
    randomImageQ2a: 'üßë Œ†ŒøŒπŒøœÇ.Œ±.Œø ŒµŒØŒΩŒ±;',
    randomImageQ2b: '‚ùì Œ§Œπ ŒµŒØŒΩŒ±Œπ;',
    verbDay2: '‚ú® ŒïŒØŒºŒ±Œπ',
    verbDay3: '‚ú® Œàœáœâ'
  },
  –¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π: {
    title: 'COSYlanguages',
    chooseLanguage: 'üåê –í—ã–±–µ—Ä–∏ —è–∑—ã–∫:',
    chooseDay: 'üìÖ –í—ã–±–µ—Ä–∏ –¥–µ–Ω—å:',
    dayFrom: '–°',
    dayTo: '–ü–æ',
    selectPractice: 'üß≠ –í—ã–±–µ—Ä–∏ –ø—Ä–∞–∫—Ç–∏–∫—É:',
    vocabulary: '–°–ª–æ–≤–∞—Ä—å',
    grammar: '–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞',
    speaking: '–†–∞–∑–≥–æ–≤–æ—Ä',
    randomWord: 'üîÆ –°–ª—É—á–∞–π–Ω–æ–µ —Å–ª–æ–≤–æ',
    randomImage: 'üñºÔ∏è –°–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
    getPrompt: 'üé≤ –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–º—É –¥–ª—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞',
    gender: '‚öñÔ∏è –†–æ–¥',
    verbs: '‚ö° –ì–ª–∞–≥–æ–ª—ã',
    adjectives: '‚ú® –ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ',
    plurals: 'üî¢ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ',
    pastTense: '‚è≥ –ü—Ä–æ—à–µ–¥—à–µ–µ',
    futureTense: 'üîÆ –ë—É–¥—É—â–µ–µ',
    selectDay: '–í—ã–±–µ—Ä–∏ –¥–µ–Ω—å',
    selectLang: '–í—ã–±–µ—Ä–∏ —è–∑—ã–∫',
    check: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å',
    trySentence: '–ü–æ–ø—Ä–æ–±—É–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ —Å–ª–æ–≤–æ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏!',
    randomImageQ1: '‚ùì –ß—Ç–æ —ç—Ç–æ?',
    randomImageQ2a: 'üßë –ö—Ç–æ —ç—Ç–æ?',
    randomImageQ2b: '‚ùì –ß—Ç–æ —ç—Ç–æ?',
    verbDay2: '‚ú® –ë—ã—Ç—å',
    verbDay3: '‚ú® –ò–º–µ—Ç—å'
  },
  ‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂: {
    title: 'COSYlanguages',
    chooseLanguage: 'üåê ‘∏’∂’ø÷Ä’´÷Ä ’¨’•’¶’∏÷Ç’∂:',
    chooseDay: 'üìÖ ‘∏’∂’ø÷Ä’´÷Ä ÷Ö÷Ä’®:',
    dayFrom: '’ç’Ø’Ω’°’Æ',
    dayTo: '’Ñ’´’∂’π÷á',
    selectPractice: 'üß≠ ‘∏’∂’ø÷Ä’´÷Ä ’æ’°÷Ä’™’∏÷Ç’©’µ’∏÷Ç’∂’®:',
    vocabulary: '‘≤’°’º’°’∫’°’∑’°÷Ä',
    grammar: '’î’•÷Ä’°’Ø’°’∂’∏÷Ç’©’µ’∏÷Ç’∂',
    speaking: '‘Ω’∏’Ω÷Ñ',
    randomWord: 'üîÆ ’ä’°’ø’°’∞’°’Ø’°’∂ ’¢’°’º',
    randomImage: 'üñºÔ∏è ’ä’°’ø’°’∞’°’Ø’°’∂ ’∫’°’ø’Ø’•÷Ä',
    getPrompt: 'üé≤ ’ç’ø’°÷Å’´÷Ä ’¢’°’∂’°’æ’∏÷Ä ’©’•’¥’°',
    gender: '‚öñÔ∏è ’ç’•’º',
    verbs: '‚ö° ‘≤’°’µ’•÷Ä',
    adjectives: '‚ú® ‘±’º’°’∂÷Å÷Ñ’°’µ’´’∂ ’¢’°’º’•÷Ä',
    plurals: 'üî¢ ‘≤’°’¶’¥’°’Ø’°’∂',
    pastTense: '‚è≥ ‘±’∂÷Å’µ’°’¨',
    futureTense: 'üîÆ ‘±’∫’°’£’°',
    selectDay: '‘∏’∂’ø÷Ä’´÷Ä ÷Ö÷Ä’®',
    selectLang: '‘∏’∂’ø÷Ä’´÷Ä ’¨’•’¶’∏÷Ç’∂',
    check: '’ç’ø’∏÷Ç’£’•’¨',
    trySentence: '’ì’∏÷Ä’±’´÷Ä ÷Ö’£’ø’°’£’∏÷Ä’Æ’•’¨ ’°’µ’Ω ’¢’°’º’® ’∂’°’≠’°’§’°’Ω’∏÷Ç’©’µ’°’∂ ’¥’•’ª!',
    randomImageQ1: '‚ùì ‘ª’û’∂’π ’ß ’Ω’°?',
    randomImageQ2a: 'üßë ’à’û’æ ’ß ’Ω’°:',
    randomImageQ2b: '‚ùì ‘ª’û’∂’π ’ß ’Ω’°:',
    verbDay2: '‚ú® ‘µ’≤’•’¨',
    verbDay3: '‚ú® ’à÷Ç’∂’•’∂’°’¨'
  },
  COSYbrezhoneg: {
    title: 'COSYlanguages',
    chooseLanguage: 'üåê Dibab yezh:',
    chooseDay: 'üìÖ Dibab deiz:',
    dayFrom: 'Adalek',
    dayTo: 'Betek',
    selectPractice: 'üß≠ Dibab ar prantad:',
    vocabulary: 'Gerio√π',
    grammar: 'Yezhadur',
    speaking: 'Komz',
    randomWord: 'üîÆ Ger dre zegouezh',
    randomImage: 'üñºÔ∏è Skeudenn dre zegouezh',
    getPrompt: 'üé≤ Kaout tem komz',
    gender: '‚öñÔ∏è Reizh',
    verbs: '‚ö° Verbio√π',
    adjectives: '‚ú® Adveziado√π',
    plurals: 'üî¢ Lies',
    pastTense: '‚è≥ Dremenet',
    futureTense: 'üîÆ Da zont',
    selectDay: 'Dibab deiz',
    selectLang: 'Dibab yezh',
    check: 'Gwiria√±',
    trySentence: 'Klask implij ar ger-ma√± en ur frazenn!',
    randomImageQ1: '‚ùì Petra eo?',
    randomImageQ2a: 'üßë Peseurt den eo?',
    randomImageQ2b: '‚ùì Petra eo?',
    verbDay2: '‚ú® Bezha√±',
    verbDay3: '‚ú® Ouzhpenna√±'
  },
  COSYtatar√ßa: {
    title: 'COSYlanguages',
    chooseLanguage: 'üåê –¢–µ–ª–Ω–µ —Å–∞–π–ª–∞:',
    chooseDay: 'üìÖ –ö”©–Ω–Ω–µ —Å–∞–π–ª–∞:',
    dayFrom: '–ö–µ–º–Ω”ô–Ω',
    dayTo: '–ö–µ–º–≥”ô',
    selectPractice: 'üß≠ –ü—Ä–∞–∫—Ç–∏–∫–∞ —Ç”©—Ä–µ–Ω —Å–∞–π–ª–∞:',
    vocabulary: '–°“Ø–∑–ª–µ–∫',
    grammar: '–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞',
    speaking: '–°”©–π–ª”ô–º',
    randomWord: 'üîÆ –û—á—Ä–∞–∫–ª—ã —Å“Ø–∑',
    randomImage: 'üñºÔ∏è –û—á—Ä–∞–∫–ª—ã —Ä”ô—Å–µ–º',
    getPrompt: 'üé≤ –°”©–π–ª”ô–º —Ç–µ–º–∞—Å—ã–Ω –∞–ª',
    gender: '‚öñÔ∏è “ñ–µ–Ω–µ—Å',
    verbs: '‚ö° –§–∏–≥—ã–ª—å–ª”ô—Ä',
    adjectives: '‚ú® –°—ã–π—Ñ–∞—Ç–ª–∞—Ä',
    plurals: 'üî¢ –ö“Ø–ø–ª–µ–∫',
    pastTense: '‚è≥ “Æ—Ç–∫”ô–Ω –∑–∞–º–∞–Ω',
    futureTense: 'üîÆ –ö–∏–ª”ô—á”ô–∫ –∑–∞–º–∞–Ω',
    selectDay: '–ö”©–Ω–Ω–µ —Å–∞–π–ª–∞',
    selectLang: '–¢–µ–ª–Ω–µ —Å–∞–π–ª–∞',
    check: '–¢–∏–∫—à–µ—Ä–µ—Ä–≥”ô',
    trySentence: '–ë—É —Å“Ø–∑–Ω–µ “ó”©–º–ª”ô–¥”ô –∫—É–ª–ª–∞–Ω—ã–ø –∫–∞—Ä–∞!',
    randomImageQ1: '‚ùì –ë—É –Ω”ô—Ä—Å”ô?',
    randomImageQ2a: 'üßë –ë—É –∫–µ–º?',
    randomImageQ2b: '‚ùì –ë—É –Ω”ô—Ä—Å”ô?',
    verbDay2: '‚ú® –ë—É–ª—É',
    verbDay3: '‚ú® –ò—è –±—É–ª—É'
  },
  COSYbashkort: {
    title: 'COSYlanguages',
    chooseLanguage: 'üåê –¢–µ–ª “ª–∞–π–ª–∞“ì—ã“ô:',
    chooseDay: 'üìÖ –ö”©–Ω “ª–∞–π–ª–∞“ì—ã“ô:',
    dayFrom: '–ë–∞—à—ã–Ω–∞–Ω',
    dayTo: '–¢–∏–∫–ª–µ–º',
    selectPractice: 'üß≠ –ü—Ä–∞–∫—Ç–∏–∫–∞ —Ç”©—Ä”©–Ω “ª–∞–π–ª–∞“ì—ã“ô:',
    vocabulary: '“∫“Ø“ô–ª–µ–∫',
    grammar: '–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞',
    speaking: '“∫”©–π–ª”ô“Ø',
    randomWord: 'üîÆ –û—Å—Ä–∞“°–ª—ã “ª“Ø“ô',
    randomImage: 'üñºÔ∏è –û—Å—Ä–∞“°–ª—ã “ª“Ø—Ä”ô—Ç',
    getPrompt: 'üé≤ “∫”©–π–ª”ô“Ø —Ç–µ–º–∞“ª—ã–Ω –∞–ª',
    gender: '‚öñÔ∏è –ï–Ω–µ—Å',
    verbs: '‚ö° –§–∏–≥—ã–ª—å–¥”ô—Ä',
    adjectives: '‚ú® –°–∏—Ñ–∞—Ç—Ç–∞—Ä',
    plurals: 'üî¢ –ö“Ø–ø–ª–µ–∫',
    pastTense: '‚è≥ “Æ—Ç–∫”ô–Ω –∑–∞–º–∞–Ω',
    futureTense: 'üîÆ –ö–∏–ª”ô—Å”ô–∫ –∑–∞–º–∞–Ω',
    selectDay: '–ö”©–Ω “ª–∞–π–ª–∞“ì—ã“ô',
    selectLang: '–¢–µ–ª “ª–∞–π–ª–∞“ì—ã“ô',
    check: '–¢–∏–∫—à–µ—Ä–µ—Ä–≥”ô',
    trySentence: '–ë—ã–ª “ª“Ø“ô“ô–µ “ª”©–π–ª”ô–º–¥”ô “°—É–ª–ª–∞–Ω—ã–ø “°–∞—Ä–∞“ì—ã“ô!',
    randomImageQ1: '‚ùì –ë—ã–ª –Ω–∏–º”ô?',
    randomImageQ2a: 'üßë –ë—ã–ª –∫–µ–º?',
    randomImageQ2b: '‚ùì –ë—ã–ª –Ω–∏–º”ô?',
    verbDay2: '‚ú® –ë—É–ª—ã—Ä“ì–∞',
    verbDay3: '‚ú® –ò—è –±—É–ª—ã—Ä“ì–∞'
  }
  // Add more languages as needed
};

function updateUIForLanguage(lang) {
  const t = translations[lang] || translations['COSYenglish'];
  document.querySelector('h1').textContent = 'COSYlanguages';
  document.querySelector('label[for="language"]').textContent = t.chooseLanguage;
  document.querySelector('label[for="day"]').textContent = t.chooseDay;
  document.querySelector('label[for="day-from"]').textContent = t.dayFrom + ':';
  document.querySelector('label[for="day-to"]').textContent = t.dayTo + ':';
  document.querySelector('.menu-section label[for="language"]').textContent = t.chooseLanguage;
  document.querySelector('.menu-section label[for="day"]').textContent = t.chooseDay;
  document.querySelector('.menu-section label[for="day-from"]').textContent = t.dayFrom + ':';
  document.querySelector('.menu-section label[for="day-to"]').textContent = t.dayTo + ':';
  document.querySelector('.menu-section label:not([for])').textContent = t.selectPractice;
  document.getElementById('vocabulary-btn').textContent = t.vocabulary;
  document.getElementById('grammar-btn').textContent = t.grammar;
  document.getElementById('speaking-btn').textContent = t.speaking;
  document.getElementById('random-word-btn').textContent = t.randomWord;
  document.getElementById('random-image-btn').textContent = t.randomImage;
  document.getElementById('speaking-practice-btn').textContent = t.getPrompt;
  // Update grammar options if visible
  if (document.getElementById('grammar-options').style.display === 'block') updateGrammarOptions();
}

// Update grammar options to use adventure translations
function updateGrammarOptions() {
  const lang = document.getElementById('language').value;
  const t = translations[lang] || translations['COSYenglish'];
  const days = getSelectedDays();
  grammarOptionsContainer.innerHTML = '';
  if (!days.length) {
    const noDayMsg = document.createElement('p');
    noDayMsg.textContent = t.selectDay;
    grammarOptionsContainer.appendChild(noDayMsg);
    return;
  }
  // Use the first day in the range to determine which grammar options to show
  const day = parseInt(days[0]);
  if (day >= 1) {
    const genderBtn = document.createElement('button');
    genderBtn.textContent = t.gender;
    genderBtn.className = 'btn-secondary btn-small';
    genderBtn.onclick = function() { practiceGrammar('gender'); };
    grammarOptionsContainer.appendChild(genderBtn);
  }
  if (day >= 2) {
    const verbBtn = document.createElement('button');
    verbBtn.textContent = t.verbs;
    verbBtn.className = 'btn-secondary btn-small';
    verbBtn.onclick = function() { practiceGrammar('verbs'); };
    grammarOptionsContainer.appendChild(verbBtn);
  }
  if (day >= 3) {
    const adjBtn = document.createElement('button');
    adjBtn.textContent = t.adjectives;
    adjBtn.className = 'btn-secondary btn-small';
    adjBtn.onclick = function() { practiceGrammar('adjectives'); };
    grammarOptionsContainer.appendChild(adjBtn);
    const pluralBtn = document.createElement('button');
    pluralBtn.textContent = t.plurals;
    pluralBtn.className = 'btn-secondary btn-small';
    pluralBtn.onclick = function() { practiceGrammar('plurals'); };
    grammarOptionsContainer.appendChild(pluralBtn);
  }
  if (day >= 5) {
    const pastBtn = document.createElement('button');
    pastBtn.textContent = t.pastTense;
    pastBtn.className = 'btn-secondary btn-small';
    pastBtn.onclick = function() { practiceGrammar('past-tense'); };
    grammarOptionsContainer.appendChild(pastBtn);
  }
  if (day >= 7) {
    const futureBtn = document.createElement('button');
    futureBtn.textContent = t.futureTense;
    futureBtn.className = 'btn-secondary btn-small';
    futureBtn.onclick = function() { practiceGrammar('future-tense'); };
    grammarOptionsContainer.appendChild(futureBtn);
  }
}

// Update UI language on language change
languageSelect.addEventListener('change', function() {
  // ...existing flag logic...
  const lang = languageSelect.value;
  // Remove any previous flag class
  document.body.className = document.body.className
    .split(' ')
    .filter(c => !c.startsWith('flag-'))
    .join(' ');
  if (lang) {
    document.body.classList.add('flag-' + lang);
  }
  updateUIForLanguage(lang);
});

// On page load, set UI to default language
updateUIForLanguage(document.getElementById('language').value || 'COSYenglish');

// Grammar practice function (gender/verbs)
async function practiceGrammar(type) {
    const language = document.getElementById('language').value;
    const days = getSelectedDays();
    const resultArea = document.getElementById('result');
    if (!language) {
        alert('Please select a language first');
        return;
    }
    if (!days.length) {
        alert('Please select a day or a range of days first');
        return;
    }
    resultArea.style.display = 'block';
    const day = days[Math.floor(Math.random() * days.length)];
    if (type === 'gender') {
        const items = await loadGenderGrammar(language, day);
        if (!items.length) {
            resultArea.innerHTML = `<p style="text-align:center;">No gender data for this day/language.</p>`;
            return;
        }
        const item = items[Math.floor(Math.random() * items.length)];
        // Determine articles for the language
        let articles = [];
        switch(language) {
            case 'COSYenglish': articles = ['he', 'she', 'it', "he/she"]; break;
            case 'COSYfran√ßais': articles = ['le', 'la', "l'", 'le/la']; break;
            case 'COSYitaliano': articles = ['il', 'la', 'lo', "l'"]; break;
            case 'COSYespa√±ol': articles = ['el', 'la', 'el/la']; break;
            case 'COSYdeutsch': articles = ['der', 'die', 'das']; break;
            case 'COSYportugu√™s': articles = ['o', 'a', 'o/a']; break;
            case '–¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π': articles = ['–æ–Ω', '–æ–Ω–∞', '–æ–Ω–æ']; break;
            case 'COSYenglish': articles = ['he', 'she', 'it', 'he/she']; break;
            case 'COSYbrezhoneg': articles = ['ar', 'an']; break;
            case 'COSYtatar√ßa': articles = ['–∏—Ä-–∞—Ç', '—Ö–∞—Ç—ã–Ω-–∫—ã–∑', '”ô–π–±–µ—Ä']; break;
            case 'COSYbashkort': articles = ['–∏—Ä-–∞—Ç', '“°–∞—Ç—ã–Ω-“°—ã“ô', '”ô–π–±–µ—Ä']; break;
            case '‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂': articles = ['’°÷Ä’°’Ø’°’∂', '’´’£’°’Ø’°’∂', '’¥’´’ª’´’∂']; break;
            case 'ŒöŒüŒñŒ•ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨': articles = ['Œø', 'Œ∑', 'œÑŒø', 'o/h']; break;
            default: articles = ['the', 'a', 'an']; break;
        }
        // Build visually appealing article buttons
        let articleOptions = articles.map((art, idx) =>
            `<button type='button' class='article-btn${idx===0 ? " selected" : ""}' data-article='${art}'>${art}</button>`
        ).join('');
        resultArea.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:160px;">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:18px;">
                    <span id="gender-word" style="font-size:2rem; font-weight:600;">${item.word}</span>
                    <button id="play-gender-pronounce-btn" class="btn-secondary" title="Hear pronunciation" style="font-size:1.5rem;">üîä</button>
                </div>
                <div id="article-options" style="margin-bottom:18px; display:flex; flex-wrap:wrap; justify-content:center; gap:8px;">${articleOptions}</div>
                <button id="check-gender-btn" class="btn-secondary" style="min-width:120px; margin-bottom:10px;">Check</button>
                <div id="gender-feedback" style="margin-top:14px;"></div>
            </div>
        `;
        // Automatic pronunciation
        pronounceWord(item.word, language);
        setTimeout(() => {
            document.getElementById('play-gender-pronounce-btn').onclick = function() {
                pronounceWord(item.word, language);
            };
            // Replace article button logic in gender practice:
            let selectedArticle = articles[0];
            const articleBtns = document.querySelectorAll('#article-options .article-btn');
            articleBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    articleBtns.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedArticle = btn.getAttribute('data-article');
                    // Immediately check answer when an article is clicked
                    let correct = false;
                    if (Array.isArray(item.article)) {
                        correct = item.article.includes(selectedArticle);
                    } else {
                        correct = selectedArticle && (selectedArticle === item.article);
                    }
                    let feedback = '';
                    if (!selectedArticle) {
                        feedback = '<span style="color:#e67e22;">Please select an article.</span>';
                    } else if (correct) {
                        feedback = '<span style="color:#27ae60;">‚úÖ Correct!</span>';
                        setTimeout(() => practiceGrammar(type), 1200);
                    } else {
                        feedback = `<span style=\"color:#e74c3c;\">‚ùå Not quite. The correct article is: <b>${Array.isArray(item.article) ? item.article.join(', ') : item.article}</b></span>`;
                    }
                    document.getElementById('gender-feedback').innerHTML = feedback;
                });
            });
            document.getElementById('check-gender-btn').onclick = function() {
                let correct = false;
                if (Array.isArray(item.article)) {
                    correct = item.article.includes(selectedArticle);
                } else {
                    correct = selectedArticle && (selectedArticle === item.article);
                }
                let feedback = '';
                if (!selectedArticle) {
                    feedback = '<span style="color:#e67e22;">Please select an article.</span>';
                } else if (correct) {
                    feedback = '<span style="color:#27ae60;">‚úÖ Correct!</span>';
                    setTimeout(() => practiceGrammar(type), 1200);
                } else {
                    feedback = `<span style=\"color:#e74c3c;\">‚ùå Not quite. The correct article is: <b>${Array.isArray(item.article) ? item.article.join(', ') : item.article}</b></span>`;
                }
                document.getElementById('gender-feedback').innerHTML = feedback;
            };
        }, 0);
        return;
    } else if (type === 'verbs') {
        const items = await loadVerbGrammar(language, day);
        if (!items.length) {
            resultArea.innerHTML = `<p style="text-align:center;">No verb data for this day/language.</p>`;
            return;
        }
        const item = items[Math.floor(Math.random() * items.length)];
        // UI: show prompt with listen button, ask for answer
        let verbPrompt = '';
        if (parseInt(day) === 2) {
            verbPrompt = `<div style=\"font-size:1.2rem; font-weight:500; color:#00bdbd; margin-bottom:8px;\">${(translations[language]||translations['COSYenglish']).verbDay2}</div>`;
        } else if (parseInt(day) === 3) {
            verbPrompt = `<div style=\"font-size:1.2rem; font-weight:500; color:#00bdbd; margin-bottom:8px;\">${(translations[language]||translations['COSYenglish']).verbDay3}</div>`;
        }
        resultArea.innerHTML = `
            ${verbPrompt}
            <div style=\"display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:160px;\">
                <div style=\"display:flex; align-items:center; gap:12px; margin-bottom:18px;\">
                    <span id=\"verb-prompt\" style=\"font-size:2rem; font-weight:600;\">${item.prompt}</span>
                    <button id=\"play-verb-pronounce-btn\" class=\"btn-secondary\" title=\"Hear pronunciation\" style=\"font-size:1.5rem;\">üîä</button>
                </div>
                <input id=\"verb-answer-input\" type=\"text\" placeholder=\"Type the answer...\" style=\"font-size:1.1rem; padding:8px 14px; border-radius:8px; border:1px solid #bbb; margin-bottom:14px; width:220px; text-align:center;\">
                <button id=\"check-verb-answer-btn\" class=\"btn-secondary\" style=\"margin-bottom:18px; min-width:120px;\">Check</button>
                <div id=\"verb-answer-feedback\" style=\"margin-top:10px;\"></div>
            </div>
        `;
        // Automatic pronunciation
        pronounceWord(item.prompt, language);
        setTimeout(() => {
            document.getElementById('play-verb-pronounce-btn').onclick = function() {
                pronounceWord(item.prompt, language);
            };
            document.getElementById('check-verb-answer-btn').onclick = function() {
                const userInput = document.getElementById('verb-answer-input').value.trim().toLowerCase();
                const correct = item.answer.trim().toLowerCase();
                let feedback = '';
                if (!userInput) {
                    feedback = '<span style="color:#e67e22;">Please type your answer above.</span>';
                } else if (userInput === correct) {
                    feedback = '<span style="color:#27ae60;">‚úÖ Correct!</span>';
                    setTimeout(() => practiceGrammar(type), 1200);
                } else if (userInput && correct && (userInput.includes(correct) || correct.includes(userInput))) {
                    feedback = '<span style="color:#f1c40f;">üü° Almost! Check your spelling.</span>';
                } else {
                    feedback = `<span style=\"color:#e74c3c;\">‚ùå Not quite. The correct answer is: <b>${item.answer}</b></span>`;
                }
                document.getElementById('verb-answer-feedback').innerHTML = feedback;
            };
            // Add Enter key support for verb answer
            addEnterKeySupport('verb-answer-input', 'check-verb-answer-btn');
        }, 0);
        return;
    }
}

// Helper: get selected days (single or range)
function getSelectedDays() {
    const day = document.getElementById('day').value;
    const dayFrom = document.getElementById('day-from').value;
    const dayTo = document.getElementById('day-to').value;
    if (day) {
        return [day];
    } else if (dayFrom && dayTo && Number(dayFrom) <= Number(dayTo)) {
        const from = Number(dayFrom);
        const to = Number(dayTo);
        const days = [];
        for (let i = from; i <= to; i++) days.push(String(i));
        return days;
    } else {
        return [];
    }
}

// --- Remember language and day selection using localStorage ---
function saveUserSelection() {
    localStorage.setItem('cosy_language', document.getElementById('language').value);
    localStorage.setItem('cosy_day', document.getElementById('day').value);
}
function restoreUserSelection() {
    const savedLang = localStorage.getItem('cosy_language');
    const savedDay = localStorage.getItem('cosy_day');
    if (savedLang) {
        document.getElementById('language').value = savedLang;
        // Trigger change event to update UI/flag
        document.getElementById('language').dispatchEvent(new Event('change'));
       }
    if (savedDay) {
        document.getElementById('day').value = savedDay;
        // Optionally trigger change event if needed
        document.getElementById('day').dispatchEvent(new Event('change'));
    }
}
// Attach save on change
if (document.getElementById('language')) {
    document.getElementById('language').addEventListener('change', saveUserSelection);
}
if (document.getElementById('day')) {
    document.getElementById('day').addEventListener('change', saveUserSelection);
}
// Restore on page load
window.addEventListener('DOMContentLoaded', restoreUserSelection);
    </script>
</body>
</html>