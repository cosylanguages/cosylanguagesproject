<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSYlanguages</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00bdbd">
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('service-worker.js');
        });
      }
    </script>
</head>
<body>
    <div class="container">
        <h1>COSYlanguages</h1>
        
        <div class="menu-section">
            <label for="language">Choose Language:</label>
            <select id="language">
                <option value="">Select a language</option>
                <option value="COSYenglish" data-bg="COSYenglish">COSYenglish</option>
                <option value="COSYfrançais" data-bg="COSYfrançais">COSYfrançais</option>
                <option value="COSYitaliano" data-bg="COSYitaliano">COSYitaliano</option>
                <option value="COSYespañol" data-bg="COSYespañol">COSYespañol</option>
                <option value="COSYportuguês" data-bg="COSYportuguês">COSYportuguês</option>
                <option value="COSYdeutsch" data-bg="COSYdeutsch">COSYdeutsch</option>
                <option value="ΚΟΖΥελληνικά" data-bg="ΚΟΖΥελληνικά">ΚΟΖΥελληνικά</option>
                <option value="ТАКОЙрусский" data-bg="ТАКОЙрусский">ТАКОЙрусский</option>
                <option value="ԾՈՍՅհայկական" data-bg="ԾՈՍՅհայկական">ԾՈՍՅհայկական</option>
                <option value="COSYbrezhoneg" data-bg="COSYbrezhoneg">COSYbrezhoneg</option>
                <option value="COSYtatarça" data-bg="COSYtatarça">COSYtatarça</option>
                <option value="COSYbashkort" data-bg="COSYbashkort">COSYbashkort</option>
            </select>
        </div>
        
        <div class="menu-section">
            <label for="day">Choose Day:</label>
            <select id="day">
                <option value="">Select a day</option>
                <!-- Days will be populated by JavaScript -->
            </select>
            
            <div class="day-range">
                <div>
                    <label for="day-from">Day From:</label>
                    <select id="day-from">
                        <option value="">From</option>
                    </select>
                </div>
                <div>
                    <label for="day-to">Day To:</label>
                    <select id="day-to">
                        <option value="">To</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="menu-section">
            <label>Select Practice Type:</label>
            <div class="practice-types">
                <button id="vocabulary-btn" class="btn-primary">Vocabulary</button>
                <button id="grammar-btn" class="btn-primary">Grammar</button>
                <button id="speaking-btn" class="btn-primary">Speaking</button>
            </div>
            
            <div id="vocabulary-options" class="practice-options">
                <div class="vocabulary-options">
                    <button id="random-word-btn" class="btn-secondary">Random Word</button>
                    <button id="random-image-btn" class="btn-secondary">Random Image</button>
                </div>
            </div>
            
            <div id="grammar-options" class="practice-options">
                <div class="grammar-options">
                    <!-- Grammar buttons will be populated by JavaScript -->
                </div>
            </div>
            
            <div id="speaking-options" class="practice-options">
                <button id="speaking-practice-btn" class="btn-primary">Get Speaking Prompt</button>
            </div>
        </div>
        
        <div id="result" class="result-area"></div>
    </div>

    <script>
        // Populate days dropdown (1-30)
        const daySelect = document.getElementById('day');
        const dayFromSelect = document.getElementById('day-from');
        const dayToSelect = document.getElementById('day-to');
        
        for (let i = 1; i <= 30; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Day ${i}`;
            daySelect.appendChild(option.cloneNode(true));
            dayFromSelect.appendChild(option.cloneNode(true));
            dayToSelect.appendChild(option.cloneNode(true));
        }
        
        // Practice type buttons
        const vocabularyBtn = document.getElementById('vocabulary-btn');
        const grammarBtn = document.getElementById('grammar-btn');
        const speakingBtn = document.getElementById('speaking-btn');
        
        const vocabularyOptions = document.getElementById('vocabulary-options');
        const grammarOptions = document.getElementById('grammar-options');
        const grammarOptionsContainer = grammarOptions.querySelector('.grammar-options');
        const speakingOptions = document.getElementById('speaking-options');
        
        // Hide all options initially
        vocabularyOptions.style.display = 'none';
        grammarOptions.style.display = 'none';
        speakingOptions.style.display = 'none';
        
        // Vocabulary button click
        vocabularyBtn.addEventListener('click', function() {
            // Reset all buttons
            vocabularyBtn.classList.add('btn-primary');
            vocabularyBtn.classList.remove('btn-secondary');
            grammarBtn.classList.add('btn-primary');
            grammarBtn.classList.remove('btn-secondary');
            speakingBtn.classList.add('btn-primary');
            speakingBtn.classList.remove('btn-secondary');
            
            // Toggle vocabulary options
            vocabularyOptions.style.display = vocabularyOptions.style.display === 'none' ? 'block' : 'none';
            grammarOptions.style.display = 'none';
            speakingOptions.style.display = 'none';
            
            // Style the active button
            vocabularyBtn.classList.remove('btn-primary');
            vocabularyBtn.classList.add('btn-secondary');
        });
        
        // Grammar button click
        grammarBtn.addEventListener('click', function() {
            // Reset all buttons
            vocabularyBtn.classList.add('btn-primary');
            vocabularyBtn.classList.remove('btn-secondary');
            grammarBtn.classList.add('btn-primary');
            grammarBtn.classList.remove('btn-secondary');
            speakingBtn.classList.add('btn-primary');
            speakingBtn.classList.remove('btn-secondary');
            
            // Update grammar options based on day
            updateGrammarOptions();
            
            // Toggle grammar options
            grammarOptions.style.display = grammarOptions.style.display === 'none' ? 'block' : 'none';
            vocabularyOptions.style.display = 'none';
            speakingOptions.style.display = 'none';
            
            // Style the active button
            grammarBtn.classList.remove('btn-primary');
            grammarBtn.classList.add('btn-secondary');
        });
        
        // Speaking button click
        speakingBtn.addEventListener('click', function() {
            // Reset all buttons
            vocabularyBtn.classList.add('btn-primary');
            vocabularyBtn.classList.remove('btn-secondary');
            grammarBtn.classList.add('btn-primary');
            grammarBtn.classList.remove('btn-secondary');
            speakingBtn.classList.add('btn-primary');
            speakingBtn.classList.remove('btn-secondary');
            
            // Toggle speaking options
            speakingOptions.style.display = speakingOptions.style.display === 'none' ? 'block' : 'none';
            vocabularyOptions.style.display = 'none';
            grammarOptions.style.display = 'none';
            
            // Style the active button
            speakingBtn.classList.remove('btn-primary');
            speakingBtn.classList.add('btn-secondary');
        });
        
        // Update grammar options based on selected day
        function updateGrammarOptions() {
            const day = parseInt(daySelect.value);
            
            // Clear existing options
            grammarOptionsContainer.innerHTML = '';
            
            if (!day) {
                const noDayMsg = document.createElement('p');
                noDayMsg.textContent = 'Please select a day first';
                grammarOptionsContainer.appendChild(noDayMsg);
                return;
            }
            
            // Add options based on day
            if (day >= 1) {
                const genderBtn = document.createElement('button');
                genderBtn.textContent = 'Gender';
                genderBtn.className = 'btn-secondary btn-small';
                genderBtn.onclick = function() { practiceGrammar('gender'); };
                grammarOptionsContainer.appendChild(genderBtn);
            }
            
            if (day >= 2) {
                const verbBtn = document.createElement('button');
                verbBtn.textContent = 'Verbs';
                verbBtn.className = 'btn-secondary btn-small';
                verbBtn.onclick = function() { practiceGrammar('verbs'); };
                grammarOptionsContainer.appendChild(verbBtn);
            }
            
            if (day >= 3) {
                const adjBtn = document.createElement('button');
                adjBtn.textContent = 'Adjectives';
                adjBtn.className = 'btn-secondary btn-small';
                adjBtn.onclick = function() { practiceGrammar('adjectives'); };
                grammarOptionsContainer.appendChild(adjBtn);
                
                const pluralBtn = document.createElement('button');
                pluralBtn.textContent = 'Plurals';
                pluralBtn.className = 'btn-secondary btn-small';
                pluralBtn.onclick = function() { practiceGrammar('plurals'); };
                grammarOptionsContainer.appendChild(pluralBtn);
            }
            
            if (day >= 5) {
                const pastBtn = document.createElement('button');
                pastBtn.textContent = 'Past Tense';
                pastBtn.className = 'btn-secondary btn-small';
                pastBtn.onclick = function() { practiceGrammar('past-tense'); };
                grammarOptionsContainer.appendChild(pastBtn);
            }
            
            if (day >= 7) {
                const futureBtn = document.createElement('button');
                futureBtn.textContent = 'Future Tense';
                futureBtn.className = 'btn-secondary btn-small';
                futureBtn.onclick = function() { practiceGrammar('future-tense'); };
                grammarOptionsContainer.appendChild(futureBtn);
            }
        }
        
        // Update grammar options when day changes
        daySelect.addEventListener('change', function() {
            if (grammarOptions.style.display === 'block') {
                updateGrammarOptions();
            }
        });
        
        // Helper: map language select value to vocabulary file
        function getVocabularyFile(language) {
            switch(language) {
                case 'COSYenglish': return 'vocabulary/words/vocabulary_english.json';
                case 'COSYfrançais': return 'vocabulary/words/vocabulary_french.json';
                case 'COSYespañol': return 'vocabulary/words/vocabulary_spanish.json';
                case 'COSYitaliano': return 'vocabulary/words/vocabulary_italian.json';
                case 'COSYdeutsch': return 'vocabulary/words/vocabulary_german.json';
                case 'COSYportuguês': return 'vocabulary/words/vocabulary_portuguese.json';
                case 'ТАКОЙрусский': return 'vocabulary/words/vocabulary_russian.json';
                case 'COSYbrezhoneg': return 'vocabulary/words/vocabulary_breton.json';
                case 'COSYtatarça': return 'vocabulary/words/vocabulary_tatar.json';
                case 'COSYbashkort': return 'vocabulary/words/vocabulary_bashkir.json';
                case 'ԾՈՍՅհայկական': return 'vocabulary/words/vocabulary_armenian.json';
                default: return null;
            }
        }

        // New: Load vocabulary for selected language and day
        async function loadVocabulary(language, day) {
            const file = getVocabularyFile(language);
            if (!file) return [];
            try {
                const response = await fetch(file);
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // Load random image data for a given day
        async function loadImageVocabulary(day) {
            try {
                const response = await fetch('vocabulary/images/vocabulary_images.json');
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // --- Pronunciation: play word using SpeechSynthesis API, with mobile support ---
        function pronounceWord(word, language) {
            let langCode = 'en-US';
            switch(language) {
                case 'COSYenglish': langCode = 'en-UK'; break;
                case 'COSYfrançais': langCode = 'fr-FR'; break;
                case 'COSYespañol': langCode = 'es-ES'; break;
                case 'COSYitaliano': langCode = 'it-IT'; break;
                case 'COSYdeutsch': langCode = 'de-DE'; break;
                case 'COSYportuguês': langCode = 'pt-PT'; break;
                case 'ТАКОЙрусский': langCode = 'ru-RU'; break;
                case 'COSYbrezhoneg': langCode = 'br-FR'; break;
                case 'COSYtatarça': langCode = 'tt-RU'; break;
                case 'COSYbashkort': langCode = 'ba-RU'; break;
                case 'ԾՈՍՅհայկական': langCode = 'hy-AM'; break;
                default: langCode = 'en-UK';
            }
            // iOS/Android: require user gesture, so always call from a button or setTimeout after interaction
            if ('speechSynthesis' in window) {
                // Stop any current speech
                window.speechSynthesis.cancel();
                // Some mobile browsers need a short delay
                setTimeout(() => {
                    const utter = new SpeechSynthesisUtterance(word);
                    utter.lang = langCode;
                    utter.rate = 1;
                    utter.pitch = 1;
                    window.speechSynthesis.speak(utter);
                }, 100);
            } else {
                alert('Sorry, speech synthesis is not supported on this device/browser.');
            }
        }
        // --- Unlock audio context for iOS/Android on first user gesture ---
        (function unlockAudio() {
            function unlock() {
                if (window.speechSynthesis && window.speechSynthesis.speak) {
                    try {
                        const u = new SpeechSynthesisUtterance(' ');
                        window.speechSynthesis.speak(u);
                    } catch(e) {}
                }
                window.removeEventListener('touchstart', unlock, false);
                window.removeEventListener('click', unlock, false);
            }
            window.addEventListener('touchstart', unlock, false);
            window.addEventListener('click', unlock, false);
        })();
        
        // Pronunciation check: record and compare
        let recognition;
        function startPronunciationCheck(targetWord, language) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition is not supported in this browser.');
                return;
            }
            // Stop previous recognition if running
            if (recognition && recognition.stop) {
                try { recognition.onresult = null; recognition.onerror = null; recognition.onend = null; recognition.stop(); } catch(e) {}
            }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = (function(lang) {
                switch(lang) {
                    case 'COSYenglish': return 'en-UK';
                    case 'COSYfrançais': return 'fr-FR';
                    case 'COSYespañol': return 'es-ES';
                    case 'COSYitaliano': return 'it-IT';
                    case 'COSYdeutsch': return 'de-DE';
                    case 'COSYportuguês': return 'pt-PT';
                    case 'ТАКОЙрусский': return 'ru-RU';
                    case 'COSYbrezhoneg': return 'br-FR';
                    case 'COSYtatarça': return 'tt-RU';
                    case 'COSYbashkort': return 'ba-RU';
                    case 'ԾՈՍՅհայկական': return 'hy-AM';
                    default: return 'en-UK';
                }
            })(language);
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.onresult = function(event) {
                const userSaid = event.results[0][0].transcript.trim().toLowerCase();
                const target = targetWord.trim().toLowerCase();
                // Simple similarity: check if user said word is contained or similar
                let similarity = 0;
                if (userSaid === target) {
                    similarity = 1;
                } else if (userSaid.includes(target) || target.includes(userSaid)) {
                    similarity = 0.8;
                } else {
                    // Levenshtein distance (basic)
                    function lev(a, b) {
                        const matrix = [];
                        for (let i = 0; i <= b.length; i++) matrix[i] = [i];
                        for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
                        for (let i = 1; i <= b.length; i++) {
                            for (let j = 1; j <= a.length; j++) {
                                if (b.charAt(i-1) === a.charAt(j-1)) {
                                    matrix[i][j] = matrix[i-1][j-1];
                                } else {
                                    matrix[i][j] = Math.min(
                                        matrix[i-1][j-1] + 1,
                                        matrix[i][j-1] + 1,
                                        matrix[i-1][j] + 1
                                    );
                                }
                            }
                        }
                        return matrix[b.length][a.length];
                    }
                    const dist = lev(userSaid, target);
                    similarity = 1 - dist / Math.max(target.length, userSaid.length);
                }
                let feedback = '';
                if (similarity > 0.7) {
                    feedback = '✅ Good job! Your pronunciation is close enough.';
                } else if (similarity > 0.4) {
                    feedback = '🟡 Not bad! Try again for a closer pronunciation.';
                } else {
                    feedback = '🔴 Keep practicing! Try to say the word more clearly.';
                }
                document.getElementById('pronunciation-feedback').innerHTML =
                    `<p><strong>You said:</strong> ${userSaid}</p><p>${feedback}</p>`;
            };
            recognition.onerror = function(event) {
                document.getElementById('pronunciation-feedback').innerHTML =
                    `<p style='color:red;'>Error: ${event.error}</p>`;
                // Always stop on error to avoid stuck state
                try { recognition.stop(); } catch(e) {}
            };
            recognition.onend = function() {
                // Optionally, you can re-enable the button or give UI feedback here
            };
            recognition.start();
            document.getElementById('pronunciation-feedback').innerHTML = '<p>Listening...</p>';
        }

        // Vocabulary practice function (random word from file)
        async function practiceVocabulary(type) {
            const language = document.getElementById('language').value;
            const day = document.getElementById('day').value;
            const resultArea = document.getElementById('result');
            if (!language) {
                alert('Please select a language first');
                return;
            }
            if (!day) {
                alert('Please select a day first');
                return;
            }
            resultArea.style.display = 'block';
            if (type === 'random-word') {
                const words = await loadVocabulary(language, day);
                if (!words.length) {
                    resultArea.innerHTML = `<p style="text-align:center;">No vocabulary found for this day.</p>`;
                    return;
                }
                const word = words[Math.floor(Math.random() * words.length)];
                // Modern, centered, minimal UI for random word
                resultArea.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:180px;">
                        <div id="vocab-word" style="font-size:2.2rem; font-weight:600; margin-bottom:18px; text-align:center;">${word}</div>
                        <div style="display:flex; gap:24px; justify-content:center; align-items:center;">
                            <button id="play-pronounce-btn" class="btn-secondary" title="Hear pronunciation" style="font-size:2rem;">🔊</button>
                            <button id="check-pronounce-btn" class="btn-secondary" title="Check your pronunciation" style="font-size:2rem;">🎤</button>
                        </div>
                        <div id="pronunciation-feedback" style="margin-top:18px;"></div>
                    </div>
                `;
                // Automatic pronunciation
                pronounceWord(word, language);
                setTimeout(() => {
                    document.getElementById('play-pronounce-btn').onclick = function() {
                        pronounceWord(word, language);
                    };
                    document.getElementById('check-pronounce-btn').onclick = function() {
                        startPronunciationCheck(word, language);
                    };
                }, 0);
                return;
            } else if (type === 'random-image') {
                const images = await loadImageVocabulary(day);
                if (!images.length) {
                    resultArea.innerHTML = `<p style="text-align:center;">No images found for this day.</p>`;
                    return;
                }
                const item = images[Math.floor(Math.random() * images.length)];
                const answer = item.translations[language] || '[No translation]';
                // Modern, centered, minimal UI for random image
                resultArea.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:220px;">
                        <img src="${item.src}" alt="${item.alt}" class="vocabulary-image" style="max-width:180px; max-height:180px; margin-bottom:18px; border-radius:16px; box-shadow:0 2px 12px rgba(0,0,0,0.10);">
                        <input id="image-answer-input" type="text" placeholder="Type your answer..." style="font-size:1.1rem; padding:8px 14px; border-radius:8px; border:1px solid #bbb; margin-bottom:14px; width:220px; text-align:center;">
                        <button id="check-image-answer-btn" class="btn-secondary" style="margin-bottom:18px; min-width:120px;">Check</button>
                        <div style="display:flex; gap:24px; justify-content:center; align-items:center; margin-bottom:0;">
                            <button id="play-pronounce-btn" class="btn-secondary" title="Hear pronunciation" style="font-size:2rem;">🔊</button>
                            <button id="check-pronounce-btn" class="btn-secondary" title="Check your pronunciation" style="font-size:2rem;">🎤</button>
                        </div>
                        <div id="pronunciation-feedback" style="margin-top:18px;"></div>
                        <div id="image-answer-feedback" style="margin-top:10px;"></div>
                    </div>
                `;
                setTimeout(() => {
                    document.getElementById('play-pronounce-btn').onclick = function() {
                        pronounceWord(answer, language);
                    };
                    document.getElementById('check-pronounce-btn').onclick = function() {
                        startPronunciationCheck(answer, language);
                    };
                    document.getElementById('check-image-answer-btn').onclick = function() {
                        const userInput = document.getElementById('image-answer-input').value.trim().toLowerCase();
                        const correct = answer.trim().toLowerCase();
                        let feedback = '';
                        if (!userInput) {
                            feedback = '<span style="color:#e67e22;">Please type your answer above.</span>';
                        } else if (userInput === correct) {
                            feedback = '<span style="color:#27ae60;">✅ Correct!</span>';
                        } else if (userInput && correct && (userInput.includes(correct) || correct.includes(userInput))) {
                            feedback = '<span style="color:#f1c40f;">🟡 Almost! Check your spelling.</span>';
                        } else {
                            feedback = `<span style=\"color:#e74c3c;\">❌ Not quite. The correct answer is: <b>${answer}</b></span>`;
                        }
                        document.getElementById('image-answer-feedback').innerHTML = feedback;
                    };
                    // Add Enter key support for image answer
                    addEnterKeySupport('image-answer-input', 'check-image-answer-btn');
                }, 0);
                return;
            }
        }
        
        // Load gender grammar data for a given language and day
        async function loadGenderGrammar(language, day) {
            const fileMap = {
                'COSYenglish': 'grammar/gender/grammar_gender_english.json',
                'COSYitaliano': 'grammar/gender/grammar_gender_italian.json',
                'COSYfrançais': 'grammar/gender/grammar_gender_french.json',
                'COSYespañol': 'grammar/gender/grammar_gender_spanish.json',
                'COSYdeutsch': 'grammar/gender/grammar_gender_german.json',
                'COSYportuguês': 'grammar/gender/grammar_gender_portuguese.json',
                'ТАКОЙрусский': 'grammar/gender/grammar_gender_russian.json',
                'COSYbrezhoneg': 'grammar/gender/grammar_gender_breton.json',
                'COSYtatarça': 'grammar/gender/grammar_gender_tatar.json',
                'COSYbashkort': 'grammar/gender/grammar_gender_bashkir.json',
                'ԾՈՍՅհայկական': 'grammar/gender/grammar_gender_armenian.json',
                'ΚΟΖΥελληνικά': 'grammar/gender/grammar_gender_greek.json'
            };
            const file = fileMap[language];
            if (!file) return [];
            try {
                const response = await fetch(file);
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // Load verb grammar data for a given language and day
        async function loadVerbGrammar(language, day) {
            const fileMap = {
                'COSYenglish': 'grammar/verbs/grammar_verbs_english.json',
                'COSYitaliano': 'grammar/verbs/grammar_verbs_italian.json',
                'COSYfrançais': 'grammar/verbs/grammar_verbs_french.json',
                'COSYespañol': 'grammar/verbs/grammar_verbs_spanish.json',
                'COSYdeutsch': 'grammar/verbs/grammar_verbs_german.json',
                'COSYportuguês': 'grammar/verbs/grammar_verbs_portuguese.json',
                'ΚΟΖΥελληνικά': 'grammar/verbs/grammar_verbs_greek.json'
            };
            const file = fileMap[language];
            if (!file) return [];
            try {
                const response = await fetch(file);
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // Update all fetch paths in scripts to use the new folder structure: vocabulary/, grammar/, speaking/. For example, fetch('vocabulary/vocabulary_english.json'), fetch('grammar/grammar_gender_french.json'), fetch('speaking/speaking_french.json'), etc.
        async function loadSpeakingPrompts(language, day) {
            const fileMap = {
                'COSYenglish': 'speaking/prompts/speaking_english.json',
                'COSYfrançais': 'speaking/prompts/speaking_french.json',
                'COSYespañol': 'speaking/prompts/speaking_spanish.json',
                'COSYitaliano': 'speaking/prompts/speaking_italian.json',
                'COSYdeutsch': 'speaking/prompts/speaking_german.json',
                'COSYportuguês': 'speaking/prompts/speaking_portuguese.json',
                'ΚΟΖΥελληνικά': 'speaking/prompts/speaking_greek.json',
                'COSYbrezhoneg': 'speaking/prompts/speaking_breton.json',
                'ТАКОЙрусский': 'speaking/prompts/speaking_russian.json',
                'ԾՈՍՅհայկական': 'speaking/prompts/speaking_armenian.json',
                'COSYtatarça': 'speaking/prompts/speaking_tatar.json',
                'COSYbashkort': 'speaking/prompts/speaking_bashkir.json'
            };
            const file = fileMap[language];
            if (!file) return [];
            try {
                const response = await fetch(file);
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // Speaking practice function
        async function practiceSpeaking() {
            const language = document.getElementById('language').value;
            const day = document.getElementById('day').value;
            const resultArea = document.getElementById('result');
            if (!language || !day) {
                alert('Please select language and day first');
                return;
            }
            resultArea.style.display = 'block';
            const prompts = await loadSpeakingPrompts(language, day);
            if (!prompts.length) {
                resultArea.innerHTML = `<h3>Speaking Practice</h3><p>No prompts found for this day/language.</p>`;
                return;
            }
            const prompt = prompts[Math.floor(Math.random() * prompts.length)];
            resultArea.innerHTML = `
                <h3>Speaking Practice</h3>
                <div style="font-size:1.3rem; margin:20px 0;">${prompt}</div>
                <button id="start-record-btn" class="btn-secondary">🎤 Record & Check</button>
                <div id="speaking-feedback" style="margin-top:16px;"></div>
            `;
            setTimeout(() => {
                document.getElementById('start-record-btn').onclick = function() {
                    startSpeakingCheck(prompt, language);
                };
            }, 0);
        }

        // Accent-tolerant speaking check: does user say any word from the prompt?
        function startSpeakingCheck(prompt, language) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition is not supported in this browser.');
                return;
            }
            if (recognition && recognition.stop) {
                try { recognition.onresult = null; recognition.onerror = null; recognition.onend = null; recognition.stop(); } catch(e) {}
            }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = (function(lang) {
                switch(lang) {
                    case 'COSYenglish': return 'en-US';
                    case 'COSYfrançais': return 'fr-FR';
                    case 'COSYespañol': return 'es-ES';
                    case 'COSYitaliano': return 'it-IT';
                    case 'COSYdeutsch': return 'de-DE';
                    case 'COSYportuguês': return 'pt-PT';
                    default: return 'en-US';
                }
            })(language);
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.onresult = function(event) {
                const userSaid = event.results[0][0].transcript.trim().toLowerCase();
                // Check if any word from the prompt is in the user's speech (accent-tolerant)
                const promptWords = prompt.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
                const userWords = userSaid.split(/\s+/);
                let match = false;
                for (let w of promptWords) {
                    if (w.length > 2 && userWords.some(u => u.includes(w) || w.includes(u))) {
                        match = true;
                        break;
                    }
                }
                let feedback = '';
                if (match) {
                    feedback = '✅ Good job! Your answer contains words from the prompt.';
                } else {
                    feedback = '🟡 Not bad! Try to include more words from the prompt.';
                }
                document.getElementById('speaking-feedback').innerHTML =
                    `<p><strong>You said:</strong> ${userSaid}</p><p>${feedback}</p>`;
            };
            recognition.onerror = function(event) {
                document.getElementById('speaking-feedback').innerHTML =
                    `<p style='color:red;'>Error: ${event.error}</p>`;
                try { recognition.stop(); } catch(e) {}
            };
            recognition.onend = function() {};
            recognition.start();
            document.getElementById('speaking-feedback').innerHTML = '<p>Listening...</p>';
        }

        // Change background flag on language select
        const languageSelect = document.getElementById('language');
        languageSelect.addEventListener('change', function() {
            const lang = languageSelect.value;
            // Remove any previous flag class
            document.body.className = document.body.className
                .split(' ') // split classes
                .filter(c => !c.startsWith('flag-')) // remove flag- classes
                .join(' ');
            if (lang) {
                document.body.classList.add('flag-' + lang);
            }
        });
        
        // Speaking practice button
        document.getElementById('speaking-practice-btn').addEventListener('click', function() {
            practiceSpeaking();
        });
        
        document.getElementById('random-word-btn').addEventListener('click', function() {
            practiceVocabulary('random-word');
        });
        document.getElementById('random-image-btn').addEventListener('click', function() {
            practiceVocabulary('random-image');
        });
        
        // Add Enter key support for practice check buttons
        function addEnterKeySupport(inputId, checkBtnId) {
            const input = document.getElementById(inputId);
            const checkBtn = document.getElementById(checkBtnId);
            if (input && checkBtn) {
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        checkBtn.click();
                    }
                });
            }
        }

        // Adventure-style translations for UI
        const translations = {
  COSYenglish: {
    title: 'COSYlanguages',
    chooseLanguage: '🌐 Choose Your Language:',
    chooseDay: '📅 Choose Your Day:',
    dayFrom: 'From',
    dayTo: 'To',
    selectPractice: '🧭 Choose Your Practice:',
    vocabulary: 'Vocabulary',
    grammar: 'Grammar',
    speaking: 'Speaking',
    randomWord: '🔮 Random Word',
    randomImage: '🖼️ Random Image',
    getPrompt: '🎲 Get Speaking Prompt',
    gender: '⚖️ Gender',
    verbs: '⚡ Verbs',
    adjectives: '✨ Adjectives',
    plurals: '🔢 Plurals',
    pastTense: '⏳ Past Tense',
    futureTense: '🔮 Future Tense',
    selectDay: 'Select a day',
    selectLang: 'Select a language',
    check: 'Check',
    trySentence: 'Try to use this word in a sentence!'
  },
  COSYitaliano: {
    title: 'COSYlanguages',
    chooseLanguage: '🌐 Scegli la lingua:',
    chooseDay: '📅 Scegli il giorno:',
    dayFrom: 'Da',
    dayTo: 'A',
    selectPractice: '🧭 Scegli la pratica:',
    vocabulary: 'Vocabolario',
    grammar: 'Grammatica',
    speaking: 'Conversazione',
    randomWord: '🔮 Parola Casuale',
    randomImage: '🖼️ Immagine Casuale',
    getPrompt: '🎲 Ottieni Spunto Orale',
    gender: '⚖️ Genere',
    verbs: '⚡ Verbi',
    adjectives: '✨ Aggettivi',
    plurals: '🔢 Plurali',
    pastTense: '⏳ Passato',
    futureTense: '🔮 Futuro',
    selectDay: 'Scegli un giorno',
    selectLang: 'Scegli una lingua',
    check: 'Controlla',
    trySentence: 'Prova a usare questa parola in una frase!'
  },
  COSYfrançais: {
    title: 'COSYlanguages',
    chooseLanguage: '🌐 Choisis ta langue :',
    chooseDay: '📅 Choisis le jour :',
    dayFrom: 'De',
    dayTo: 'À',
    selectPractice: '🧭 Choisis ta pratique :',
    vocabulary: 'Vocabulaire',
    grammar: 'Grammaire',
    speaking: 'Conversation',
    randomWord: '🔮 Mot Aléatoire',
    randomImage: '🖼️ Image Aléatoire',
    getPrompt: '🎲 Obtenir un Sujet Oral',
    gender: '⚖️ Genre',
    verbs: '⚡ Verbes',
    adjectives: '✨ Adjectifs',
    plurals: '🔢 Pluriels',
    pastTense: '⏳ Passé',
    futureTense: '🔮 Futur',
    selectDay: 'Choisis un jour',
    selectLang: 'Choisis une langue',
    check: 'Vérifier',
    trySentence: 'Essaie d’utiliser ce mot dans une phrase !'
  },
  COSYespañol: {
    title: 'COSYlanguages',
    chooseLanguage: '🌐 Elige tu idioma:',
    chooseDay: '📅 Elige el día:',
    dayFrom: 'De',
    dayTo: 'A',
    selectPractice: '🧭 Elige tu práctica:',
    vocabulary: 'Vocabulario',
    grammar: 'Gramática',
    speaking: 'Conversación',
    randomWord: '🔮 Palabra Aleatoria',
    randomImage: '🖼️ Imagen Aleatoria',
    getPrompt: '🎲 Obtener Tema Oral',
    gender: '⚖️ Género',
    verbs: '⚡ Verbos',
    adjectives: '✨ Adjetivos',
    plurals: '🔢 Plurales',
    pastTense: '⏳ Pasado',
    futureTense: '🔮 Futuro',
    selectDay: 'Elige un día',
    selectLang: 'Elige un idioma',
    check: 'Comprobar',
    trySentence: '¡Intenta usar esta palabra en una frase!'
  },
  COSYdeutsch: {
    title: 'COSYlanguages',
    chooseLanguage: '🌐 Wähle deine Sprache:',
    chooseDay: '📅 Wähle den Tag:',
    dayFrom: 'Von',
    dayTo: 'Bis',
    selectPractice: '🧭 Wähle deine Übung:',
    vocabulary: 'Vokabular',
    grammar: 'Grammatik',
    speaking: 'Sprechen',
    randomWord: '🔮 Zufallswort',
    randomImage: '🖼️ Zufallsbild',
    getPrompt: '🎲 Sprech-Aufgabe',
    gender: '⚖️ Genus',
    verbs: '⚡ Verben',
    adjectives: '✨ Adjektive',
    plurals: '🔢 Plural',
    pastTense: '⏳ Vergangenheit',
    futureTense: '🔮 Zukunft',
    selectDay: 'Wähle einen Tag',
    selectLang: 'Wähle eine Sprache',
    check: 'Prüfen',
    trySentence: 'Versuche, dieses Wort in einem Satz zu verwenden!'
  },
  COSYportuguês: {
    title: 'COSYlanguages',
    chooseLanguage: '🌐 Escolha o idioma:',
    chooseDay: '📅 Escolha o dia:',
    dayFrom: 'De',
    dayTo: 'Até',
    selectPractice: '🧭 Escolha sua prática:',
    vocabulary: 'Vocabulário',
    grammar: 'Gramática',
    speaking: 'Conversação',
    randomWord: '🔮 Palavra Aleatória',
    randomImage: '🖼️ Imagem Aleatória',
    getPrompt: '🎲 Obter Tema Oral',
    gender: '⚖️ Gênero',
    verbs: '⚡ Verbos',
    adjectives: '✨ Adjetivos',
    plurals: '🔢 Plurais',
    pastTense: '⏳ Passado',
    futureTense: '🔮 Futuro',
    selectDay: 'Escolha um dia',
    selectLang: 'Escolha um idioma',
    check: 'Verificar',
    trySentence: 'Tente usar esta palavra em uma frase!'
  },
  ΚΟΖΥελληνικά: {
    title: 'COSYlanguages',
    chooseLanguage: '🌐 Επίλεξε γλώσσα:',
    chooseDay: '📅 Επίλεξε ημέρα:',
    dayFrom: 'Από',
    dayTo: 'Έως',
    selectPractice: '🧭 Επίλεξε πρακτική:',
    vocabulary: 'Λεξιλόγιο',
    grammar: 'Γραμματική',
    speaking: 'Ομιλία',
    randomWord: '🔮 Τυχαία Λέξη',
    randomImage: '🖼️ Τυχαία Εικόνα',
    getPrompt: '🎲 Πάρε Θέμα Ομιλίας',
    gender: '⚖️ Γένος',
    verbs: '⚡ Ρήματα',
    adjectives: '✨ Επίθετα',
    plurals: '🔢 Πληθυντικός',
    pastTense: '⏳ Παρελθόν',
    futureTense: '🔮 Μέλλον',
    selectDay: 'Επίλεξε ημέρα',
    selectLang: 'Επίλεξε γλώσσα',
    check: 'Έλεγχος',
    trySentence: 'Δοκίμασε να χρησιμοποιήσεις αυτή τη λέξη σε μια πρόταση!'
  },
  ТАКОЙрусский: {
    title: 'COSYlanguages',
    chooseLanguage: '🌐 Выбери язык:',
    chooseDay: '📅 Выбери день:',
    dayFrom: 'С',
    dayTo: 'По',
    selectPractice: '🧭 Выбери практику:',
    vocabulary: 'Словарь',
    grammar: 'Грамматика',
    speaking: 'Разговор',
    randomWord: '🔮 Случайное слово',
    randomImage: '🖼️ Случайное изображение',
    getPrompt: '🎲 Получить тему для разговора',
    gender: '⚖️ Род',
    verbs: '⚡ Глаголы',
    adjectives: '✨ Прилагательные',
    plurals: '🔢 Множественное число',
    pastTense: '⏳ Прошедшее',
    futureTense: '🔮 Будущее',
    selectDay: 'Выбери день',
    selectLang: 'Выбери язык',
    check: 'Проверить',
    trySentence: 'Попробуй использовать это слово в предложении!'
  },
  ԾՈՍՅհայկական: {
    title: 'COSYlanguages',
    chooseLanguage: '🌐 Ընտրիր լեզուն:',
    chooseDay: '📅 Ընտրիր օրը:',
    dayFrom: 'Սկսած',
    dayTo: 'Մինչև',
    selectPractice: '🧭 Ընտրիր վարժությունը:',
    vocabulary: 'Բառապաշար',
    grammar: 'Քերականություն',
    speaking: 'Խոսք',
    randomWord: '🔮 Պատահական բառ',
    randomImage: '🖼️ Պատահական պատկեր',
    getPrompt: '🎲 Ստացիր բանավոր թեմա',
    gender: '⚖️ Սեռ',
    verbs: '⚡ Բայեր',
    adjectives: '✨ Առանցքային բառեր',
    plurals: '🔢 Բազմական',
    pastTense: '⏳ Անցյալ',
    futureTense: '🔮 Ապագա',
    selectDay: 'Ընտրիր օրը',
    selectLang: 'Ընտրիր լեզուն',
    check: 'Ստուգել',
    trySentence: 'Փորձիր օգտագործել այս բառը նախադասության մեջ!'
  },
  COSYbrezhoneg: {
    title: 'COSYlanguages',
    chooseLanguage: '🌐 Dibab yezh:',
    chooseDay: '📅 Dibab deiz:',
    dayFrom: 'Adalek',
    dayTo: 'Betek',
    selectPractice: '🧭 Dibab ar prantad:',
    vocabulary: 'Gerioù',
    grammar: 'Yezhadur',
    speaking: 'Komz',
    randomWord: '🔮 Ger dre zegouezh',
    randomImage: '🖼️ Skeudenn dre zegouezh',
    getPrompt: '🎲 Kaout tem komz',
    gender: '⚖️ Reizh',
    verbs: '⚡ Verbioù',
    adjectives: '✨ Adveziadoù',
    plurals: '🔢 Lies',
    pastTense: '⏳ Dremenet',
    futureTense: '🔮 Da zont',
    selectDay: 'Dibab deiz',
    selectLang: 'Dibab yezh',
    check: 'Gwiriañ',
    trySentence: 'Klask implij ar ger-mañ en ur frazenn!'
  },
  COSYtatarça: {
    title: 'COSYlanguages',
    chooseLanguage: '🌐 Телне сайла:',
    chooseDay: '📅 Көнне сайла:',
    dayFrom: 'Кемнән',
    dayTo: 'Кемгә',
    selectPractice: '🧭 Практика төрен сайла:',
    vocabulary: 'Сүзлек',
    grammar: 'Грамматика',
    speaking: 'Сөйләм',
    randomWord: '🔮 Очраклы сүз',
    randomImage: '🖼️ Очраклы рәсем',
    getPrompt: '🎲 Сөйләм темасын ал',
    gender: '⚖️ Җенес',
    verbs: '⚡ Фигыльләр',
    adjectives: '✨ Сыйфатлар',
    plurals: '🔢 Күплек',
    pastTense: '⏳ Үткән заман',
    futureTense: '🔮 Киләчәк заман',
    selectDay: 'Көнне сайла',
    selectLang: 'Телне сайла',
    check: 'Тикшерергә',
    trySentence: 'Бу сүзне җөмләдә кулланып кара!'
  },
  COSYbashkort: {
    title: 'COSYlanguages',
    chooseLanguage: '🌐 Тел һайлағыҙ:',
    chooseDay: '📅 Көн һайлағыҙ:',
    dayFrom: 'Башынан',
    dayTo: 'Тиклем',
    selectPractice: '🧭 Практика төрөн һайлағыҙ:',
    vocabulary: 'Һүҙлек',
    grammar: 'Грамматика',
    speaking: 'Һөйләү',
    randomWord: '🔮 Осраҡлы һүҙ',
    randomImage: '🖼️ Осраҡлы һүрәт',
    getPrompt: '🎲 Һөйләү темаһын ал',
    gender: '⚖️ Енес',
    verbs: '⚡ Фигыльдәр',
    adjectives: '✨ Сифаттар',
    plurals: '🔢 Күплек',
    pastTense: '⏳ Үткән заман',
    futureTense: '🔮 Киләсәк заман',
    selectDay: 'Көн һайлағыҙ',
    selectLang: 'Тел һайлағыҙ',
    check: 'Тикшерергә',
    trySentence: 'Был һүҙҙе һөйләмдә ҡулланып ҡарағыҙ!'
  }
  // Add more languages as needed
};

function updateUIForLanguage(lang) {
  const t = translations[lang] || translations['COSYenglish'];
  document.querySelector('h1').textContent = 'COSYlanguages';
  document.querySelector('label[for="language"]').textContent = t.chooseLanguage;
  document.querySelector('label[for="day"]').textContent = t.chooseDay;
  document.querySelector('label[for="day-from"]').textContent = t.dayFrom + ':';
  document.querySelector('label[for="day-to"]').textContent = t.dayTo + ':';
  document.querySelector('.menu-section label[for="language"]').textContent = t.chooseLanguage;
  document.querySelector('.menu-section label[for="day"]').textContent = t.chooseDay;
  document.querySelector('.menu-section label[for="day-from"]').textContent = t.dayFrom + ':';
  document.querySelector('.menu-section label[for="day-to"]').textContent = t.dayTo + ':';
  document.querySelector('.menu-section label:not([for])').textContent = t.selectPractice;
  document.getElementById('vocabulary-btn').textContent = t.vocabulary;
  document.getElementById('grammar-btn').textContent = t.grammar;
  document.getElementById('speaking-btn').textContent = t.speaking;
  document.getElementById('random-word-btn').textContent = t.randomWord;
  document.getElementById('random-image-btn').textContent = t.randomImage;
  document.getElementById('speaking-practice-btn').textContent = t.getPrompt;
  // Update grammar options if visible
  if (document.getElementById('grammar-options').style.display === 'block') updateGrammarOptions();
}

// Update grammar options to use adventure translations
function updateGrammarOptions() {
  const lang = document.getElementById('language').value;
  const t = translations[lang] || translations['COSYenglish'];
  const day = parseInt(daySelect.value);
  grammarOptionsContainer.innerHTML = '';
  if (!day) {
    const noDayMsg = document.createElement('p');
    noDayMsg.textContent = t.selectDay;
    grammarOptionsContainer.appendChild(noDayMsg);
    return;
  }
  if (day >= 1) {
    const genderBtn = document.createElement('button');
    genderBtn.textContent = t.gender;
    genderBtn.className = 'btn-secondary btn-small';
    genderBtn.onclick = function() { practiceGrammar('gender'); };
    grammarOptionsContainer.appendChild(genderBtn);
  }
  if (day >= 2) {
    const verbBtn = document.createElement('button');
    verbBtn.textContent = t.verbs;
    verbBtn.className = 'btn-secondary btn-small';
    verbBtn.onclick = function() { practiceGrammar('verbs'); };
    grammarOptionsContainer.appendChild(verbBtn);
  }
  if (day >= 3) {
    const adjBtn = document.createElement('button');
    adjBtn.textContent = t.adjectives;
    adjBtn.className = 'btn-secondary btn-small';
    adjBtn.onclick = function() { practiceGrammar('adjectives'); };
    grammarOptionsContainer.appendChild(adjBtn);
    const pluralBtn = document.createElement('button');
    pluralBtn.textContent = t.plurals;
    pluralBtn.className = 'btn-secondary btn-small';
    pluralBtn.onclick = function() { practiceGrammar('plurals'); };
    grammarOptionsContainer.appendChild(pluralBtn);
  }
  if (day >= 5) {
    const pastBtn = document.createElement('button');
    pastBtn.textContent = t.pastTense;
    pastBtn.className = 'btn-secondary btn-small';
    pastBtn.onclick = function() { practiceGrammar('past-tense'); };
    grammarOptionsContainer.appendChild(pastBtn);
  }
  if (day >= 7) {
    const futureBtn = document.createElement('button');
    futureBtn.textContent = t.futureTense;
    futureBtn.className = 'btn-secondary btn-small';
    futureBtn.onclick = function() { practiceGrammar('future-tense'); };
    grammarOptionsContainer.appendChild(futureBtn);
  }
}

// Update UI language on language change
languageSelect.addEventListener('change', function() {
  // ...existing flag logic...
  const lang = languageSelect.value;
  // Remove any previous flag class
  document.body.className = document.body.className
    .split(' ')
    .filter(c => !c.startsWith('flag-'))
    .join(' ');
  if (lang) {
    document.body.classList.add('flag-' + lang);
  }
  updateUIForLanguage(lang);
});

// On page load, set UI to default language
updateUIForLanguage(document.getElementById('language').value || 'COSYenglish');

// Grammar practice function (gender/verbs)
async function practiceGrammar(type) {
    const language = document.getElementById('language').value;
    const day = document.getElementById('day').value;
    const resultArea = document.getElementById('result');
    if (!language) {
        alert('Please select a language first');
        return;
    }
    if (!day) {
        alert('Please select a day first');
        return;
    }
    resultArea.style.display = 'block';
    if (type === 'gender') {
        const items = await loadGenderGrammar(language, day);
        if (!items.length) {
            resultArea.innerHTML = `<p style="text-align:center;">No gender data for this day/language.</p>`;
            return;
        }
        const item = items[Math.floor(Math.random() * items.length)];
        // Determine articles for the language
        let articles = [];
        switch(language) {
            case 'COSYenglish': articles = ['he', 'she', 'it']; break;
            case 'COSYfrançais': articles = ['le', 'la', "l'"]; break;
            case 'COSYitaliano': articles = ['il', 'la', 'lo', "l'"]; break;
            case 'COSYespañol': articles = ['el', 'la']; break;
            case 'COSYdeutsch': articles = ['der', 'die', 'das']; break;
            case 'COSYportuguês': articles = ['o', 'a']; break;
            case 'ТАКОЙрусский': articles = ['он', 'она', 'оно']; break;
            case 'COSYenglish': articles = ['he', 'she', 'it']; break;
            case 'COSYbrezhoneg': articles = ['ar', 'an']; break;
            case 'COSYtatarça': articles = ['ир-ат', 'хатын-кыз']; break;
            case 'COSYbashkort': articles = ['ир-ат', 'ҡатын-ҡыҙ']; break;
            case 'ԾՈՍՅհայկական': articles = ['արական', 'իգական', 'միջին']; break;
            case 'ΚΟΖΥελληνικά': articles = ['ο', 'η', 'το']; break;
            default: articles = ['the', 'a', 'an']; break;
        }
        // Build visually appealing article buttons
        let articleOptions = articles.map((art, idx) =>
            `<button type='button' class='article-btn${idx===0 ? " selected" : ""}' data-article='${art}'>${art}</button>`
        ).join('');
        resultArea.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:160px;">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:18px;">
                    <span id="gender-word" style="font-size:2rem; font-weight:600;">${item.word}</span>
                    <button id="play-gender-pronounce-btn" class="btn-secondary" title="Hear pronunciation" style="font-size:1.5rem;">🔊</button>
                </div>
                <div id="article-options" style="margin-bottom:18px; display:flex; flex-wrap:wrap; justify-content:center; gap:8px;">${articleOptions}</div>
                <button id="check-gender-btn" class="btn-secondary" style="min-width:120px; margin-bottom:10px;">Check</button>
                <div id="gender-feedback" style="margin-top:14px;"></div>
            </div>
        `;
        // Automatic pronunciation
        pronounceWord(item.word, language);
        setTimeout(() => {
            document.getElementById('play-gender-pronounce-btn').onclick = function() {
                pronounceWord(item.word, language);
            };
            document.getElementById('check-gender-btn').onclick = function() {
                const selected = document.querySelector('input[name="article"]:checked');
                let correct = false;
                if (Array.isArray(item.article)) {
                    correct = item.article.includes(selected.value);
                } else {
                    correct = selected && selected.value && (selected.value === item.article);
                }
                let feedback = '';
                if (!selected) {
                    feedback = '<span style="color:#e67e22;">Please select an article.</span>';
                } else if (correct) {
                    feedback = '<span style="color:#27ae60;">✅ Correct!</span>';
                } else {
                    feedback = `<span style=\"color:#e74c3c;\">❌ Not quite. The correct article is: <b>${Array.isArray(item.article) ? item.article.join(', ') : item.article}</b></span>`;
                }
                document.getElementById('gender-feedback').innerHTML = feedback;
            };
            // Add JS logic for button selection
            const articleBtns = document.querySelectorAll('#article-options .article-btn');
            let selectedArticle = articles[0];
            articleBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    articleBtns.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedArticle = btn.getAttribute('data-article');
                });
            });
        }, 0);
        return;
    } else if (type === 'verbs') {
        const items = await loadVerbGrammar(language, day);
        if (!items.length) {
            resultArea.innerHTML = `<p style="text-align:center;">No verb data for this day/language.</p>`;
            return;
        }
        const item = items[Math.floor(Math.random() * items.length)];
        // UI: show prompt with listen button, ask for answer
        resultArea.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:160px;">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:18px;">
                    <span id="verb-prompt" style="font-size:2rem; font-weight:600;">${item.prompt}</span>
                    <button id="play-verb-pronounce-btn" class="btn-secondary" title="Hear pronunciation" style="font-size:1.5rem;">🔊</button>
                </div>
                <input id="verb-answer-input" type="text" placeholder="Type the answer..." style="font-size:1.1rem; padding:8px 14px; border-radius:8px; border:1px solid #bbb; margin-bottom:14px; width:220px; text-align:center;">
                <button id="check-verb-answer-btn" class="btn-secondary" style="margin-bottom:18px; min-width:120px;">Check</button>
                <div id="verb-answer-feedback" style="margin-top:10px;"></div>
            </div>
        `;
        // Automatic pronunciation
        pronounceWord(item.prompt, language);
        setTimeout(() => {
            document.getElementById('play-verb-pronounce-btn').onclick = function() {
                pronounceWord(item.prompt, language);
            };
            document.getElementById('check-verb-answer-btn').onclick = function() {
                const userInput = document.getElementById('verb-answer-input').value.trim().toLowerCase();
                const correct = item.answer.trim().toLowerCase();
                let feedback = '';
                if (!userInput) {
                    feedback = '<span style="color:#e67e22;">Please type your answer above.</span>';
                } else if (userInput === correct) {
                    feedback = '<span style="color:#27ae60;">✅ Correct!</span>';
                } else if (userInput && correct && (userInput.includes(correct) || correct.includes(userInput))) {
                    feedback = '<span style="color:#f1c40f;">🟡 Almost! Check your spelling.</span>';
                } else {
                    feedback = `<span style=\"color:#e74c3c;\">❌ Not quite. The correct answer is: <b>${item.answer}</b></span>`;
                }
                document.getElementById('verb-answer-feedback').innerHTML = feedback;
            };
            // Add Enter key support for verb answer
            addEnterKeySupport('verb-answer-input', 'check-verb-answer-btn');
        }, 0);
        return;
    }
}

// --- Remember language and day selection using localStorage ---
function saveUserSelection() {
    localStorage.setItem('cosy_language', document.getElementById('language').value);
    localStorage.setItem('cosy_day', document.getElementById('day').value);
}
function restoreUserSelection() {
    const savedLang = localStorage.getItem('cosy_language');
    const savedDay = localStorage.getItem('cosy_day');
    if (savedLang) {
        document.getElementById('language').value = savedLang;
        // Trigger change event to update UI/flag
        document.getElementById('language').dispatchEvent(new Event('change'));
    }
    if (savedDay) {
        document.getElementById('day').value = savedDay;
        // Optionally trigger change event if needed
        document.getElementById('day').dispatchEvent(new Event('change'));
    }
}
// Attach save on change
if (document.getElementById('language')) {
    document.getElementById('language').addEventListener('change', saveUserSelection);
}
if (document.getElementById('day')) {
    document.getElementById('day').addEventListener('change', saveUserSelection);
}
// Restore on page load
window.addEventListener('DOMContentLoaded', restoreUserSelection);
    </script>
</body>
</html>