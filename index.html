<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSYlanguages</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('service-worker.js');
        });
      }
    </script>
    <script src="translations.js"></script>
</head>
<body>
    <div class="container">
        <h1>COSYlanguages</h1>
        
        <div class="menu-section">
            <label for="language">Choose Language:</label>
            <select id="language">
                <option value="">Select a language</option>
                <option value="COSYenglish" data-bg="COSYenglish">COSYenglish</option>
                <option value="COSYfran√ßais" data-bg="COSYfran√ßais">COSYfran√ßais</option>
                <option value="COSYitaliano" data-bg="COSYitaliano">COSYitaliano</option>
                <option value="COSYespa√±ol" data-bg="COSYespa√±ol">COSYespa√±ol</option>
                <option value="COSYportugu√™s" data-bg="COSYportugu√™s">COSYportugu√™s</option>
                <option value="COSYdeutsch" data-bg="COSYdeutsch">COSYdeutsch</option>
                <option value="ŒöŒüŒñŒ•ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨" data-bg="ŒöŒüŒñŒ•ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨">ŒöŒüŒñŒ•ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨</option>
                <option value="–¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π" data-bg="–¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π">–¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π</option>
                <option value="‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂" data-bg="‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂">‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂</option>
                <option value="COSYbrezhoneg" data-bg="COSYbrezhoneg">COSYbrezhoneg</option>
                <option value="COSYtatar√ßa" data-bg="COSYtatar√ßa">COSYtatar√ßa</option>
                <option value="COSYbashkort" data-bg="COSYbashkort">COSYbashkort</option>
            </select>
        </div>
        
        <div class="menu-section">
            <label for="day">Choose Day:</label>
            <select id="day">
                <option value="">Select a day</option>
                <!-- Days will be populated by JavaScript -->
            </select>
            
            <div class="day-range">
                <div>
                    <label for="day-from">Day From:</label>
                    <select id="day-from">
                        <option value="">From</option>
                    </select>
                </div>
                <div>
                    <label for="day-to">Day To:</label>
                    <select id="day-to">
                        <option value="">To</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="menu-section">
            <label>Select Practice Type:</label>
            <div class="practice-types">
                <button id="vocabulary-btn" class="btn-primary">Vocabulary</button>
                <button id="grammar-btn" class="btn-primary">Grammar</button>
                <button id="speaking-btn" class="btn-primary">Speaking</button>
            </div>
            
            <div id="vocabulary-options" class="practice-options">
                <div class="vocabulary-options">
                    <button id="random-word-btn" class="btn-secondary">üîÆ Random Word</button>
                    <button id="random-image-btn" class="btn-secondary">üñºÔ∏è Random Image</button>
                    <button id="listening-btn" class="btn-secondary">üéß Listening</button>
                </div>
            </div>
            
            <div id="grammar-options" class="practice-options">
                <div class="grammar-options">
                    <!-- Grammar buttons will be populated by JavaScript -->
                </div>
            </div>
            
            <div id="speaking-options" class="practice-options">
                <button id="speaking-practice-btn" class="btn-primary">Get Speaking Prompt</button>
            </div>
            
            <button id="practice-all-btn" class="btn-primary">Practice All</button>
        </div>
        
        <div id="result" class="result-area"></div>
    </div>

    <script>
        // Populate days dropdown (1-30)
        const daySelect = document.getElementById('day');
        const dayFromSelect = document.getElementById('day-from');
        const dayToSelect = document.getElementById('day-to');
        
        for (let i = 1; i <= 30; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Day ${i}`;
            daySelect.appendChild(option.cloneNode(true));
            dayFromSelect.appendChild(option.cloneNode(true));
            dayToSelect.appendChild(option.cloneNode(true));
        }
        
        // Practice type buttons
        const vocabularyBtn = document.getElementById('vocabulary-btn');
        const grammarBtn = document.getElementById('grammar-btn');
        const speakingBtn = document.getElementById('speaking-btn');
        
        const vocabularyOptions = document.getElementById('vocabulary-options');
        const grammarOptions = document.getElementById('grammar-options');
        const grammarOptionsContainer = grammarOptions.querySelector('.grammar-options');
        const speakingOptions = document.getElementById('speaking-options');
        
        // Hide all options initially
        vocabularyOptions.style.display = 'none';
        grammarOptions.style.display = 'none';
        speakingOptions.style.display = 'none';
        // Show Practice All button on load
        const practiceAllBtn = document.getElementById('practice-all-btn');
        practiceAllBtn.style.display = 'block';

        // --- Hide other options when one is selected ---
        function hideOtherVocabularyOptions(selectedId) {
            document.querySelectorAll('#vocabulary-options button').forEach(btn => {
                if (btn.id !== selectedId) btn.style.display = 'none';
            });
        }
        function showAllVocabularyOptions() {
            document.querySelectorAll('#vocabulary-options button').forEach(btn => {
                btn.style.display = '';
            });
        }
        function hideOtherGrammarOptions(selectedId) {
            document.querySelectorAll('#grammar-options button').forEach(btn => {
                if (btn.id !== selectedId) btn.style.display = 'none';
            });
        }
        function showAllGrammarOptions() {
            document.querySelectorAll('#grammar-options button').forEach(btn => {
                btn.style.display = '';
            });
        }

        // Helper: show/hide main practice type buttons
        function hideOtherMainPracticeTypes(selectedId) {
            // Hide all except the selected one
            ['vocabulary-btn', 'grammar-btn', 'speaking-btn'].forEach(id => {
                if (id !== selectedId) {
                    document.getElementById(id).style.display = 'none';
                } else {
                    document.getElementById(id).classList.add('active-main-btn');
                }
            });
        }
        function showAllMainPracticeTypes() {
            ['vocabulary-btn', 'grammar-btn', 'speaking-btn'].forEach(id => {
                document.getElementById(id).style.display = 'inline-block';
                document.getElementById(id).classList.remove('active-main-btn');
            });
        }

        // Helper: go back to main menu
        function goBackToMainMenu() {
            showAllMainPracticeTypes();
            showAllVocabularyOptions && showAllVocabularyOptions();
            showAllGrammarOptions && showAllGrammarOptions();
            if (vocabularyOptions) vocabularyOptions.style.display = 'none';
            if (grammarOptions) grammarOptions.style.display = 'none';
            if (speakingOptions) speakingOptions.style.display = 'none';
            if (practiceAllBtn) practiceAllBtn.style.display = 'block';
            if (document.getElementById('result')) document.getElementById('result').innerHTML = '';
        }

        // On page load, always restore main menu and update grammar options if grammar is visible
        window.addEventListener('DOMContentLoaded', function() {
            goBackToMainMenu();
            // If grammar options are visible, update them
            if (grammarOptions && grammarOptions.style.display === 'block') {
                updateGrammarOptions();
            }
        });

        // --- Toggle logic for main practice type buttons ---
        function toggleMainPracticeType(selectedId) {
            const btn = document.getElementById(selectedId);
            const isActive = btn.classList.contains('active-main-btn');
            if (isActive) {
                // Restore all if already active
                showAllMainPracticeTypes();
                showAllVocabularyOptions();
                showAllGrammarOptions();
                vocabularyOptions.style.display = 'none';
                grammarOptions.style.display = 'none';
                speakingOptions.style.display = 'none';
                practiceAllBtn.style.display = 'block';
                document.getElementById('result').innerHTML = '';
            } else {
                hideOtherMainPracticeTypes(selectedId);
                // Show the relevant options
                if (selectedId === 'vocabulary-btn') {
                    vocabularyOptions.style.display = 'block';
                    grammarOptions.style.display = 'none';
                    speakingOptions.style.display = 'none';
                } else if (selectedId === 'grammar-btn') {
                    grammarOptions.style.display = 'block';
                    vocabularyOptions.style.display = 'none';
                    speakingOptions.style.display = 'none';
                } else if (selectedId === 'speaking-btn') {
                    speakingOptions.style.display = 'block';
                    vocabularyOptions.style.display = 'none';
                    grammarOptions.style.display = 'none';
                }
                practiceAllBtn.style.display = 'none';
                document.getElementById('result').innerHTML = '';
            }
        }

        // Vocabulary button click
        vocabularyBtn.addEventListener('click', function() {
            // Only go back to main menu, do not randomize
            toggleMainPracticeType('vocabulary-btn');
        });
        
        // Grammar button click
        grammarBtn.addEventListener('click', function() {
            toggleMainPracticeType('grammar-btn');
            grammarOptions.style.display = 'block';
            updateGrammarOptions();
        });
        
        // Speaking button click
        speakingBtn.addEventListener('click', function() {
            toggleMainPracticeType('speaking-btn');
        });
        
        // Update grammar options based on selected day or range
        function updateGrammarOptions() {
            const lang = document.getElementById('language').value;
            const t = translations[lang] || translations['COSYenglish'];
            const days = getSelectedDays();
            grammarOptionsContainer.innerHTML = '';
            if (!days.length) {
                const noDayMsg = document.createElement('p');
                noDayMsg.textContent = t.selectDay;
                grammarOptionsContainer.appendChild(noDayMsg);
                return;
            }
            // Use the first day in the range to determine which grammar options to show
            const day = parseInt(days[0]);
            // Helper for toggle logic
            function hideOtherGrammarOptionBtns(selectedBtn) {
                const btns = grammarOptionsContainer.querySelectorAll('.grammar-option-btn');
                btns.forEach(btn => {
                    if (btn !== selectedBtn) {
                        btn.style.display = 'none';
                    } else {
                        btn.classList.add('active-grammar-btn');
                    }
                });
            }
            function showAllGrammarOptionBtns() {
                const btns = grammarOptionsContainer.querySelectorAll('.grammar-option-btn');
                btns.forEach(btn => {
                    btn.style.display = 'inline-block';
                    btn.classList.remove('active-grammar-btn');
                });
            }
            function makeToggleHandler(btn) {
                return function() {
                    const isActive = btn.classList.contains('active-grammar-btn');
                    if (isActive) {
                        showAllGrammarOptionBtns();
                        document.getElementById('result').innerHTML = '';
                    } else {
                        hideOtherGrammarOptionBtns(btn);
                        document.getElementById('result').innerHTML = '';
                        // Auto-start practice for this grammar type
                        const type = btn.textContent.trim().toLowerCase();
                        if (type.includes('gender')) practiceGrammar('gender');
                        else if (type.includes('verb')) practiceGrammar('verbs');
                        else if (type.includes('adjective')) practiceGrammar('adjectives');
                        else if (type.includes('plural')) practiceGrammar('plurals');
                        else if (type.includes('past')) practiceGrammar('pastTense');
                        else if (type.includes('future')) practiceGrammar('futureTense');
                    }
                };
            }
            // In updateGrammarOptions, always show gender button for day 1+ for all languages
            if (day >= 1) {
                const genderBtn = document.createElement('button');
                genderBtn.textContent = t.gender;
                genderBtn.className = 'btn-secondary btn-small grammar-option-btn';
                genderBtn.onclick = function() {
                    hideOtherGrammarOptionBtns(genderBtn);
                    document.getElementById('result').innerHTML = '';
                    practiceGrammar('gender');
                };
                grammarOptionsContainer.appendChild(genderBtn);
            }
            if (day >= 2) {
                const verbBtn = document.createElement('button');
                verbBtn.textContent = t.verbs;
                verbBtn.className = 'btn-secondary btn-small grammar-option-btn';
                verbBtn.onclick = makeToggleHandler(verbBtn);
                grammarOptionsContainer.appendChild(verbBtn);
            }
            if (day >= 3) {
                const adjBtn = document.createElement('button');
                adjBtn.textContent = t.adjectives;
                adjBtn.className = 'btn-secondary btn-small grammar-option-btn';
                adjBtn.onclick = makeToggleHandler(adjBtn);
                grammarOptionsContainer.appendChild(adjBtn);
                const pluralBtn = document.createElement('button');
                pluralBtn.textContent = t.plurals;
                pluralBtn.className = 'btn-secondary btn-small grammar-option-btn';
                pluralBtn.onclick = makeToggleHandler(pluralBtn);
                grammarOptionsContainer.appendChild(pluralBtn);
            }
            if (day >= 5) {
                const pastBtn = document.createElement('button');
                pastBtn.textContent = t.pastTense;
                pastBtn.className = 'btn-secondary btn-small grammar-option-btn';
                pastBtn.onclick = makeToggleHandler(pastBtn);
                grammarOptionsContainer.appendChild(pastBtn);
            }
            if (day >= 7) {
                const futureBtn = document.createElement('button');
                futureBtn.textContent = t.futureTense;
                futureBtn.className = 'btn-secondary btn-small grammar-option-btn';
                futureBtn.onclick = makeToggleHandler(futureBtn);
                grammarOptionsContainer.appendChild(futureBtn);
            }
        }
        
        // Update grammar options when day changes
        daySelect.addEventListener('change', function() {
            if (grammarOptions.style.display === 'block') {
                updateGrammarOptions();
            }
        });
        
        // Update day, day-from, and day-to event listeners to update grammar options
        ['day', 'day-from', 'day-to'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('change', function() {
                    if (grammarOptions.style.display === 'block') {
                        updateGrammarOptions();
                    }
                });
            }
        });
        
        // Helper: map language select value to vocabulary file
        function getVocabularyFile(language) {
            switch(language) {
                case 'COSYenglish': return 'vocabulary/words/vocabulary_english.json';
                case 'COSYfran√ßais': return 'vocabulary/words/vocabulary_french.json';
                case 'COSYespa√±ol': return 'vocabulary/words/vocabulary_spanish.json';
                case 'COSYitaliano': return 'vocabulary/words/vocabulary_italian.json';
                case 'COSYdeutsch': return 'vocabulary/words/vocabulary_german.json';
                case 'COSYportugu√™s': return 'vocabulary/words/vocabulary_portuguese.json';
                case '–¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π': return 'vocabulary/words/vocabulary_russian.json';
                case 'COSYbrezhoneg': return 'vocabulary/words/vocabulary_breton.json';
                case 'COSYtatar√ßa': return 'vocabulary/words/vocabulary_tatar.json';
                case 'COSYbashkort': return 'vocabulary/words/vocabulary_bashkir.json';
                case '‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂': return 'vocabulary/words/vocabulary_armenian.json';
                case 'ŒöŒüŒñŒ•ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨': return 'vocabulary/words/vocabulary_greek.json';
                default: return null;
            }
        }

        // New: Load vocabulary for selected language and day
        async function loadVocabulary(language, day) {
            const file = getVocabularyFile(language);
            if (!file) return [];
            try {
                const response = await fetch(file);
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // Load random image data for a given day
        async function loadImageVocabulary(day) {
            try {
                const response = await fetch('vocabulary/images/vocabulary_images.json');
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // --- Pronunciation: play word using SpeechSynthesis API, with mobile support and robust voice selection ---
        function pronounceWord(word, language) {
            // Map to standard BCP-47 codes
            let langCode = 'en-GB';
            switch(language) {
                case 'COSYenglish': langCode = 'en-GB'; break;
                case 'COSYfran√ßais': langCode = 'fr-FR'; break;
                case 'COSYespa√±ol': langCode = 'es-ES'; break;
                case 'COSYitaliano': langCode = 'it-IT'; break;
                case 'COSYdeutsch': langCode = 'de-DE'; break;
                case 'COSYportugu√™s': langCode = 'pt-PT'; break;
                case '–¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π': langCode = 'ru-RU'; break;
                case 'COSYbrezhoneg': langCode = 'br-FR'; break; // Breton, fallback to French
                case 'COSYtatar√ßa': langCode = 'tt-RU'; break; // Tatar, fallback to Russian
                case 'COSYbashkort': langCode = 'ba-RU'; break; // Bashkir, fallback to Russian
                case '‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂': langCode = 'hy-AM'; break; // Armenian
                case 'ŒöŒüŒñŒ•ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨': langCode = 'el-GR'; break; // Greek
                default: langCode = 'en-GB';
            }
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                setTimeout(() => {
                    const utter = new SpeechSynthesisUtterance(word);
                    utter.lang = langCode;
                    utter.rate = 1;
                    utter.pitch = 1;
                    // Try to select a matching voice (prefer exact match, then partial, then fallback)
                    const voices = window.speechSynthesis.getVoices();
                    let match = null;
                    if (voices && voices.length) {
                        match = voices.find(v => v.lang === langCode);
                        if (!match) {
                            // Try partial match (e.g., 'el' for Greek)
                            const base = langCode.split('-')[0];
                            match = voices.find(v => v.lang.startsWith(base));
                        }
                        if (!match) match = voices[0]; // fallback
                        utter.voice = match;
                    }
                    window.speechSynthesis.speak(utter);
                }, 200); // Slightly longer delay for mobile
            } else {
                alert('Sorry, speech synthesis is not supported on this device/browser.');
            }
        }
        // --- Unlock audio context for iOS/Android on first user gesture ---
        (function unlockAudio() {
            function unlock() {
                if (window.speechSynthesis && window.speechSynthesis.speak) {
                    try {
                        const u = new SpeechSynthesisUtterance(' ');
                        window.speechSynthesis.speak(u);
                    } catch(e) {}
                }
                window.removeEventListener('touchstart', unlock, false);
                window.removeEventListener('click', unlock, false);
            }
            window.addEventListener('touchstart', unlock, false);
            window.addEventListener('click', unlock, false);
        })();
        
        // Pronunciation check: record and compare
        // --- Robust Speech Recognition: record and compare ---
        let recognition;
        function startPronunciationCheck(targetWord, language) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition is not supported in this browser. Try using Chrome on Android or desktop.');
                return;
            }
            // Stop previous recognition if running
            if (recognition && recognition.stop) {
                try { recognition.onresult = null; recognition.onerror = null; recognition.onend = null; recognition.stop(); } catch(e) {}
            }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = (function(lang) {
                switch(lang) {
                    case 'COSYenglish': return 'en-GB';
                    case 'COSYfran√ßais': return 'fr-FR';
                    case 'COSYespa√±ol': return 'es-ES';
                    case 'COSYitaliano': return 'it-IT';
                    case 'COSYdeutsch': return 'de-DE';
                    case 'COSYportugu√™s': return 'pt-PT';
                    case '–¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π': return 'ru-RU';
                    case 'COSYbrezhoneg': return 'br-FR';
                    case 'COSYtatar√ßa': return 'tt-RU';
                    case 'COSYbashkort': return 'ba-RU';
                    case '‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂': return 'hy-AM';
                    default: return 'en-GB';
                }
            })(language);
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.onresult = function(event) {
                const userSaid = event.results[0][0].transcript.trim().toLowerCase();
                const target = targetWord.trim().toLowerCase();
                // Simple similarity: check if user said word is contained or similar
                let similarity = 0;
                if (userSaid === target) {
                    similarity = 1;
                } else if (userSaid.includes(target) || target.includes(userSaid)) {
                    similarity = 0.8;
                } else {
                    // Levenshtein distance (basic)
                    function lev(a, b) {
                        const matrix = [];
                        for (let i = 0; i <= b.length; i++) matrix[i] = [i];
                        for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
                        for (let i = 1; i <= b.length; i++) {
                            for (let j = 1; j <= a.length; j++) {
                                if (b.charAt(i-1) === a.charAt(j-1)) {
                                    matrix[i][j] = matrix[i-1][j-1];
                                } else {
                                    matrix[i][j] = Math.min(
                                        matrix[i-1][j-1] + 1,
                                        matrix[i][j-1] + 1,
                                        matrix[i-1][j] + 1
                                    );
                                }
                            }
                        }
                        return matrix[b.length][a.length];
                    }
                    const dist = lev(userSaid, target);
                    similarity = 1 - dist / Math.max(target.length, userSaid.length);
                }
                let feedback = '';
                if (similarity > 0.7) {
                    feedback = '‚úÖ Good job! Your pronunciation is close enough.';
                } else if (similarity > 0.4) {
                    feedback = 'üü° Not bad! Try again for a closer pronunciation.';
                } else {
                    feedback = 'üî¥ Keep practicing! Try to say the word more clearly.';
                }
                document.getElementById('pronunciation-feedback').innerHTML =
                    `<p><strong>You said:</strong> ${userSaid}</p><p>${feedback}</p>`;
            };
            recognition.onerror = function(event) {
                let msg = `<p style='color:red;'>Error: ${event.error}</p>`;
                if (event.error === 'not-allowed' || event.error === 'denied') {
                    msg += '<p style="color:red;">Microphone access denied. Please allow microphone permissions in your browser settings.</p>';
                } else if (event.error === 'no-speech') {
                    msg += '<p style="color:red;">No speech detected. Please try again and speak clearly.</p>';
                }
                document.getElementById('pronunciation-feedback').innerHTML = msg;
                try { recognition.stop(); } catch(e) {}
            };
            recognition.onend = function() {
                // Optionally, you can re-enable the button or give UI feedback here
            };
            try {
                recognition.start();
                document.getElementById('pronunciation-feedback').innerHTML = '<p>Listening...</p>';
            } catch(e) {
                document.getElementById('pronunciation-feedback').innerHTML = '<p style="color:red;">Could not start recognition. Please check your microphone permissions.</p>';
            }
        }

        // Vocabulary practice function (random word from file)
        async function practiceVocabulary(type) {
            const language = document.getElementById('language').value;
            const days = getSelectedDays();
            const resultArea = document.getElementById('result');
            if (!language) {
                alert('Please select a language first');
                return;
            }
            if (!days.length) {
                alert('Please select a day or a range of days first');
                return;
            }
            resultArea.style.display = 'block';
            // For random selection, pick a random day from the range
            const day = days[Math.floor(Math.random() * days.length)];
            if (type === 'random-word') {
                const words = await loadVocabulary(language, day);
                if (!words.length) {
                    resultArea.innerHTML = `<p style="text-align:center;">No vocabulary found for this day.</p>`;
                    return;
                }
                let word = words[Math.floor(Math.random() * words.length)];
                function renderWord() {
                    resultArea.innerHTML = `
                        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:180px;">
                            <div id="vocab-word" style="font-size:2.2rem; font-weight:600; margin-bottom:18px; text-align:center; cursor:pointer;">${word}</div>
                            <div style="display:flex; gap:24px; justify-content:center; align-items:center;">
                                <button id="play-pronounce-btn" class="btn-secondary" title="Hear pronunciation" style="font-size:2rem;">üîä</button>
                                <button id="check-pronounce-btn" class="btn-secondary" title="Check your pronunciation" style="font-size:2rem;">üé§</button>
                            </div>
                            <div id="pronunciation-feedback" style="margin-top:18px;"></div>
                        </div>
                    `;
                    pronounceWord(word, language);
                    setTimeout(() => {
                        document.getElementById('play-pronounce-btn').onclick = function() {
                            pronounceWord(word, language);
                        };
                        document.getElementById('check-pronounce-btn').onclick = function() {
                            startPronunciationCheck(word, language);
                        };
                        document.getElementById('vocab-word').onclick = function() {
                            word = words[Math.floor(Math.random() * words.length)];
                            renderWord();
                        };
                    }, 0);
                }
                renderWord();
                return;
            } else if (type === 'random-image') {
                const images = await loadImageVocabulary(day);
                if (!images.length) {
                    resultArea.innerHTML = `<p style="text-align:center;">No images found for this day.</p>`;
                    return;
                }
                let item = images[Math.floor(Math.random() * images.length)];
                const answer = item.translations[language] || '[No translation]';
                function renderImage() {
                    let questionBlock = '';
                    if (parseInt(day) === 1) {
                        questionBlock = `<div style="font-size:1.2rem; font-weight:500; color:#00bdbd; margin-bottom:10px;">${(translations[language]||translations['COSYenglish']).randomImageQ1}</div>`;
                    } else if (parseInt(day) === 2) {
                        const t = translations[language]||translations['COSYenglish'];
                        questionBlock = `<div style="font-size:1.2rem; font-weight:500; color:#00bdbd; margin-bottom:2px;">${t.randomImageQ2a}</div><div style="font-size:1.1rem; font-weight:400; color:#009999; margin-bottom:8px;">${t.randomImageQ2b}</div>`;
                    }
                    resultArea.innerHTML = `
                        ${questionBlock}
                        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:220px;">
                            <img id="vocab-image" src="${item.src}" alt="${item.alt}" class="vocabulary-image" style="max-width:180px; max-height:180px; margin-bottom:18px; border-radius:16px; box-shadow:0 2px 12px rgba(0,0,0,0.10); cursor:pointer;">
                            <input id="image-answer-input" type="text" placeholder="Type your answer..." style="font-size:1.1rem; padding:8px 14px; border-radius:8px; border:1px solid #bbb; margin-bottom:14px; width:220px; text-align:center;">
                            <button id="check-image-answer-btn" class="btn-secondary" style="margin-bottom:18px; min-width:120px;">Check</button>
                            <div style="display:flex; gap:24px; justify-content:center; align-items:center; margin-bottom:0;">
                                <button id="play-pronounce-btn" class="btn-secondary" title="Hear pronunciation" style="font-size:2rem;">üîä</button>
                                <button id="check-pronounce-btn" class="btn-secondary" title="Check your pronunciation" style="font-size:2rem;">üé§</button>
                            </div>
                            <div id="pronunciation-feedback" style="margin-top:18px;"></div>
                            <div id="image-answer-feedback" style="margin-top:10px;"></div>
                        </div>
                    `;
                    setTimeout(() => {
                        document.getElementById('play-pronounce-btn').onclick = function() {
                            pronounceWord(answer, language);
                        };
                        document.getElementById('check-pronounce-btn').onclick = function() {
                            startPronunciationCheck(answer, language);
                        };
                        document.getElementById('check-image-answer-btn').onclick = function() {
                            const userInput = document.getElementById('image-answer-input').value.trim().toLowerCase();
                            const correct = answer.trim().toLowerCase();
                            let feedback = '';
                            if (!userInput) {
                                feedback = '<span style="color:#e67e22;">Please type your answer above.</span>';
                            } else if (userInput === correct) {
                                feedback = '<span style="color:#27ae60;">‚úÖ Correct!</span>';
                            } else if (userInput && correct && (userInput.includes(correct) || correct.includes(userInput))) {
                                feedback = '<span style="color:#f1c40f;">üü° Almost! Check your spelling.</span>';
                            } else {
                                feedback = `<span style=\"color:#e74c3c;\">‚ùå Not quite. The correct answer is: <b>${answer}</b></span>`;
                            }
                            document.getElementById('image-answer-feedback').innerHTML = feedback;
                        };
                        document.getElementById('vocab-image').onclick = function() {
                            item = images[Math.floor(Math.random() * images.length)];
                            renderImage();
                        };
                        addEnterKeySupport('image-answer-input', 'check-image-answer-btn');
                    }, 0);
                }
                renderImage();
                return;
            } else if (type === 'listening') {
                const words = await loadVocabulary(language, day);
                if (!words.length) {
                    resultArea.innerHTML = `<p style=\"text-align:center;\">No vocabulary found for this day.</p>`;
                    return;
                }
                const word = words[Math.floor(Math.random() * words.length)];
                resultArea.innerHTML = `
                    <div style=\"display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:180px;\">
                        <button id=\"play-listen-btn\" class=\"btn-secondary\" title=\"Hear word\" style=\"font-size:2rem; margin-bottom:18px;\">üîä</button>
                        <input id=\"listening-answer-input\" type=\"text\" placeholder=\"Type what you hear...\" style=\"font-size:1.1rem; padding:8px 14px; border-radius:8px; border:1px solid #bbb; margin-bottom:14px; width:220px; text-align:center;\">
                        <button id=\"check-listening-answer-btn\" class=\"btn-secondary\" style=\"margin-bottom:18px; min-width:120px;\">Check</button>
                        <div id=\"listening-answer-feedback\" style=\"margin-top:10px;\"></div>
                    </div>
                `;
                // Automatic pronunciation for listening
                pronounceWord(word, language);
                setTimeout(() => {
                    document.getElementById('play-listen-btn').onclick = function() {
                        pronounceWord(word, language);
                    };
                    document.getElementById('check-listening-answer-btn').onclick = function() {
                        const userInput = document.getElementById('listening-answer-input').value.trim().toLowerCase();
                        const correct = word.trim().toLowerCase();
                        let feedback = '';
                        if (!userInput) {
                            feedback = '<span style=\"color:#e67e22;\">Please type your answer above.</span>';
                        } else if (userInput === correct) {
                            feedback = '<span style=\"color:#27ae60;\">‚úÖ Correct!</span>';
                            setTimeout(() => practiceVocabulary('listening'), 1200);
                        } else if (userInput && correct && (userInput.includes(correct) || correct.includes(userInput))) {
                            feedback = '<span style=\"color:#f1c40f;\">üü° Almost! Check your spelling.</span>';
                        } else {
                            feedback = `<span style=\\\"color:#e74c3c;\\\">‚ùå Not quite. The correct answer is: <b>${word}</b></span>`;
                        }
                        document.getElementById('listening-answer-feedback').innerHTML = feedback;
                    };
                    // Add Enter key support for listening answer
                    addEnterKeySupport('listening-answer-input', 'check-listening-answer-btn');
                }, 0);
                return;
            }
        }
        
        // Load gender grammar data for a given language and day
        async function loadGenderGrammar(language, day) {
            const fileMap = {
                'COSYenglish': 'grammar/gender/grammar_gender_english.json',
                'COSYitaliano': 'grammar/gender/grammar_gender_italian.json',
                'COSYfran√ßais': 'grammar/gender/grammar_gender_french.json',
                'COSYespa√±ol': 'grammar/gender/grammar_gender_spanish.json',
                'COSYdeutsch': 'grammar/gender/grammar_gender_german.json',
                'COSYportugu√™s': 'grammar/gender/grammar_gender_portuguese.json',
                '–¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π': 'grammar/gender/grammar_gender_russian.json',
                'COSYbrezhoneg': 'grammar/gender/grammar_gender_breton.json',
                'COSYtatar√ßa': 'grammar/gender/grammar_gender_tatar.json',
                'COSYbashkort': 'grammar/gender/grammar_gender_bashkir.json',
                '‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂': 'grammar/gender/grammar_gender_armenian.json',
                'ŒöŒüŒñŒ•ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨': 'grammar/gender/grammar_gender_greek.json'
            };
            const file = fileMap[language];
            if (!file) return [];
            try {
                const response = await fetch(file);
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // Load verb grammar data for a given language and day
        async function loadVerbGrammar(language, day) {
            const fileMap = {
                'COSYenglish': 'grammar/verbs/grammar_verbs_english.json',
                'COSYitaliano': 'grammar/verbs/grammar_verbs_italian.json',
                'COSYfran√ßais': 'grammar/verbs/grammar_verbs_french.json',
                'COSYespa√±ol': 'grammar/verbs/grammar_verbs_spanish.json',
                'COSYdeutsch': 'grammar/verbs/grammar_verbs_german.json',
                'COSYportugu√™s': 'grammar/verbs/grammar_verbs_portuguese.json',
                'ŒöŒüŒñŒ•ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨': 'grammar/verbs/grammar_verbs_greek.json'
            };
            const file = fileMap[language];
            if (!file) return [];
            try {
                const response = await fetch(file);
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // Update all fetch paths in scripts to use the new folder structure: vocabulary/, grammar/, speaking/. For example, fetch('vocabulary/vocabulary_english.json'), fetch('grammar/grammar_gender_french.json'), fetch('speaking/prompts/speaking_french.json'), etc.
        async function loadSpeakingPrompts(language, day) {
            const fileMap = {
                'COSYenglish': 'speaking/prompts/speaking_english.json',
                'COSYfran√ßais': 'speaking/prompts/speaking_french.json',
                'COSYespa√±ol': 'speaking/prompts/speaking_spanish.json',
                'COSYitaliano': 'speaking/prompts/speaking_italian.json',
                'COSYdeutsch': 'speaking/prompts/speaking_german.json',
                'COSYportugu√™s': 'speaking/prompts/speaking_portuguese.json',
                'ŒöŒüŒñŒ•ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨': 'speaking/prompts/speaking_greek.json',
                'COSYbrezhoneg': 'speaking/prompts/speaking_breton.json',
                '–¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π': 'speaking/prompts/speaking_russian.json',
                '‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂': 'speaking/prompts/speaking_armenian.json',
                'COSYtatar√ßa': 'speaking/prompts/speaking_tatar.json',
                'COSYbashkort': 'speaking/prompts/speaking_bashkir.json'
            };
            const file = fileMap[language];
            if (!file) return [];
            try {
                const response = await fetch(file);
                if (!response.ok) return [];
                const data = await response.json();
                return data[day] || [];
            } catch (e) {
                return [];
            }
        }

        // Speaking practice function
        async function practiceSpeaking() {
            const language = document.getElementById('language').value;
            const days = getSelectedDays();
            const resultArea = document.getElementById('result');
            if (!language || !days.length) {
                alert('Please select language and day or a range of days first');
                return;
            }
            resultArea.style.display = 'block';
            const day = days[Math.floor(Math.random() * days.length)];
            const prompts = await loadSpeakingPrompts(language, day);
            if (!prompts.length) {
                resultArea.innerHTML = `<p>No prompts found for this day/language.</p>`;
                return;
            }
            const prompt = prompts[Math.floor(Math.random() * prompts.length)];
            resultArea.innerHTML = `
                <div style="font-size:1.3rem; margin:20px 0;">${prompt}</div>
                <button id="start-record-btn" class="btn-secondary">üé§ Record & Check</button>
                <div id="speaking-feedback" style="margin-top:16px;"></div>
            `;
            setTimeout(() => {
                document.getElementById('start-record-btn').onclick = function() {
                    startSpeakingCheck(prompt, language);
                };
            }, 0);
        }

        // Accent-tolerant speaking check: does user say any word from the prompt?
        function startSpeakingCheck(prompt, language) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition is not supported in this browser.');
                return;
            }
            if (recognition && recognition.stop) {
                try { recognition.onresult = null; recognition.onerror = null; recognition.onend = null; recognition.stop(); } catch(e) {}
            }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = (function(lang) {
                switch(lang) {
                    case 'COSYenglish': return 'en-US';
                    case 'COSYfran√ßais': return 'fr-FR';
                    case 'COSYespa√±ol': return 'es-ES';
                    case 'COSYitaliano': return 'it-IT';
                    case 'COSYdeutsch': return 'de-DE';
                    case 'COSYportugu√™s': return 'pt-PT';
                    default: return 'en-US';
                }
            })(language);
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.onresult = function(event) {
                const userSaid = event.results[0][0].transcript.trim().toLowerCase();
                // Check if any word from the prompt is in the user's speech (accent-tolerant)
                const promptWords = prompt.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
                const userWords = userSaid.split(/\s+/);
                let match = false;
                for (let w of promptWords) {
                    if (w.length > 2 && userWords.some(u => u.includes(w) || w.includes(u))) {
                        match = true;
                        break;
                    }
                }
                let feedback = '';
                if (match) {
                    feedback = '‚úÖ Good job! Your answer contains words from the prompt.';
                } else {
                    feedback = 'üü° Not bad! Try to include more words from the prompt.';
                }
                document.getElementById('speaking-feedback').innerHTML =
                    `<p><strong>You said:</strong> ${userSaid}</p><p>${feedback}</p>`;
            };
            recognition.onerror = function(event) {
                document.getElementById('speaking-feedback').innerHTML =
                    `<p style='color:red;'>Error: ${event.error}</p>`;
                try { recognition.stop(); } catch(e) {}
            };
            recognition.onend = function() {};
            recognition.start();
            document.getElementById('speaking-feedback').innerHTML = '<p>Listening...</p>';
        }

        // Change background flag on language select
        const languageSelect = document.getElementById('language');
        languageSelect.addEventListener('change', function() {
            const lang = languageSelect.value;
            // Remove any previous flag class
            document.body.className = document.body.className
                .split(' ') // split classes
                .filter(c => !c.startsWith('flag-')) // remove flag- classes
                .join(' ');
            if (lang) {
                document.body.classList.add('flag-' + lang);
            }
        });
        
        // Speaking practice button
        document.getElementById('speaking-practice-btn').addEventListener('click', function() {
            practiceSpeaking();
        });
        
        document.getElementById('random-word-btn').addEventListener('click', function() {
            practiceVocabulary('random-word');
        });
        document.getElementById('random-image-btn').addEventListener('click', function() {
            practiceVocabulary('random-image');
        });
        document.getElementById('listening-btn').addEventListener('click', function() {
            practiceVocabulary('listening');
        });
        
        // Practice All button logic
        document.getElementById('practice-all-btn').addEventListener('click', async function() {
            const types = ['vocabulary', 'grammar', 'speaking'];
            // Only include types that are available for the selected day(s)
            const days = getSelectedDays();
            if (!days.length) {
                alert('Please select a day or a range of days first');
                return;
            }
            const language = document.getElementById('language').value;
            if (!language) {
                alert('Please select a language first');
                return;
            }
            // Randomly pick a type
            const availableTypes = [];
            // Vocabulary always available
            availableTypes.push('vocabulary');
            // Grammar only if grammar options exist for the day
            if (parseInt(days[0]) >= 1) availableTypes.push('grammar');
            // Speaking always available
            availableTypes.push('speaking');
            const type = availableTypes[Math.floor(Math.random() * availableTypes.length)];
            if (type === 'vocabulary') {
                // Randomly pick a vocabulary mode
                const vocabModes = ['random-word', 'random-image', 'listening'];
                const mode = vocabModes[Math.floor(Math.random() * vocabModes.length)];
                await practiceVocabulary(mode);
            } else if (type === 'grammar') {
                // Randomly pick a grammar type available for the day
                const grammarTypes = [];
                if (parseInt(days[0]) >= 1) grammarTypes.push('gender');
                if (parseInt(days[0]) >= 2) grammarTypes.push('verbs');
                // Add more grammar types as needed
                const gType = grammarTypes[Math.floor(Math.random() * grammarTypes.length)];
                await practiceGrammar(gType);
            } else if (type === 'speaking') {
                await practiceSpeaking();
            }
        });
        
        // Add Enter key support for practice check buttons
        function addEnterKeySupport(inputId, checkBtnId) {
            const input = document.getElementById(inputId);
            const checkBtn = document.getElementById(checkBtnId);
            if (input && checkBtn) {
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        checkBtn.click();
                    }
                });
            }
        }

        // Update grammar options to use adventure translations
        function updateGrammarOptions() {
          const lang = document.getElementById('language').value;
          const t = translations[lang] || translations['COSYenglish'];
          const days = getSelectedDays();
          grammarOptionsContainer.innerHTML = '';
          if (!days.length) {
            const noDayMsg = document.createElement('p');
            noDayMsg.textContent = t.selectDay;
            grammarOptionsContainer.appendChild(noDayMsg);
            return;
          }
          // Use the first day in the range to determine which grammar options to show
          const day = parseInt(days[0]);
          // Helper for toggle logic
          function hideOtherGrammarOptionBtns(selectedBtn) {
            const btns = grammarOptionsContainer.querySelectorAll('.grammar-option-btn');
            btns.forEach(btn => {
              if (btn !== selectedBtn) {
                btn.style.display = 'none';
              } else {
                btn.classList.add('active-grammar-btn');
              }
            });
          }
          function showAllGrammarOptionBtns() {
            const btns = grammarOptionsContainer.querySelectorAll('.grammar-option-btn');
            btns.forEach(btn => {
              btn.style.display = 'inline-block';
              btn.classList.remove('active-grammar-btn');
            });
          }
          function makeToggleHandler(btn) {
            return function() {
              const isActive = btn.classList.contains('active-grammar-btn');
              if (isActive) {
                showAllGrammarOptionBtns();
                document.getElementById('result').innerHTML = '';
              } else {
                hideOtherGrammarOptionBtns(btn);
                document.getElementById('result').innerHTML = '';
                // Auto-start practice for this grammar type
                const type = btn.textContent.trim().toLowerCase();
                if (type.includes('gender')) practiceGrammar('gender');
                else if (type.includes('verb')) practiceGrammar('verbs');
                else if (type.includes('adjective')) practiceGrammar('adjectives');
                else if (type.includes('plural')) practiceGrammar('plurals');
                else if (type.includes('past')) practiceGrammar('pastTense');
                else if (type.includes('future')) practiceGrammar('futureTense');
              }
            };
          }
          // In updateGrammarOptions, always show gender button for day 1+ for all languages
          if (day >= 1) {
            const genderBtn = document.createElement('button');
            genderBtn.textContent = t.gender;
            genderBtn.className = 'btn-secondary btn-small grammar-option-btn';
            genderBtn.onclick = function() {
                hideOtherGrammarOptionBtns(genderBtn);
                document.getElementById('result').innerHTML = '';
                practiceGrammar('gender');
            };
            grammarOptionsContainer.appendChild(genderBtn);
          }
          if (day >= 2) {
            const verbBtn = document.createElement('button');
            verbBtn.textContent = t.verbs;
            verbBtn.className = 'btn-secondary btn-small grammar-option-btn';
            verbBtn.onclick = makeToggleHandler(verbBtn);
            grammarOptionsContainer.appendChild(verbBtn);
          }
          if (day >= 3) {
            const adjBtn = document.createElement('button');
            adjBtn.textContent = t.adjectives;
            adjBtn.className = 'btn-secondary btn-small grammar-option-btn';
            adjBtn.onclick = makeToggleHandler(adjBtn);
            grammarOptionsContainer.appendChild(adjBtn);
            const pluralBtn = document.createElement('button');
            pluralBtn.textContent = t.plurals;
            pluralBtn.className = 'btn-secondary btn-small grammar-option-btn';
            pluralBtn.onclick = makeToggleHandler(pluralBtn);
            grammarOptionsContainer.appendChild(pluralBtn);
          }
          if (day >= 5) {
            const pastBtn = document.createElement('button');
            pastBtn.textContent = t.pastTense;
            pastBtn.className = 'btn-secondary btn-small grammar-option-btn';
            pastBtn.onclick = makeToggleHandler(pastBtn);
            grammarOptionsContainer.appendChild(pastBtn);
          }
          if (day >= 7) {
            const futureBtn = document.createElement('button');
            futureBtn.textContent = t.futureTense;
            futureBtn.className = 'btn-secondary btn-small grammar-option-btn';
            futureBtn.onclick = makeToggleHandler(futureBtn);
            grammarOptionsContainer.appendChild(futureBtn);
          }
        }
        
        // Update UI language on language change
        languageSelect.addEventListener('change', function() {
          const lang = languageSelect.value;
          // Remove any previous flag class
          document.body.className = document.body.className
            .split(' ')
            .filter(c => !c.startsWith('flag-'))
            .join(' ');
          if (lang) {
            document.body.classList.add('flag-' + lang);
          }
          updateUIForLanguage(lang);
        });
        
        // On page load, set UI to default language
        updateUIForLanguage(document.getElementById('language').value || 'COSYenglish');

        // Grammar practice function (gender/verbs)
        async function practiceGrammar(type) {
            const language = document.getElementById('language').value;
            const days = getSelectedDays();
            const resultArea = document.getElementById('result');
            if (!language) {
                alert('Please select a language first');
                return;
            }
            if (!days.length) {
                alert('Please select a day or a range of days first');
                return;
            }
            resultArea.style.display = 'block';
            const day = days[Math.floor(Math.random() * days.length)];
            if (type === 'gender') {
                const items = await loadGenderGrammar(language, day);
                if (!items.length) {
                    resultArea.innerHTML = `<p style="text-align:center;">No gender data for this day/language.</p>`;
                    return;
                }
                const item = items[Math.floor(Math.random() * items.length)];
                // Determine articles for the language
                let articles = [];
                switch(language) {
                    case 'COSYenglish': articles = ['he', 'she', 'it', "he/she"]; break;
                    case 'COSYfran√ßais': articles = ['le', 'la', "l'", 'le/la']; break;
                    case 'COSYitaliano': articles = ['il', 'la', 'lo', "l'"]; break;
                    case 'COSYespa√±ol': articles = ['el', 'la', 'el/la']; break;
                    case 'COSYdeutsch': articles = ['der', 'die', 'das']; break;
                    case 'COSYportugu√™s': articles = ['o', 'a', 'o/a']; break;
                    case '–¢–ê–ö–û–ô—Ä—É—Å—Å–∫–∏–π': articles = ['–æ–Ω', '–æ–Ω–∞', '–æ–Ω–æ']; break;
                    case 'COSYenglish': articles = ['he', 'she', 'it', 'he/she']; break;
                    case 'COSYbrezhoneg': articles = ['ar', 'an']; break;
                    case 'COSYtatar√ßa': articles = ['–∏—Ä-–∞—Ç', '—Ö–∞—Ç—ã–Ω-–∫—ã–∑', '”ô–π–±–µ—Ä']; break;
                    case 'COSYbashkort': articles = ['–∏—Ä-–∞—Ç', '“°–∞—Ç—ã–Ω-“°—ã“ô', '”ô–π–±–µ—Ä']; break;
                    case '‘æ’à’ç’Ö’∞’°’µ’Ø’°’Ø’°’∂': articles = ['’°÷Ä’°’Ø’°’∂', '’´’£’°’Ø’°’∂', '’¥’´’ª’´’∂']; break;
                    case 'ŒöŒüŒñŒ•ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨': articles = ['Œø', 'Œ∑', 'œÑŒø', 'o/h']; break;
                    default: articles = ['the', 'a', 'an']; break;
                }
                // Build visually appealing article buttons
                let articleOptions = articles.map((art, idx) =>
                    `<button type='button' class='article-btn${idx===0 ? " selected" : ""}' data-article='${art}'>${art}</button>`
                ).join('');
                resultArea.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:160px;">
                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:18px;">
                            <span id="gender-word" style="font-size:2rem; font-weight:600;">${item.word}</span>
                            <button id="play-gender-pronounce-btn" class="btn-secondary" title="Hear pronunciation" style="font-size:1.5rem;">üîä</button>
                        </div>
                        <div id="article-options" style="margin-bottom:18px; display:flex; flex-wrap:wrap; justify-content:center; gap:8px;">${articleOptions}</div>
                        <button id="check-gender-btn" class="btn-secondary" style="min-width:120px; margin-bottom:10px;">Check</button>
                        <div id="gender-feedback" style="margin-top:14px;"></div>
                    </div>
                `;
                // Automatic pronunciation
                pronounceWord(item.word, language);
                setTimeout(() => {
                    document.getElementById('play-gender-pronounce-btn').onclick = function() {
                        pronounceWord(item.word, language);
                    };
                    // Replace article button logic in gender practice:
                    let selectedArticle = articles[0];
                    const articleBtns = document.querySelectorAll('#article-options .article-btn');
                    articleBtns.forEach(btn => {
                        btn.addEventListener('click', function() {
                            articleBtns.forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');
                            selectedArticle = btn.getAttribute('data-article');
                            // Immediately check answer when an article is clicked
                            let correct = false;
                            if (Array.isArray(item.article)) {
                                correct = item.article.includes(selectedArticle);
                            } else {
                                correct = selectedArticle && (selectedArticle === item.article);
                            }
                            let feedback = '';
                            if (!selectedArticle) {
                                feedback = '<span style="color:#e67e22;">Please select an article.</span>';
                            } else if (correct) {
                                feedback = '<span style="color:#27ae60;">‚úÖ Correct!</span>';
                                setTimeout(() => practiceGrammar(type), 1200);
                            } else {
                                feedback = `<span style=\"color:#e74c3c;\">‚ùå Not quite. The correct article is: <b>${Array.isArray(item.article) ? item.article.join(', ') : item.article}</b></span>`;
                            }
                            document.getElementById('gender-feedback').innerHTML = feedback;
                        });
                    });
                    document.getElementById('check-gender-btn').onclick = function() {
                        let correct = false;
                        if (Array.isArray(item.article)) {
                            correct = item.article.includes(selectedArticle);
                        } else {
                            correct = selectedArticle && (selectedArticle === item.article);
                        }
                        let feedback = '';
                        if (!selectedArticle) {
                            feedback = '<span style="color:#e67e22;">Please select an article.</span>';
                        } else if (correct) {
                            feedback = '<span style="color:#27ae60;">‚úÖ Correct!</span>';
                            setTimeout(() => practiceGrammar(type), 1200);
                        } else {
                            feedback = `<span style=\"color:#e74c3c;\">‚ùå Not quite. The correct article is: <b>${Array.isArray(item.article) ? item.article.join(', ') : item.article}</b></span>`;
                        }
                        document.getElementById('gender-feedback').innerHTML = feedback;
                    };
                }, 0);
                return;
            } else if (type === 'verbs') {
                const items = await loadVerbGrammar(language, day);
                if (!items.length) {
                    resultArea.innerHTML = `<p style="text-align:center;">No verb data for this day/language.</p>`;
                    return;
                }
                const item = items[Math.floor(Math.random() * items.length)];
                // UI: show prompt with listen button, ask for answer
                let verbPrompt = '';
                if (parseInt(day) === 2) {
                    verbPrompt = `<div style=\"font-size:1.2rem; font-weight:500; color:#00bdbd; margin-bottom:8px;\">${(translations[language]||translations['COSYenglish']).verbDay2}</div>`;
                } else if (parseInt(day) === 3) {
                    verbPrompt = `<div style=\"font-size:1.2rem; font-weight:500; color:#00bdbd; margin-bottom:8px;\">${(translations[language]||translations['COSYenglish']).verbDay3}</div>`;
                }
                resultArea.innerHTML = `
                    ${verbPrompt}
                    <div style=\"display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:160px;\">
                        <div style=\"display:flex; align-items:center; gap:12px; margin-bottom:18px;\">
                            <span id=\"verb-prompt\" style=\"font-size:2rem; font-weight:600;\">${item.prompt}</span>
                            <button id=\"play-verb-pronounce-btn\" class=\"btn-secondary\" title=\"Hear pronunciation\" style=\"font-size:1.5rem;\">üîä</button>
                        </div>
                        <input id=\"verb-answer-input\" type=\"text\" placeholder=\"Type the answer...\" style=\"font-size:1.1rem; padding:8px 14px; border-radius:8px; border:1px solid #bbb; margin-bottom:14px; width:220px; text-align:center;\">
                        <button id=\"check-verb-answer-btn\" class=\"btn-secondary\" style=\"margin-bottom:18px; min-width:120px;\">Check</button>
                        <div id=\"verb-answer-feedback\" style=\"margin-top:10px;\"></div>
                    </div>
                `;
                // Automatic pronunciation
                pronounceWord(item.prompt, language);
                setTimeout(() => {
                    document.getElementById('play-verb-pronounce-btn').onclick = function() {
                        pronounceWord(item.prompt, language);
                    };
                    document.getElementById('check-verb-answer-btn').onclick = function() {
                        const userInput = document.getElementById('verb-answer-input').value.trim().toLowerCase();
                        const correct = item.answer.trim().toLowerCase();
                        let feedback = '';
                        if (!userInput) {
                            feedback = '<span style="color:#e67e22;">Please type your answer above.</span>';
                        } else if (userInput === correct) {
                            feedback = '<span style="color:#27ae60;">‚úÖ Correct!</span>';
                            setTimeout(() => practiceGrammar(type), 1200);
                        } else if (userInput && correct && (userInput.includes(correct) || correct.includes(userInput))) {
                            feedback = '<span style="color:#f1c40f;">üü° Almost! Check your spelling.</span>';
                        } else {
                            feedback = `<span style=\"color:#e74c3c;\">‚ùå Not quite. The correct answer is: <b>${item.answer}</b></span>`;
                        }
                        document.getElementById('verb-answer-feedback').innerHTML = feedback;
                    };
                    // Add Enter key support for verb answer
                    addEnterKeySupport('verb-answer-input', 'check-verb-answer-btn');
                }, 0);
                return;
            }
        }

        // Helper: get selected days (single or range)
        function getSelectedDays() {
            const day = document.getElementById('day').value;
            const dayFrom = document.getElementById('day-from').value;
            const dayTo = document.getElementById('day-to').value;
            if (day) {
                return [day];
            } else if (dayFrom && dayTo && Number(dayFrom) <= Number(dayTo)) {
                const from = Number(dayFrom);
                const to = Number(dayTo);
                const days = [];
                for (let i = from; i <= to; i++) days.push(String(i));
                return days;
            } else {
                return [];
            }
        }

        // --- Remember language and day selection using localStorage ---
        function saveUserSelection() {
            localStorage.setItem('cosy_language', document.getElementById('language').value);
            localStorage.setItem('cosy_day', document.getElementById('day').value);
        }
        function restoreUserSelection() {
            const savedLang = localStorage.getItem('cosy_language');
            const savedDay = localStorage.getItem('cosy_day');
            if (savedLang) {
                document.getElementById('language').value = savedLang;
                // Trigger change event to update UI/flag
                document.getElementById('language').dispatchEvent(new Event('change'));
               }
            if (savedDay) {
                document.getElementById('day').value = savedDay;


                // Optionally trigger change event if needed
                document.getElementById('day').dispatchEvent(new Event('change'));
            }
        }
        // Attach save on change
        if (document.getElementById('language')) {
            document.getElementById('language').addEventListener('change', saveUserSelection);
        }
        if (document.getElementById('day')) {
            document.getElementById('day').addEventListener('change', saveUserSelection);
        }
        // Restore on page load
        window.addEventListener('DOMContentLoaded', restoreUserSelection);

        function updateUIForLanguage(lang) {
          const t = translations[lang] || translations['COSYenglish'];
          document.querySelector('h1').textContent = 'COSYlanguages';
          document.querySelector('label[for="language"]').textContent = t.chooseLanguage;
          document.querySelector('label[for="day"]').textContent = t.chooseDay;
          document.querySelector('label[for="day-from"]').textContent = t.dayFrom + ':';
          document.querySelector('label[for="day-to"]').textContent = t.dayTo + ':';
          document.querySelector('.menu-section label[for="language"]').textContent = t.chooseLanguage;
          document.querySelector('.menu-section label[for="day"]').textContent = t.chooseDay;
          document.querySelector('.menu-section label[for="day-from"]').textContent = t.dayFrom + ':';
          document.querySelector('.menu-section label[for="day-to"]').textContent = t.dayTo + ':';
          document.querySelector('.menu-section label:not([for])').textContent = t.selectPractice;
          document.getElementById('vocabulary-btn').textContent = t.vocabulary;
          document.getElementById('grammar-btn').textContent = t.grammar;
          document.getElementById('speaking-btn').textContent = t.speaking;
          document.getElementById('random-word-btn').textContent = t.randomWord;
          document.getElementById('random-image-btn').textContent = t.randomImage;
          document.getElementById('speaking-practice-btn').textContent = t.getPrompt;
          document.getElementById('practice-all-btn').textContent = t.practiceAll;
          // Update grammar options if visible
          if (document.getElementById('grammar-options').style.display === 'block') updateGrammarOptions();
        }

        // Restore all main practice type buttons when returning to menu
        function restoreMenu() {
            showAllMainPracticeTypes();
            showAllVocabularyOptions();
            showAllGrammarOptions();
            vocabularyOptions.style.display = 'none';
            grammarOptions.style.display = 'none';
            speakingOptions.style.display = 'none';
            practiceAllBtn.style.display = 'block';
            // Optionally clear result area
            document.getElementById('result').innerHTML = '';
        }
        // Remove double-click restoreMenu listeners (no longer needed)
        // vocabularyBtn.addEventListener('dblclick', restoreMenu);
        // grammarBtn.addEventListener('dblclick', restoreMenu);
        // speakingBtn.addEventListener('dblclick', restoreMenu);

        // --- Hide/show day and day-from/day-to options depending on selection ---
function updateDaySelectors() {
    const day = daySelect.value;
    const dayFrom = dayFromSelect.value;
    const dayTo = dayToSelect.value;
    if (day) {
        // Hide range selectors
        dayFromSelect.parentElement.style.display = 'none';
        dayToSelect.parentElement.style.display = 'none';
    } else if (dayFrom || dayTo) {
        // Hide single day selector
        daySelect.style.display = 'none';
        dayFromSelect.parentElement.style.display = '';
        dayToSelect.parentElement.style.display = '';
    } else {
        // Show all
        daySelect.style.display = '';
        dayFromSelect.parentElement.style.display = '';
        dayToSelect.parentElement.style.display = '';
    }
}

daySelect.addEventListener('change', updateDaySelectors);
dayFromSelect.addEventListener('change', updateDaySelectors);
dayToSelect.addEventListener('change', updateDaySelectors);

// --- Toggle logic for secondary practice options (Random Word, Random Image, Listening) ---
function hideOtherVocabularyModes(selectedId) {
    ['random-word-btn', 'random-image-btn', 'listening-btn'].forEach(id => {
        if (id !== selectedId) {
            document.getElementById(id).style.display = 'none';
        } else {
            document.getElementById(id).classList.add('active-vocab-btn');
        }
    });
}
function showAllVocabularyModes() {
    ['random-word-btn', 'random-image-btn', 'listening-btn'].forEach(id => {
        document.getElementById(id).style.display = 'inline-block';
        document.getElementById(id).classList.remove('active-vocab-btn');
    });
}
function toggleVocabularyMode(selectedId) {
    const btn = document.getElementById(selectedId);
    const isActive = btn.classList.contains('active-vocab-btn');
    if (isActive) {
        showAllVocabularyModes();
        document.getElementById('result').innerHTML = '';
    } else {
        hideOtherVocabularyModes(selectedId);
        document.getElementById('result').innerHTML = '';
        // Optionally, you could trigger the practice function here if you want auto-start
    }
}

document.getElementById('random-word-btn').addEventListener('click', function() {
    toggleVocabularyMode('random-word-btn');
});
document.getElementById('random-image-btn').addEventListener('click', function() {
    toggleVocabularyMode('random-image-btn');
});
document.getElementById('listening-btn').addEventListener('click', function() {
    toggleVocabularyMode('listening-btn');
});
    </script>
    <!-- Sound effects -->
    <audio id="click-sound" src="sounds/click.mp3" preload="auto"></audio>
    <audio id="select-sound" src="sounds/select.mp3" preload="auto"></audio>
    <audio id="error-sound" src="sounds/error.mp3" preload="auto"></audio>
    <audio id="success-sound" src="sounds/success.mp3" preload="auto"></audio>
    <script src="interactive.js"></script>
</body>
</html>